import{_registerComponent as t,registerVersion as e,_getProvider as n,getApp as r,_removeServiceInstance as s,SDK_VERSION as i}from"https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";const o=function(t){const e=[];let n=0;for(let r=0;r<t.length;r++){let s=t.charCodeAt(r);s<128?e[n++]=s:s<2048?(e[n++]=s>>6|192,e[n++]=63&s|128):55296==(64512&s)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(s=65536+((1023&s)<<10)+(1023&t.charCodeAt(++r)),e[n++]=s>>18|240,e[n++]=s>>12&63|128,e[n++]=s>>6&63|128,e[n++]=63&s|128):(e[n++]=s>>12|224,e[n++]=s>>6&63|128,e[n++]=63&s|128)}return e},a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let e=0;e<t.length;e+=3){const s=t[e],i=e+1<t.length,o=i?t[e+1]:0,a=e+2<t.length,c=a?t[e+2]:0,u=s>>2,l=(3&s)<<4|o>>4;let h=(15&o)<<2|c>>6,d=63&c;a||(d=64,i||(h=64)),r.push(n[u],n[l],n[h],n[d])}return r.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(o(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,r=0;for(;n<t.length;){const s=t[n++];if(s<128)e[r++]=String.fromCharCode(s);else if(s>191&&s<224){const i=t[n++];e[r++]=String.fromCharCode((31&s)<<6|63&i)}else if(s>239&&s<365){const i=((7&s)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536;e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))}else{const i=t[n++],o=t[n++];e[r++]=String.fromCharCode((15&s)<<12|(63&i)<<6|63&o)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let e=0;e<t.length;){const s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0;++e;const o=e<t.length?n[t.charAt(e)]:64;++e;const a=e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==o||null==a)throw new c;const u=s<<2|i>>4;if(r.push(u),64!==o){const t=i<<4&240|o>>2;if(r.push(t),64!==a){const t=o<<6&192|a;r.push(t)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const u=function(t){return function(t){const e=o(t);return a.encodeByteArray(e,!0)}(t).replace(/\./g,"")};const l=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,h=()=>{if("undefined"==typeof document)return;let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(t){return}const e=t&&function(t){try{return a.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null}(t[1]);return e&&JSON.parse(e)},d=()=>{try{return l()||(()=>{if("undefined"==typeof process||void 0===process.env)return;const t=process.env.__FIREBASE_DEFAULTS__;return t?JSON.parse(t):void 0})()||h()}catch(t){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${t}`)}},f=t=>{const e=(t=>{var e,n;return null===(n=null===(e=d())||void 0===e?void 0:e.emulatorHosts)||void 0===n?void 0:n[t]})(t);if(!e)return;const n=e.lastIndexOf(":");if(n<=0||n+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const r=parseInt(e.substring(n+1),10);return"["===e[0]?[e.substring(1,n-1),r]:[e.substring(0,n),r]};function m(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function g(){return!function(){var t;const e=null===(t=d())||void 0===t?void 0:t.forceEnvironment;if("node"===e)return!0;if("browser"===e)return!1;try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class p extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,p.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,y.prototype.create)}}class y{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){const n=e[0]||{},r=`${this.service}/${t}`,s=this.errors[t],i=s?function(t,e){return t.replace(w,((t,n)=>{const r=e[n];return null!=r?String(r):`<${n}?>`}))}(s,n):"Error",o=`${this.serviceName}: ${i} (${r}).`;return new p(r,o,n)}}const w=/\{\$([^}]+)}/g;function v(t,e){if(t===e)return!0;const n=Object.keys(t),r=Object.keys(e);for(const s of n){if(!r.includes(s))return!1;const n=t[s],i=e[s];if(I(n)&&I(i)){if(!v(n,i))return!1}else if(n!==i)return!1}for(const t of r)if(!n.includes(t))return!1;return!0}function I(t){return null!==t&&"object"==typeof t}function b(t){return t&&t._delegate?t._delegate:t}class E{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}var T;!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(T||(T={}));const S={debug:T.DEBUG,verbose:T.VERBOSE,info:T.INFO,warn:T.WARN,error:T.ERROR,silent:T.SILENT},_=T.INFO,D={[T.DEBUG]:"log",[T.VERBOSE]:"log",[T.INFO]:"info",[T.WARN]:"warn",[T.ERROR]:"error"},x=(t,e,...n)=>{if(e<t.logLevel)return;const r=(new Date).toISOString(),s=D[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)};var A,C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},N=N||{},k=C||self;function R(){}function M(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function L(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var O="closure_uid_"+(1e9*Math.random()>>>0),F=0;function P(t,e,n){return t.call.apply(t.bind,arguments)}function V(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function B(t,e,n){return(B=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?P:V).apply(null,arguments)}function q(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function U(t,e){function n(){}n.prototype=e.prototype,t.X=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Wb=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function G(){this.s=this.s,this.o=this.o}G.prototype.s=!1,G.prototype.na=function(){var t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,Object.prototype.hasOwnProperty.call(t,O)&&t[O]||(t[O]=++F))},G.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const z=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function j(t){const e=t.length;if(0<e){const n=Array(e);for(let r=0;r<e;r++)n[r]=t[r];return n}return[]}function K(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(M(n)){const e=t.length||0,r=n.length||0;t.length=e+r;for(let s=0;s<r;s++)t[e+s]=n[s]}else t.push(n)}}function $(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}$.prototype.h=function(){this.defaultPrevented=!0};var Q=function(){if(!k.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{k.addEventListener("test",R,e),k.removeEventListener("test",R,e)}catch(t){}return t}();function H(t){return/^[\s\xa0]*$/.test(t)}var W=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function Y(t,e){return t<e?-1:t>e?1:0}function X(){var t=k.navigator;return t&&(t=t.userAgent)?t:""}function J(t){return-1!=X().indexOf(t)}function Z(t){return Z[" "](t),t}Z[" "]=R;var tt,et,nt=J("Opera"),rt=J("Trident")||J("MSIE"),st=J("Edge"),it=st||rt,ot=J("Gecko")&&!(-1!=X().toLowerCase().indexOf("webkit")&&!J("Edge"))&&!(J("Trident")||J("MSIE"))&&!J("Edge"),at=-1!=X().toLowerCase().indexOf("webkit")&&!J("Edge");function ct(){var t=k.document;return t?t.documentMode:void 0}t:{var ut="",lt=(et=X(),ot?/rv:([^\);]+)(\)|;)/.exec(et):st?/Edge\/([\d\.]+)/.exec(et):rt?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(et):at?/WebKit\/(\S+)/.exec(et):nt?/(?:Version)[ \/]?(\S+)/.exec(et):void 0);if(lt&&(ut=lt?lt[1]:""),rt){var ht=ct();if(null!=ht&&ht>parseFloat(ut)){tt=String(ht);break t}}tt=ut}var dt,ft={};function mt(){return function(t){var e=ft;return Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9)}((function(){let t=0;const e=W(String(tt)).split("."),n=W("9").split("."),r=Math.max(e.length,n.length);for(let o=0;0==t&&o<r;o++){var s=e[o]||"",i=n[o]||"";do{if(s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==s[0].length&&0==i[0].length)break;t=Y(0==s[1].length?0:parseInt(s[1],10),0==i[1].length?0:parseInt(i[1],10))||Y(0==s[2].length,0==i[2].length)||Y(s[2],i[2]),s=s[3],i=i[3]}while(0==t)}return 0<=t}))}if(k.document&&rt){var gt=ct();dt=gt||(parseInt(tt,10)||void 0)}else dt=void 0;var pt=dt;function yt(t,e){if($.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(ot){t:{try{Z(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:wt[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&yt.X.h.call(this)}}U(yt,$);var wt={2:"touch",3:"pen",4:"mouse"};yt.prototype.h=function(){yt.X.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var vt="closure_listenable_"+(1e6*Math.random()|0),It=0;function bt(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ha=s,this.key=++It,this.ba=this.ea=!1}function Et(t){t.ba=!0,t.listener=null,t.proxy=null,t.src=null,t.ha=null}function Tt(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function St(t){const e={};for(const n in t)e[n]=t[n];return e}const _t="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Dt(t,e){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e],r)t[n]=r[n];for(let e=0;e<_t.length;e++)n=_t[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function xt(t){this.src=t,this.g={},this.h=0}function At(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=z(s,e);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(Et(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function Ct(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ba&&i.listener==e&&i.capture==!!n&&i.ha==r)return s}return-1}xt.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=Ct(t,e,r,s);return-1<o?(e=t[o],n||(e.ea=!1)):((e=new bt(e,this.src,i,!!r,s)).ea=n,t.push(e)),e};var Nt="closure_lm_"+(1e6*Math.random()|0),kt={};function Rt(t,e,n,r,s){if(r&&r.once)return Lt(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)Rt(t,e[i],n,r,s);return null}return n=Ut(n),t&&t[vt]?t.N(e,n,L(r)?!!r.capture:!!r,s):Mt(t,e,n,!1,r,s)}function Mt(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=L(s)?!!s.capture:!!s,a=Bt(t);if(a||(t[Nt]=a=new xt(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=function(){function t(n){return e.call(t.src,t.listener,n)}const e=Vt;return t}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)Q||(s=o),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(Pt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function Lt(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)Lt(t,e[i],n,r,s);return null}return n=Ut(n),t&&t[vt]?t.O(e,n,L(r)?!!r.capture:!!r,s):Mt(t,e,n,!0,r,s)}function Ot(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)Ot(t,e[i],n,r,s);else r=L(r)?!!r.capture:!!r,n=Ut(n),t&&t[vt]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=Ct(i=t.g[e],n,r,s))&&(Et(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=Bt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=Ct(e,n,r,s)),(n=-1<t?e[t]:null)&&Ft(n))}function Ft(t){if("number"!=typeof t&&t&&!t.ba){var e=t.src;if(e&&e[vt])At(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Pt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Bt(e))?(At(n,t),0==n.h&&(n.src=null,e[Nt]=null)):Et(t)}}}function Pt(t){return t in kt?kt[t]:kt[t]="on"+t}function Vt(t,e){if(t.ba)t=!0;else{e=new yt(e,this);var n=t.listener,r=t.ha||t.src;t.ea&&Ft(t),t=n.call(r,e)}return t}function Bt(t){return(t=t[Nt])instanceof xt?t:null}var qt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ut(t){return"function"==typeof t?t:(t[qt]||(t[qt]=function(e){return t.handleEvent(e)}),t[qt])}function Gt(){G.call(this),this.i=new xt(this),this.P=this,this.I=null}function zt(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e)e=new $(e,t);else if(e instanceof $)e.target=e.target||t;else{var s=e;Dt(e=new $(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=jt(o,r,!0,e)&&s}if(s=jt(o=e.g=t,r,!0,e)&&s,s=jt(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=jt(o=e.g=n[i],r,!1,e)&&s}function jt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ba&&o.capture==n){var a=o.listener,c=o.ha||o.src;o.ea&&At(t.i,o),s=!1!==a.call(c,r)&&s}}return s&&!r.defaultPrevented}U(Gt,G),Gt.prototype[vt]=!0,Gt.prototype.removeEventListener=function(t,e,n,r){Ot(this,t,e,n,r)},Gt.prototype.M=function(){if(Gt.X.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)Et(n[r]);delete e.g[t],e.h--}}this.I=null},Gt.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},Gt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var Kt=k.JSON.stringify;function $t(){var t=Zt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Qt,Ht=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Wt),(t=>t.reset()));class Wt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Yt(t){k.setTimeout((()=>{throw t}),0)}function Xt(t,e){Qt||function(){var t=k.Promise.resolve(void 0);Qt=function(){t.then(te)}}(),Jt||(Qt(),Jt=!0),Zt.add(t,e)}var Jt=!1,Zt=new class{constructor(){this.h=this.g=null}add(t,e){const n=Ht.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function te(){for(var t;t=$t();){try{t.h.call(t.g)}catch(t){Yt(t)}var e=Ht;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Jt=!1}function ee(t,e){Gt.call(this),this.h=t||1,this.g=e||k,this.j=B(this.lb,this),this.l=Date.now()}function ne(t){t.ca=!1,t.R&&(t.g.clearTimeout(t.R),t.R=null)}function re(t,e,n){if("function"==typeof t)n&&(t=B(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=B(t.handleEvent,t)}return 2147483647<Number(e)?-1:k.setTimeout(t,e||0)}function se(t){t.g=re((()=>{t.g=null,t.i&&(t.i=!1,se(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}U(ee,Gt),(A=ee.prototype).ca=!1,A.R=null,A.lb=function(){if(this.ca){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-t):(this.R&&(this.g.clearTimeout(this.R),this.R=null),zt(this,"tick"),this.ca&&(ne(this),this.start()))}},A.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},A.M=function(){ee.X.M.call(this),ne(this),delete this.g};class ie extends G{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:se(this)}M(){super.M(),this.g&&(k.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function oe(t){G.call(this),this.h=t,this.g={}}U(oe,G);var ae=[];function ce(t,e,n,r){Array.isArray(n)||(n&&(ae[0]=n.toString()),n=ae);for(var s=0;s<n.length;s++){var i=Rt(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function ue(t){Tt(t.g,(function(t,e){this.g.hasOwnProperty(e)&&Ft(t)}),t),t.g={}}function le(){this.g=!0}function he(t,e,n,r){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Kt(n)}catch(t){return e}}(t,n)+(r?" "+r:"")}))}oe.prototype.M=function(){oe.X.M.call(this),ue(this)},oe.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},le.prototype.Aa=function(){this.g=!1},le.prototype.info=function(){};var de={},fe=null;function me(){return fe=fe||new Gt}function ge(t){$.call(this,de.Pa,t)}function pe(t){const e=me();zt(e,new ge(e))}function ye(t,e){$.call(this,de.STAT_EVENT,t),this.stat=e}function we(t){const e=me();zt(e,new ye(e,t))}function ve(t,e){$.call(this,de.Qa,t),this.size=e}function Ie(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return k.setTimeout((function(){t()}),e)}de.Pa="serverreachability",U(ge,$),de.STAT_EVENT="statevent",U(ye,$),de.Qa="timingevent",U(ve,$);var be={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},Ee={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function Te(){}function Se(t){return t.h||(t.h=t.i())}function _e(){}Te.prototype.h=null;var De,xe={OPEN:"a",qb:"b",Na:"c",Cb:"d"};function Ae(){$.call(this,"d")}function Ce(){$.call(this,"c")}function Ne(){}function ke(t,e,n,r){this.l=t,this.j=e,this.m=n,this.U=r||1,this.S=new oe(this),this.O=Me,t=it?125:void 0,this.T=new ee(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new Re}function Re(){this.i=null,this.g="",this.h=!1}U(Ae,$),U(Ce,$),U(Ne,Te),Ne.prototype.g=function(){return new XMLHttpRequest},Ne.prototype.i=function(){return{}},De=new Ne;var Me=45e3,Le={},Oe={};function Fe(t,e,n){t.K=1,t.v=en(Ye(e)),t.s=n,t.P=!0,Pe(t,null)}function Pe(t,e){t.F=Date.now(),Ue(t),t.A=Ye(t.v);var n=t.A,r=t.U;Array.isArray(r)||(r=[String(r)]),gn(n.i,"t",r),t.C=0,n=t.l.H,t.h=new Re,t.g=mr(t.l,n?e:null,!t.s),0<t.N&&(t.L=new ie(B(t.La,t,t.g),t.N)),ce(t.S,t.g,"readystatechange",t.ib),e=t.H?St(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.da(t.A,t.u,t.s,e)):(t.u="GET",t.g.da(t.A,t.u,null,e)),pe(),function(t,e,n,r,s,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var l=u[0];u=u[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+u+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.U,t.s)}function Ve(t){return!!t.g&&("GET"==t.u&&2!=t.K&&t.l.Da)}function Be(t,e,n){let r,s=!0;for(;!t.I&&t.C<n.length;){if(r=qe(t,n),r==Oe){4==e&&(t.o=4,we(14),s=!1),he(t.j,t.m,null,"[Incomplete Response]");break}if(r==Le){t.o=4,we(15),he(t.j,t.m,n,"[Invalid Chunk]"),s=!1;break}he(t.j,t.m,r,null),$e(t,r)}Ve(t)&&r!=Oe&&r!=Le&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,we(16),s=!1),t.i=t.i&&s,s?0<n.length&&!t.$&&(t.$=!0,(e=t.l).g==t&&e.$&&!e.K&&(e.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),or(e),e.K=!0,we(11))):(he(t.j,t.m,n,"[Invalid Chunked Response]"),Ke(t),je(t))}function qe(t,e){var n=t.C,r=e.indexOf("\n",n);return-1==r?Oe:(n=Number(e.substring(n,r)),isNaN(n)?Le:(r+=1)+n>e.length?Oe:(e=e.substr(r,n),t.C=r+n,e))}function Ue(t){t.V=Date.now()+t.O,Ge(t,t.O)}function Ge(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=Ie(B(t.gb,t),e)}function ze(t){t.B&&(k.clearTimeout(t.B),t.B=null)}function je(t){0==t.l.G||t.I||ur(t.l,t)}function Ke(t){ze(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,ne(t.T),ue(t.S),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function $e(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||bn(n.h,t)))if(!t.J&&bn(n.h,t)&&3==n.G){try{var r=n.Fa.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;cr(n),Jn(n)}ir(n),we(18)}}else n.Ba=s[1],0<n.Ba-n.T&&37500>s[2]&&n.L&&0==n.A&&!n.v&&(n.v=Ie(B(n.cb,n),6e3));if(1>=In(n.h)&&n.ja){try{n.ja()}catch(t){}n.ja=void 0}}else hr(n,11)}else if((t.J||n.g==t)&&cr(n),!H(e))for(s=n.Fa.g.parse(e),e=0;e<s.length;e++){let u=s[e];if(n.T=u[0],u=u[1],2==n.G)if("c"==u[0]){n.I=u[1],n.ka=u[2];const e=u[3];null!=e&&(n.ma=e,n.j.info("VER="+n.ma));const s=u[4];null!=s&&(n.Ca=s,n.j.info("SVER="+n.Ca));const l=u[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=r.h;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(En(i,i.h),i.h=null))}if(r.D){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(r.za=t,tn(r.F,r.D,t))}}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-t.F,n.j.info("Handshake RTT: "+n.P+"ms"));var o=t;if((r=n).sa=fr(r,r.H?r.ka:null,r.V),o.J){Tn(r.h,o);var a=o,c=r.J;c&&a.setTimeout(c),a.B&&(ze(a),Ue(a)),r.g=o}else sr(r);0<n.i.length&&tr(n)}else"stop"!=u[0]&&"close"!=u[0]||hr(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?hr(n,7):Xn(n):"noop"!=u[0]&&n.l&&n.l.wa(u),n.A=0)}pe()}catch(t){}}function Qe(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(M(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.oa&&"function"==typeof t.oa)return t.oa();if(!t.W||"function"!=typeof t.W){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(M(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const r in t)e[n++]=r;return e}}}(t),r=function(t){if(t.W&&"function"==typeof t.W)return t.W();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(M(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t),s=r.length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}(A=ke.prototype).setTimeout=function(t){this.O=t},A.ib=function(t){t=t.target;const e=this.L;e&&3==Kn(t)?e.l():this.La(t)},A.La=function(t){try{if(t==this.g)t:{const l=Kn(this.g);var e=this.g.Ea();this.g.aa();if(!(3>l)&&(3!=l||it||this.g&&(this.h.h||this.g.fa()||$n(this.g)))){this.I||4!=l||7==e||pe(),ze(this);var n=this.g.aa();this.Y=n;e:if(Ve(this)){var r=$n(this.g);t="";var s=r.length,i=4==Kn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ke(this),je(this);var o="";break e}this.h.i=new k.TextDecoder}for(e=0;e<s;e++)this.h.h=!0,t+=this.h.i.decode(r[e],{stream:i&&e==s-1});r.splice(0,s),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==n,function(t,e,n,r,s,i,o){t.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.U,l,n),this.i){if(this.Z&&!this.J){e:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!H(a)){var u=a;break e}}u=null}if(!(n=u)){this.i=!1,this.o=3,we(12),Ke(this),je(this);break t}he(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,$e(this,n)}this.P?(Be(this,l,o),it&&this.i&&3==l&&(ce(this.S,this.T,"tick",this.hb),this.T.start())):(he(this.j,this.m,o,null),$e(this,o)),4==l&&Ke(this),this.i&&!this.I&&(4==l?ur(this.l,this):(this.i=!1,Ue(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,we(12)):(this.o=0,we(13)),Ke(this),je(this)}}}catch(t){}},A.hb=function(){if(this.g){var t=Kn(this.g),e=this.g.fa();this.C<e.length&&(ze(this),Be(this,t,e),this.i&&4!=t&&Ue(this))}},A.cancel=function(){this.I=!0,Ke(this)},A.gb=function(){this.B=null;const t=Date.now();0<=t-this.V?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(pe(),we(17)),Ke(this),this.o=2,je(this)):Ge(this,this.V-t)};var He=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function We(t,e){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof We){this.h=void 0!==e?e:t.h,Xe(this,t.j),this.s=t.s,this.g=t.g,Je(this,t.m),this.l=t.l,e=t.i;var n=new hn;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),Ze(this,n),this.o=t.o}else t&&(n=String(t).match(He))?(this.h=!!e,Xe(this,n[1]||"",!0),this.s=nn(n[2]||""),this.g=nn(n[3]||"",!0),Je(this,n[4]),this.l=nn(n[5]||"",!0),Ze(this,n[6]||"",!0),this.o=nn(n[7]||"")):(this.h=!!e,this.i=new hn(null,this.h))}function Ye(t){return new We(t)}function Xe(t,e,n){t.j=n?nn(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Je(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Ze(t,e,n){e instanceof hn?(t.i=e,function(t,e){e&&!t.j&&(dn(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(fn(this,e),gn(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=rn(e,un)),t.i=new hn(e,t.h))}function tn(t,e,n){t.i.set(e,n)}function en(t){return tn(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function nn(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function rn(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,sn),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function sn(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}We.prototype.toString=function(){var t=[],e=this.j;e&&t.push(rn(e,on,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(rn(e,on,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(rn(n,"/"==n.charAt(0)?cn:an,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",rn(n,ln)),t.join("")};var on=/[#\/\?@]/g,an=/[#\?:]/g,cn=/[#\?]/g,un=/[#\?@]/g,ln=/#/g;function hn(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function dn(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function fn(t,e){dn(t),e=pn(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function mn(t,e){return dn(t),e=pn(t,e),t.g.has(e)}function gn(t,e,n){fn(t,e),0<n.length&&(t.i=null,t.g.set(pn(t,e),j(n)),t.h+=n.length)}function pn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(A=hn.prototype).add=function(t,e){dn(this),this.i=null,t=pn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},A.forEach=function(t,e){dn(this),this.g.forEach((function(n,r){n.forEach((function(n){t.call(e,n,r,this)}),this)}),this)},A.oa=function(){dn(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let r=0;r<e.length;r++){const s=t[r];for(let t=0;t<s.length;t++)n.push(e[r])}return n},A.W=function(t){dn(this);let e=[];if("string"==typeof t)mn(this,t)&&(e=e.concat(this.g.get(pn(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},A.set=function(t,e){return dn(this),this.i=null,mn(this,t=pn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},A.get=function(t,e){return t&&0<(t=this.W(t)).length?String(t[0]):e},A.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var r=e[n];const i=encodeURIComponent(String(r)),o=this.W(r);for(r=0;r<o.length;r++){var s=i;""!==o[r]&&(s+="="+encodeURIComponent(String(o[r]))),t.push(s)}}return this.i=t.join("&")};function yn(t){this.l=t||wn,k.PerformanceNavigationTiming?t=0<(t=k.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(k.g&&k.g.Ga&&k.g.Ga()&&k.g.Ga().$b),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var wn=10;function vn(t){return!!t.h||!!t.g&&t.g.size>=t.j}function In(t){return t.h?1:t.g?t.g.size:0}function bn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function En(t,e){t.g?t.g.add(e):t.h=e}function Tn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function Sn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return j(t.i)}function _n(){}function Dn(){this.g=new _n}function xn(t,e,n){const r=n||"";try{Qe(t,(function(t,n){let s=t;L(t)&&(s=Kt(t)),e.push(r+n+"="+encodeURIComponent(s))}))}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function An(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function Cn(t){this.l=t.ac||null,this.j=t.jb||!1}function Nn(t,e){Gt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=kn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}yn.prototype.cancel=function(){if(this.i=Sn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},_n.prototype.stringify=function(t){return k.JSON.stringify(t,void 0)},_n.prototype.parse=function(t){return k.JSON.parse(t,void 0)},U(Cn,Te),Cn.prototype.g=function(){return new Nn(this.l,this.j)},Cn.prototype.i=function(t){return function(){return t}}({}),U(Nn,Gt);var kn=0;function Rn(t){t.j.read().then(t.Ta.bind(t)).catch(t.ga.bind(t))}function Mn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,Ln(t)}function Ln(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(A=Nn.prototype).open=function(t,e){if(this.readyState!=kn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,Ln(this)},A.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||k).fetch(new Request(this.B,e)).then(this.Wa.bind(this),this.ga.bind(this))},A.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Mn(this)),this.readyState=kn},A.Wa=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,Ln(this)),this.g&&(this.readyState=3,Ln(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==k.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Rn(this)}else t.text().then(this.Va.bind(this),this.ga.bind(this))},A.Ta=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Mn(this):Ln(this),3==this.readyState&&Rn(this)}},A.Va=function(t){this.g&&(this.response=this.responseText=t,Mn(this))},A.Ua=function(t){this.g&&(this.response=t,Mn(this))},A.ga=function(){this.g&&Mn(this)},A.setRequestHeader=function(t,e){this.v.append(t,e)},A.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},A.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(Nn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var On=k.JSON.parse;function Fn(t){Gt.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Pn,this.K=this.L=!1}U(Fn,Gt);var Pn="",Vn=/^https?$/i,Bn=["POST","PUT"];function qn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Un(t),zn(t)}function Un(t){t.D||(t.D=!0,zt(t,"complete"),zt(t,"error"))}function Gn(t){if(t.h&&void 0!==N&&(!t.C[1]||4!=Kn(t)||2!=t.aa()))if(t.v&&4==Kn(t))re(t.Ha,0,t);else if(zt(t,"readystatechange"),4==Kn(t)){t.h=!1;try{const a=t.aa();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var r;if(r=0===a){var s=String(t.H).match(He)[1]||null;if(!s&&k.self&&k.self.location){var i=k.self.location.protocol;s=i.substr(0,i.length-1)}r=!Vn.test(s?s.toLowerCase():"")}n=r}if(n)zt(t,"complete"),zt(t,"success");else{t.m=6;try{var o=2<Kn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.aa()+"]",Un(t)}}finally{zn(t)}}}function zn(t,e){if(t.g){jn(t);const n=t.g,r=t.C[0]?R:null;t.g=null,t.C=null,e||zt(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function jn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(k.clearTimeout(t.A),t.A=null)}function Kn(t){return t.g?t.g.readyState:0}function $n(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Pn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Qn(t){let e="";return Tt(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function Hn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=Qn(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):tn(t,e,n))}function Wn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Yn(t){this.Ca=0,this.i=[],this.j=new le,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=Wn("failFast",!1,t),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=Wn("baseRetryDelayMs",5e3,t),this.bb=Wn("retryDelaySeedMs",1e4,t),this.$a=Wn("forwardChannelMaxRetries",2,t),this.ta=Wn("forwardChannelRequestTimeoutMs",2e4,t),this.ra=t&&t.xmlHttpFactory||void 0,this.Da=t&&t.Zb||!1,this.J=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.I="",this.h=new yn(t&&t.concurrentRequestLimit),this.Fa=new Dn,this.O=t&&t.fastHandshake||!1,this.N=t&&t.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=t&&t.Xb||!1,t&&t.Aa&&this.j.Aa(),t&&t.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&t&&t.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Xn(t){if(Zn(t),3==t.G){var e=t.U++,n=Ye(t.F);tn(n,"SID",t.I),tn(n,"RID",e),tn(n,"TYPE","terminate"),nr(t,n),(e=new ke(t,t.j,e,void 0)).K=2,e.v=en(Ye(n)),n=!1,k.navigator&&k.navigator.sendBeacon&&(n=k.navigator.sendBeacon(e.v.toString(),"")),!n&&k.Image&&((new Image).src=e.v,n=!0),n||(e.g=mr(e.l,null),e.g.da(e.v)),e.F=Date.now(),Ue(e)}dr(t)}function Jn(t){t.g&&(or(t),t.g.cancel(),t.g=null)}function Zn(t){Jn(t),t.u&&(k.clearTimeout(t.u),t.u=null),cr(t),t.h.cancel(),t.m&&("number"==typeof t.m&&k.clearTimeout(t.m),t.m=null)}function tr(t){vn(t.h)||t.m||(t.m=!0,Xt(t.Ja,t),t.C=0)}function er(t,e){var n;n=e?e.m:t.U++;const r=Ye(t.F);tn(r,"SID",t.I),tn(r,"RID",n),tn(r,"AID",t.T),nr(t,r),t.o&&t.s&&Hn(r,t.o,t.s),n=new ke(t,t.j,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.i=e.D.concat(t.i)),e=rr(t,n,1e3),n.setTimeout(Math.round(.5*t.ta)+Math.round(.5*t.ta*Math.random())),En(t.h,n),Fe(n,r,e)}function nr(t,e){t.ia&&Tt(t.ia,(function(t,n){tn(e,n,t)})),t.l&&Qe({},(function(t,n){tn(e,n,t)}))}function rr(t,e,n){n=Math.min(t.i.length,n);var r=t.l?B(t.l.Ra,t.l,t):null;t:{var s=t.i;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=s[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=s[o].h;const a=s[o].g;if(n-=e,0>n)e=Math.max(0,s[o].h-100),i=!1;else try{xn(a,t,"req"+n+"_")}catch(t){r&&r(a)}}if(i){r=t.join("&");break t}}}return t=t.i.splice(0,n),e.D=t,r}function sr(t){t.g||t.u||(t.Z=1,Xt(t.Ia,t),t.A=0)}function ir(t){return!(t.g||t.u||3<=t.A)&&(t.Z++,t.u=Ie(B(t.Ia,t),lr(t,t.A)),t.A++,!0)}function or(t){null!=t.B&&(k.clearTimeout(t.B),t.B=null)}function ar(t){t.g=new ke(t,t.j,"rpc",t.Z),null===t.o&&(t.g.H=t.s),t.g.N=0;var e=Ye(t.sa);tn(e,"RID","rpc"),tn(e,"SID",t.I),tn(e,"CI",t.L?"0":"1"),tn(e,"AID",t.T),tn(e,"TYPE","xmlhttp"),nr(t,e),t.o&&t.s&&Hn(e,t.o,t.s),t.J&&t.g.setTimeout(t.J);var n=t.g;t=t.ka,n.K=1,n.v=en(Ye(e)),n.s=null,n.P=!0,Pe(n,t)}function cr(t){null!=t.v&&(k.clearTimeout(t.v),t.v=null)}function ur(t,e){var n=null;if(t.g==e){cr(t),or(t),t.g=null;var r=2}else{if(!bn(t.h,e))return;n=e.D,Tn(t.h,e),r=1}if(0!=t.G)if(t.pa=e.Y,e.i)if(1==r){n=e.s?e.s.length:0,e=Date.now()-e.F;var s=t.C;zt(r=me(),new ve(r,n)),tr(t)}else sr(t);else if(3==(s=e.o)||0==s&&0<t.pa||!(1==r&&function(t,e){return!(In(t.h)>=t.h.j-(t.m?1:0)||(t.m?(t.i=e.D.concat(t.i),0):1==t.G||2==t.G||t.C>=(t.Za?0:t.$a)||(t.m=Ie(B(t.Ja,t,e),lr(t,t.C)),t.C++,0)))}(t,e)||2==r&&ir(t)))switch(n&&0<n.length&&(e=t.h,e.i=e.i.concat(n)),s){case 1:hr(t,5);break;case 4:hr(t,10);break;case 3:hr(t,6);break;default:hr(t,2)}}function lr(t,e){let n=t.Xa+Math.floor(Math.random()*t.bb);return t.l||(n*=2),n*e}function hr(t,e){if(t.j.info("Error code "+e),2==e){var n=null;t.l&&(n=null);var r=B(t.kb,t);n||(n=new We("//www.google.com/images/cleardot.gif"),k.location&&"http"==k.location.protocol||Xe(n,"https"),en(n)),function(t,e){const n=new le;if(k.Image){const r=new Image;r.onload=q(An,n,r,"TestLoadImage: loaded",!0,e),r.onerror=q(An,n,r,"TestLoadImage: error",!1,e),r.onabort=q(An,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=q(An,n,r,"TestLoadImage: timeout",!1,e),k.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(n.toString(),r)}else we(2);t.G=0,t.l&&t.l.va(e),dr(t),Zn(t)}function dr(t){if(t.G=0,t.la=[],t.l){const e=Sn(t.h);0==e.length&&0==t.i.length||(K(t.la,e),K(t.la,t.i),t.h.i.length=0,j(t.i),t.i.length=0),t.l.ua()}}function fr(t,e,n){var r=n instanceof We?Ye(n):new We(n,void 0);if(""!=r.g)e&&(r.g=e+"."+r.g),Je(r,r.m);else{var s=k.location;r=s.protocol,e=e?e+"."+s.hostname:s.hostname,s=+s.port;var i=new We(null,void 0);r&&Xe(i,r),e&&(i.g=e),s&&Je(i,s),n&&(i.l=n),r=i}return n=t.D,e=t.za,n&&e&&tn(r,n,e),tn(r,"VER",t.ma),nr(t,r),r}function mr(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Da&&!t.ra?new Fn(new Cn({jb:!0})):new Fn(t.ra)).Ka(t.H),e}function gr(){}function pr(){if(rt&&!(10<=Number(pt)))throw Error("Environmental error: no available transport.")}function yr(t,e){Gt.call(this),this.g=new Yn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.S=t,(t=e&&e.Yb)&&!H(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!H(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new Ir(this)}function wr(t){Ae.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function vr(){Ce.call(this),this.status=1}function Ir(t){this.g=t}(A=Fn.prototype).Ka=function(t){this.L=t},A.da=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():De.g(),this.C=this.u?Se(this.u):Se(De),this.g.onreadystatechange=B(this.Ha,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void qn(this,t)}if(t=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const t of r.keys())n.set(t,r.get(t))}r=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),s=k.FormData&&t instanceof k.FormData,!(0<=z(Bn,e))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{jn(this),0<this.B&&((this.K=function(t){return rt&&mt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=B(this.qa,this)):this.A=re(this.qa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){qn(this,t)}},A.qa=function(){void 0!==N&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,zt(this,"timeout"),this.abort(8))},A.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,zt(this,"complete"),zt(this,"abort"),zn(this))},A.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),zn(this,!0)),Fn.X.M.call(this)},A.Ha=function(){this.s||(this.F||this.v||this.l?Gn(this):this.fb())},A.fb=function(){Gn(this)},A.aa=function(){try{return 2<Kn(this)?this.g.status:-1}catch(t){return-1}},A.fa=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},A.Sa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),On(e)}},A.Ea=function(){return this.m},A.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(A=Yn.prototype).ma=8,A.G=1,A.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const s=new ke(this,this.j,t,void 0);let i=this.s;if(this.S&&(i?(i=St(i),Dt(i,this.S)):i=this.S),null!==this.o||this.N||(s.H=i,i=null),this.O)t:{for(var e=0,n=0;n<this.i.length;n++){var r=this.i[n];if(void 0===(r="__data__"in r.g&&"string"==typeof(r=r.g.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=n;break t}if(4096===e||n===this.i.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=rr(this,s,e),tn(n=Ye(this.F),"RID",t),tn(n,"CVER",22),this.D&&tn(n,"X-HTTP-Session-Id",this.D),nr(this,n),i&&(this.N?e="headers="+encodeURIComponent(String(Qn(i)))+"&"+e:this.o&&Hn(n,this.o,i)),En(this.h,s),this.Ya&&tn(n,"TYPE","init"),this.O?(tn(n,"$req",e),tn(n,"SID","null"),s.Z=!0,Fe(s,n,null)):Fe(s,n,e),this.G=2}}else 3==this.G&&(t?er(this,t):0==this.i.length||vn(this.h)||er(this))},A.Ia=function(){if(this.u=null,ar(this),this.$&&!(this.K||null==this.g||0>=this.P)){var t=2*this.P;this.j.info("BP detection timer enabled: "+t),this.B=Ie(B(this.eb,this),t)}},A.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,we(10),Jn(this),ar(this))},A.cb=function(){null!=this.v&&(this.v=null,Jn(this),ir(this),we(19))},A.kb=function(t){t?(this.j.info("Successfully pinged google.com"),we(2)):(this.j.info("Failed to ping google.com"),we(1))},(A=gr.prototype).xa=function(){},A.wa=function(){},A.va=function(){},A.ua=function(){},A.Ra=function(){},pr.prototype.g=function(t,e){return new yr(t,e)},U(yr,Gt),yr.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;we(0),t.V=e,t.ia=n||{},t.L=t.Y,t.F=fr(t,null,t.V),tr(t)},yr.prototype.close=function(){Xn(this.g)},yr.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=Kt(t),t=n);e.i.push(new class{constructor(t,e){this.h=t,this.g=e}}(e.ab++,t)),3==e.G&&tr(e)},yr.prototype.M=function(){this.g.l=null,delete this.j,Xn(this.g),delete this.g,yr.X.M.call(this)},U(wr,Ae),U(vr,Ce),U(Ir,gr),Ir.prototype.xa=function(){zt(this.g,"a")},Ir.prototype.wa=function(t){zt(this.g,new wr(t))},Ir.prototype.va=function(t){zt(this.g,new vr)},Ir.prototype.ua=function(){zt(this.g,"b")},pr.prototype.createWebChannel=pr.prototype.g,yr.prototype.send=yr.prototype.u,yr.prototype.open=yr.prototype.m,yr.prototype.close=yr.prototype.close,be.NO_ERROR=0,be.TIMEOUT=8,be.HTTP_ERROR=6,Ee.COMPLETE="complete",_e.EventType=xe,xe.OPEN="a",xe.CLOSE="b",xe.ERROR="c",xe.MESSAGE="d",Gt.prototype.listen=Gt.prototype.N,Fn.prototype.listenOnce=Fn.prototype.O,Fn.prototype.getLastError=Fn.prototype.Oa,Fn.prototype.getLastErrorCode=Fn.prototype.Ea,Fn.prototype.getStatus=Fn.prototype.aa,Fn.prototype.getResponseJson=Fn.prototype.Sa,Fn.prototype.getResponseText=Fn.prototype.fa,Fn.prototype.send=Fn.prototype.da,Fn.prototype.setWithCredentials=Fn.prototype.Ka;var br=be,Er=Ee,Tr=de,Sr=10,_r=11,Dr=Cn,xr=_e,Ar=Fn;const Cr="@firebase/firestore";class Nr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Nr.UNAUTHENTICATED=new Nr(null),Nr.GOOGLE_CREDENTIALS=new Nr("google-credentials-uid"),Nr.FIRST_PARTY=new Nr("first-party-uid"),Nr.MOCK_USER=new Nr("mock-user");let kr="9.19.1";const Rr=new class{constructor(t){this.name=t,this._logLevel=_,this._logHandler=x,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in T))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?S[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,T.DEBUG,...t),this._logHandler(this,T.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,T.VERBOSE,...t),this._logHandler(this,T.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,T.INFO,...t),this._logHandler(this,T.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,T.WARN,...t),this._logHandler(this,T.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,T.ERROR,...t),this._logHandler(this,T.ERROR,...t)}}("@firebase/firestore");function Mr(){return Rr.logLevel}function Lr(t){Rr.setLogLevel(t)}function Or(t,...e){if(Rr.logLevel<=T.DEBUG){const n=e.map(Vr);Rr.debug(`Firestore (${kr}): ${t}`,...n)}}function Fr(t,...e){if(Rr.logLevel<=T.ERROR){const n=e.map(Vr);Rr.error(`Firestore (${kr}): ${t}`,...n)}}function Pr(t,...e){if(Rr.logLevel<=T.WARN){const n=e.map(Vr);Rr.warn(`Firestore (${kr}): ${t}`,...n)}}function Vr(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Br(t="Unexpected state"){const e=`FIRESTORE (${kr}) INTERNAL ASSERTION FAILED: `+t;throw Fr(e),new Error(e)}function qr(t,e){t||Br()}function Ur(t,e){t||Br()}function Gr(t,e){return t}const zr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class jr extends p{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Kr{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class $r{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Qr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Nr.UNAUTHENTICATED)))}shutdown(){}}class Hr{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Wr{constructor(t){this.t=t,this.currentUser=Nr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new Kr;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Kr,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{Or("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Or("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Kr)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Or("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(qr("string"==typeof e.accessToken),new $r(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return qr(null===t||"string"==typeof t),new Nr(t)}}class Yr{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=Nr.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const t=this.p();return t&&this.g.set("Authorization",t),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class Xr{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Yr(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(Nr.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Jr{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Zr{constructor(t){this.I=t,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(t,e){const n=t=>{null!=t.error&&Or("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.T;return this.T=t.token,Or("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{Or("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.I.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.I.getImmediate({optional:!0});t?r(t):Or("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(qr("string"==typeof t.token),this.T=t.token,new Jr(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class ts{getToken(){return Promise.resolve(new Jr(""))}invalidateToken(){}start(t,e){}shutdown(){}}function es(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class ns{static A(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=es(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function rs(t,e){return t<e?-1:t>e?1:0}function ss(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function is(t){return t+"\0"}class os{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new jr(zr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new jr(zr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new jr(zr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new jr(zr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return os.fromMillis(Date.now())}static fromDate(t){return os.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new os(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?rs(this.nanoseconds,t.nanoseconds):rs(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class as{constructor(t){this.timestamp=t}static fromTimestamp(t){return new as(t)}static min(){return new as(new os(0,0))}static max(){return new as(new os(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class cs{constructor(t,e,n){void 0===e?e=0:e>t.length&&Br(),void 0===n?n=t.length-e:n>t.length-e&&Br(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===cs.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof cs?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class us extends cs{construct(t,e,n){return new us(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new jr(zr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new us(e)}static emptyPath(){return new us([])}}const ls=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class hs extends cs{construct(t,e,n){return new hs(t,e,n)}static isValidIdentifier(t){return ls.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),hs.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new hs(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new jr(zr.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new jr(zr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new jr(zr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new jr(zr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new hs(e)}static emptyPath(){return new hs([])}}class ds{constructor(t){this.path=t}static fromPath(t){return new ds(us.fromString(t))}static fromName(t){return new ds(us.fromString(t).popFirst(5))}static empty(){return new ds(us.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===us.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return us.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ds(new us(t.slice()))}}class fs{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function ms(t){return t.fields.find((t=>2===t.kind))}function gs(t){return t.fields.filter((t=>2!==t.kind))}function ps(t,e){let n=rs(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(t.fields.length,e.fields.length);++r)if(n=ws(t.fields[r],e.fields[r]),0!==n)return n;return rs(t.fields.length,e.fields.length)}fs.UNKNOWN_ID=-1;class ys{constructor(t,e){this.fieldPath=t,this.kind=e}}function ws(t,e){const n=hs.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:rs(t.kind,e.kind)}class vs{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new vs(0,Es.min())}}function Is(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,s=as.fromTimestamp(1e9===r?new os(n+1,0):new os(n,r));return new Es(s,ds.empty(),e)}function bs(t){return new Es(t.readTime,t.key,-1)}class Es{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new Es(as.min(),ds.empty(),-1)}static max(){return new Es(as.max(),ds.empty(),-1)}}function Ts(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=ds.comparator(t.documentKey,e.documentKey),0!==n?n:rs(t.largestBatchId,e.largestBatchId))}const Ss="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class _s{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Ds(t){if(t.code!==zr.FAILED_PRECONDITION||t.message!==Ss)throw t;Or("LocalStore","Unexpectedly lost primary lease")}class xs{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Br(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new xs(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof xs?e:xs.resolve(e)}catch(t){return xs.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):xs.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):xs.reject(e)}static resolve(t){return new xs(((e,n)=>{e(t)}))}static reject(t){return new xs(((e,n)=>{n(t)}))}static waitFor(t){return new xs(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=xs.resolve(!1);for(const n of t)e=e.next((t=>t?xs.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new xs(((n,r)=>{const s=t.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;e(t[c]).next((t=>{i[c]=t,++o,o===s&&n(i)}),(t=>r(t)))}}))}static doWhile(t,e){return new xs(((n,r)=>{const s=()=>{!0===t()?e().next((()=>{s()}),r):n()};s()}))}}class As{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.R=new Kr,this.transaction.oncomplete=()=>{this.R.resolve()},this.transaction.onabort=()=>{e.error?this.R.reject(new ks(t,e.error)):this.R.resolve()},this.transaction.onerror=e=>{const n=Fs(e.target.error);this.R.reject(new ks(t,n))}}static open(t,e,n,r){try{return new As(e,t.transaction(r,n))}catch(t){throw new ks(e,t)}}get v(){return this.R.promise}abort(t){t&&this.R.reject(t),this.aborted||(Or("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Ms(e)}}class Cs{constructor(t,e,n){this.name=t,this.version=e,this.V=n,12.2===Cs.S(m())&&Fr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Or("SimpleDb","Removing database:",t),Ls(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(t){return!1}}())return!1;if(Cs.C())return!0;const t=m(),e=Cs.S(t),n=0<e&&e<10,r=Cs.N(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static C(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.k)}static O(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(t){return this.db||(Or("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new ks(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new jr(zr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new jr(zr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ks(t,r))},r.onupgradeneeded=t=>{Or("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.V.M(e,r.transaction,t.oldVersion,this.version).next((()=>{Or("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=t=>this.F(t)),this.db}B(t){this.F=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.$(t);const e=As.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next((t=>(e.P(),t))).catch((t=>(e.abort(t),xs.reject(t)))).toPromise();return i.catch((()=>{})),await e.v,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(Or("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ns{constructor(t){this.L=t,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(t){this.L=t}done(){this.q=!0}G(t){this.U=t}delete(){return Ls(this.L.delete())}}class ks extends jr{constructor(t,e){super(zr.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Rs(t){return"IndexedDbTransactionError"===t.name}class Ms{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Or("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Or("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Ls(n)}add(t){return Or("SimpleDb","ADD",this.store.name,t,t),Ls(this.store.add(t))}get(t){return Ls(this.store.get(t)).next((e=>(void 0===e&&(e=null),Or("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Or("SimpleDb","DELETE",this.store.name,t),Ls(this.store.delete(t))}count(){return Or("SimpleDb","COUNT",this.store.name),Ls(this.store.count())}j(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.W(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new xs(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}H(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new xs(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}J(t,e){Or("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.Y=!1;const r=this.cursor(n);return this.W(r,((t,e,n)=>n.delete()))}Z(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.W(r,e)}X(t){const e=this.cursor({});return new xs(((n,r)=>{e.onerror=t=>{const e=Fs(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}W(t,e){const n=[];return new xs(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new Ns(s),o=e(s.primaryKey,s.value,i);if(o instanceof xs){const t=o.catch((t=>(i.done(),xs.reject(t))));n.push(t)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>xs.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Y?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Ls(t){return new xs(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Fs(t.target.error);n(e)}}))}let Os=!1;function Fs(t){const e=Cs.S(m());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new jr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Os||(Os=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Ps{constructor(t,e){this.asyncQueue=t,this.tt=e,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(t){Or("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Or("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(t){Rs(t)?Or("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await Ds(t)}await this.et(6e4)}))}}class Vs{constructor(t,e){this.localStore=t,this.persistence=e}async nt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.st(e,t)))}st(t,e){const n=new Set;let r=e,s=!0;return xs.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Or("IndexBackiller",`Processing collection: ${e}`),this.it(t,e,r).next((t=>{r-=t,n.add(e)}));s=!1})))).next((()=>e-r))}it(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(t,s).next((()=>this.rt(r,n))).next((n=>(Or("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>s.size))}))))}rt(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=bs(e);Ts(r,n)>0&&(n=r)})),new Es(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Bs{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.ot(t),this.ut=t=>e.writeSequenceNumber(t))}ot(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ut&&this.ut(t),t}}function qs(t){return null==t}function Us(t){return 0===t&&1/t==-1/0}function Gs(t){return"number"==typeof t&&Number.isInteger(t)&&!Us(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function zs(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Ks(e)),e=js(t.get(n),e);return Ks(e)}function js(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Ks(t){return t+""}function $s(t){const e=t.length;if(qr(e>=2),2===e)return qr(""===t.charAt(0)&&""===t.charAt(1)),us.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Br(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=t.substring(i,e),s+="\0";break;case"":s+=t.substring(i,e+1);break;default:Br()}i=e+2}return new us(r)}Bs.ct=-1;const Qs=["userId","batchId"];function Hs(t,e){return[t,zs(e)]}function Ws(t,e,n){return[t,zs(e),n]}const Ys={},Xs=["prefixPath","collectionGroup","readTime","documentId"],Js=["prefixPath","collectionGroup","documentId"],Zs=["collectionGroup","readTime","prefixPath","documentId"],ti=["canonicalId","targetId"],ei=["targetId","path"],ni=["path","targetId"],ri=["collectionId","parent"],si=["indexId","uid"],ii=["uid","sequenceNumber"],oi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ai=["indexId","uid","orderedDocumentKey"],ci=["userId","collectionPath","documentId"],ui=["userId","collectionPath","largestBatchId"],li=["userId","collectionGroup","largestBatchId"],hi=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],di=[...hi,"documentOverlays"],fi=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],mi=fi,gi=[...mi,"indexConfiguration","indexState","indexEntries"];class pi extends _s{constructor(t,e){super(),this.at=t,this.currentSequenceNumber=e}}function yi(t,e){const n=Gr(t);return Cs.O(n.at,e)}function wi(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function vi(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Ii(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class bi{constructor(t,e){this.comparator=t,this.root=e||Ti.EMPTY}insert(t,e){return new bi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ti.BLACK,null,null))}remove(t){return new bi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ti.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Ei(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Ei(this.root,t,this.comparator,!1)}getReverseIterator(){return new Ei(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Ei(this.root,t,this.comparator,!0)}}class Ei{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Ti{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Ti.RED,this.left=null!=r?r:Ti.EMPTY,this.right=null!=s?s:Ti.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Ti(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ti.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Ti.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Ti.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Ti.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Br();if(this.right.isRed())throw Br();const t=this.left.check();if(t!==this.right.check())throw Br();return t+(this.isRed()?0:1)}}Ti.EMPTY=null,Ti.RED=!0,Ti.BLACK=!1,Ti.EMPTY=new class{constructor(){this.size=0}get key(){throw Br()}get value(){throw Br()}get color(){throw Br()}get left(){throw Br()}get right(){throw Br()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Ti(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Si{constructor(t){this.comparator=t,this.data=new bi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new _i(this.data.getIterator())}getIteratorFrom(t){return new _i(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Si))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Si(this.comparator);return e.data=t,e}}class _i{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Di(t){return t.hasNext()?t.getNext():void 0}class xi{constructor(t){this.fields=t,t.sort(hs.comparator)}static empty(){return new xi([])}unionWith(t){let e=new Si(hs.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new xi(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return ss(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class Ai extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function Ci(){return"undefined"!=typeof atob}class Ni{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new Ai("Invalid base64 string: "+t):t}}(t);return new Ni(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Ni(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return rs(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Ni.EMPTY_BYTE_STRING=new Ni("");const ki=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ri(t){if(qr(!!t),"string"==typeof t){let e=0;const n=ki.exec(t);if(qr(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:Mi(t.seconds),nanos:Mi(t.nanos)}}function Mi(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Li(t){return"string"==typeof t?Ni.fromBase64String(t):Ni.fromUint8Array(t)}function Oi(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Fi(t){const e=t.mapValue.fields.__previous_value__;return Oi(e)?Fi(e):e}function Pi(t){const e=Ri(t.mapValue.fields.__local_write_time__.timestampValue);return new os(e.seconds,e.nanos)}class Vi{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Bi{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Bi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Bi&&t.projectId===this.projectId&&t.database===this.database}}const qi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ui={nullValue:"NULL_VALUE"};function Gi(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Oi(t)?4:no(t)?9007199254740991:10:Br()}function zi(t,e){if(t===e)return!0;const n=Gi(t);if(n!==Gi(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Pi(t).isEqual(Pi(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Ri(t.timestampValue),r=Ri(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Li(t.bytesValue).isEqual(Li(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Mi(t.geoPointValue.latitude)===Mi(e.geoPointValue.latitude)&&Mi(t.geoPointValue.longitude)===Mi(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Mi(t.integerValue)===Mi(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Mi(t.doubleValue),r=Mi(e.doubleValue);return n===r?Us(n)===Us(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return ss(t.arrayValue.values||[],e.arrayValue.values||[],zi);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(wi(n)!==wi(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!zi(n[t],r[t])))return!1;return!0}(t,e);default:return Br()}}function ji(t,e){return void 0!==(t.values||[]).find((t=>zi(t,e)))}function Ki(t,e){if(t===e)return 0;const n=Gi(t),r=Gi(e);if(n!==r)return rs(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return rs(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Mi(t.integerValue||t.doubleValue),r=Mi(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return $i(t.timestampValue,e.timestampValue);case 4:return $i(Pi(t),Pi(e));case 5:return rs(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Li(t),r=Li(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=rs(n[t],r[t]);if(0!==e)return e}return rs(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=rs(Mi(t.latitude),Mi(e.latitude));return 0!==n?n:rs(Mi(t.longitude),Mi(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=Ki(n[t],r[t]);if(e)return e}return rs(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===qi.mapValue&&e===qi.mapValue)return 0;if(t===qi.mapValue)return 1;if(e===qi.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=rs(r[t],i[t]);if(0!==e)return e;const o=Ki(n[r[t]],s[i[t]]);if(0!==o)return o}return rs(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Br()}}function $i(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return rs(t,e);const n=Ri(t),r=Ri(e),s=rs(n.seconds,r.seconds);return 0!==s?s:rs(n.nanos,r.nanos)}function Qi(t){return Hi(t)}function Hi(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Ri(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Li(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,ds.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=Hi(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${Hi(t.fields[s])}`;return n+"}"}(t.mapValue):Br();var e,n}function Wi(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function Yi(t){return!!t&&"integerValue"in t}function Xi(t){return!!t&&"arrayValue"in t}function Ji(t){return!!t&&"nullValue"in t}function Zi(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function to(t){return!!t&&"mapValue"in t}function eo(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return vi(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=eo(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=eo(t.arrayValue.values[n]);return e}return Object.assign({},t)}function no(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function ro(t){return"nullValue"in t?Ui:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?Wi(Bi.empty(),ds.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Br()}function so(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?Wi(Bi.empty(),ds.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?qi:Br()}function io(t,e){const n=Ki(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function oo(t,e){const n=Ki(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class ao{constructor(t){this.value=t}static empty(){return new ao({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!to(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=eo(e)}setAll(t){let e=hs.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=eo(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());to(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return zi(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];to(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){vi(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new ao(eo(this.value))}}function co(t){const e=[];return vi(t.fields,((t,n)=>{const r=new hs([t]);if(to(n)){const t=co(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new xi(e)}class uo{constructor(t,e,n,r,s,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(t){return new uo(t,0,as.min(),as.min(),as.min(),ao.empty(),0)}static newFoundDocument(t,e,n,r){return new uo(t,1,e,as.min(),n,r,0)}static newNoDocument(t,e){return new uo(t,2,e,as.min(),as.min(),ao.empty(),0)}static newUnknownDocument(t,e){return new uo(t,3,e,as.min(),as.min(),ao.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(as.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=ao.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=ao.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=as.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof uo&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new uo(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class lo{constructor(t,e){this.position=t,this.inclusive=e}}function ho(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?ds.comparator(ds.fromName(o.referenceValue),n.key):Ki(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function fo(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!zi(t.position[n],e.position[n]))return!1;return!0}class mo{constructor(t,e="asc"){this.field=t,this.dir=e}}function go(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class po{}class yo extends po{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new xo(t,e,n):"array-contains"===e?new ko(t,n):"in"===e?new Ro(t,n):"not-in"===e?new Mo(t,n):"array-contains-any"===e?new Lo(t,n):new yo(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Ao(t,n):new Co(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(Ki(e,this.value)):null!==e&&Gi(this.value)===Gi(e)&&this.matchesComparison(Ki(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Br()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class wo extends po{constructor(t,e){super(),this.filters=t,this.op=e,this.ht=null}static create(t,e){return new wo(t,e)}matches(t){return vo(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ht||(this.ht=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ht}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const t=this.lt((t=>t.isInequality()));return null!==t?t.field:null}lt(t){for(const e of this.getFlattenedFilters())if(t(e))return e;return null}}function vo(t){return"and"===t.op}function Io(t){return"or"===t.op}function bo(t){return Eo(t)&&vo(t)}function Eo(t){for(const e of t.filters)if(e instanceof wo)return!1;return!0}function To(t){if(t instanceof yo)return t.field.canonicalString()+t.op.toString()+Qi(t.value);if(bo(t))return t.filters.map((t=>To(t))).join(",");{const e=t.filters.map((t=>To(t))).join(",");return`${t.op}(${e})`}}function So(t,e){return t instanceof yo?function(t,e){return e instanceof yo&&t.op===e.op&&t.field.isEqual(e.field)&&zi(t.value,e.value)}(t,e):t instanceof wo?function(t,e){return e instanceof wo&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&So(n,e.filters[r])),!0)}(t,e):void Br()}function _o(t,e){const n=t.filters.concat(e);return wo.create(n,t.op)}function Do(t){return t instanceof yo?function(t){return`${t.field.canonicalString()} ${t.op} ${Qi(t.value)}`}(t):t instanceof wo?function(t){return t.op.toString()+" {"+t.getFilters().map(Do).join(" ,")+"}"}(t):"Filter"}class xo extends yo{constructor(t,e,n){super(t,e,n),this.key=ds.fromName(n.referenceValue)}matches(t){const e=ds.comparator(t.key,this.key);return this.matchesComparison(e)}}class Ao extends yo{constructor(t,e){super(t,"in",e),this.keys=No("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Co extends yo{constructor(t,e){super(t,"not-in",e),this.keys=No("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function No(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>ds.fromName(t.referenceValue)))}class ko extends yo{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Xi(e)&&ji(e.arrayValue,this.value)}}class Ro extends yo{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&ji(this.value.arrayValue,e)}}class Mo extends yo{constructor(t,e){super(t,"not-in",e)}matches(t){if(ji(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!ji(this.value.arrayValue,e)}}class Lo extends yo{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Xi(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>ji(this.value.arrayValue,t)))}}class Oo{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ft=null}}function Fo(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Oo(t,e,n,r,s,i,o)}function Po(t){const e=Gr(t);if(null===e.ft){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>To(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),qs(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>Qi(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>Qi(t))).join(",")),e.ft=t}return e.ft}function Vo(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!go(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!So(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!fo(t.startAt,e.startAt)&&fo(t.endAt,e.endAt)}function Bo(t){return ds.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function qo(t,e){return t.filters.filter((t=>t instanceof yo&&t.field.isEqual(e)))}function Uo(t,e,n){let r=Ui,s=!0;for(const n of qo(t,e)){let t=Ui,e=!0;switch(n.op){case"<":case"<=":t=ro(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Ui}io({value:r,inclusive:s},{value:t,inclusive:e})<0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];io({value:r,inclusive:s},{value:t,inclusive:n.inclusive})<0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}function Go(t,e,n){let r=qi,s=!0;for(const n of qo(t,e)){let t=qi,e=!0;switch(n.op){case">=":case">":t=so(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=qi}oo({value:r,inclusive:s},{value:t,inclusive:e})>0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];oo({value:r,inclusive:s},{value:t,inclusive:n.inclusive})>0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}class zo{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.dt=null,this.wt=null,this.startAt,this.endAt}}function jo(t,e,n,r,s,i,o,a){return new zo(t,e,n,r,s,i,o,a)}function Ko(t){return new zo(t)}function $o(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function Qo(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Ho(t){for(const e of t.filters){const t=e.getFirstInequalityField();if(null!==t)return t}return null}function Wo(t){return null!==t.collectionGroup}function Yo(t){const e=Gr(t);if(null===e.dt){e.dt=[];const t=Ho(e),n=Qo(e);if(null!==t&&null===n)t.isKeyField()||e.dt.push(new mo(t)),e.dt.push(new mo(hs.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.dt.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.dt.push(new mo(hs.keyField(),t))}}}return e.dt}function Xo(t){const e=Gr(t);if(!e.wt)if("F"===e.limitType)e.wt=Fo(e.path,e.collectionGroup,Yo(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of Yo(e)){const e="desc"===n.dir?"asc":"desc";t.push(new mo(n.field,e))}const n=e.endAt?new lo(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new lo(e.startAt.position,e.startAt.inclusive):null;e.wt=Fo(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.wt}function Jo(t,e){e.getFirstInequalityField(),Ho(t);const n=t.filters.concat([e]);return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function Zo(t,e,n){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function ta(t,e){return Vo(Xo(t),Xo(e))&&t.limitType===e.limitType}function ea(t){return`${Po(Xo(t))}|lt:${t.limitType}`}function na(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>Do(t))).join(", ")}]`),qs(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>Qi(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>Qi(t))).join(",")),`Target(${e})`}(Xo(t))}; limitType=${t.limitType})`}function ra(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):ds.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of Yo(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=ho(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,Yo(t),e))&&!(t.endAt&&!function(t,e,n){const r=ho(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,Yo(t),e))}(t,e)}function sa(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function ia(t){return(e,n)=>{let r=!1;for(const s of Yo(t)){const t=oa(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function oa(t,e,n){const r=t.field.isKeyField()?ds.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?Ki(r,s):Br()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return Br()}}class aa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){vi(this.inner,((e,n)=>{for(const[e,r]of n)t(e,r)}))}isEmpty(){return Ii(this.inner)}size(){return this.innerSize}}const ca=new bi(ds.comparator);function ua(){return ca}const la=new bi(ds.comparator);function ha(...t){let e=la;for(const n of t)e=e.insert(n.key,n);return e}function da(t){let e=la;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function fa(){return ga()}function ma(){return ga()}function ga(){return new aa((t=>t.toString()),((t,e)=>t.isEqual(e)))}const pa=new bi(ds.comparator),ya=new Si(ds.comparator);function wa(...t){let e=ya;for(const n of t)e=e.add(n);return e}const va=new Si(rs);function Ia(){return va}function ba(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Us(e)?"-0":e}}function Ea(t){return{integerValue:""+t}}function Ta(t,e){return Gs(e)?Ea(e):ba(t,e)}class Sa{constructor(){this._=void 0}}function _a(t,e,n){return t instanceof Aa?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Ca?Na(t,e):t instanceof ka?Ra(t,e):function(t,e){const n=xa(t,e),r=La(n)+La(t._t);return Yi(n)&&Yi(t._t)?Ea(r):ba(t.serializer,r)}(t,e)}function Da(t,e,n){return t instanceof Ca?Na(t,e):t instanceof ka?Ra(t,e):n}function xa(t,e){return t instanceof Ma?Yi(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class Aa extends Sa{}class Ca extends Sa{constructor(t){super(),this.elements=t}}function Na(t,e){const n=Oa(e);for(const e of t.elements)n.some((t=>zi(t,e)))||n.push(e);return{arrayValue:{values:n}}}class ka extends Sa{constructor(t){super(),this.elements=t}}function Ra(t,e){let n=Oa(e);for(const e of t.elements)n=n.filter((t=>!zi(t,e)));return{arrayValue:{values:n}}}class Ma extends Sa{constructor(t,e){super(),this.serializer=t,this._t=e}}function La(t){return Mi(t.integerValue||t.doubleValue)}function Oa(t){return Xi(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Fa{constructor(t,e){this.field=t,this.transform=e}}class Pa{constructor(t,e){this.version=t,this.transformResults=e}}class Va{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Va}static exists(t){return new Va(void 0,t)}static updateTime(t){return new Va(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ba(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class qa{}function Ua(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Xa(t.key,Va.none()):new $a(t.key,t.data,Va.none());{const n=t.data,r=ao.empty();let s=new Si(hs.comparator);for(let t of e.fields)if(!s.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),s=s.add(t)}return new Qa(t.key,r,new xi(s.toArray()),Va.none())}}function Ga(t,e,n){t instanceof $a?function(t,e,n){const r=t.value.clone(),s=Wa(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Qa?function(t,e,n){if(!Ba(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=Wa(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Ha(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function za(t,e,n,r){return t instanceof $a?function(t,e,n,r){if(!Ba(t.precondition,e))return n;const s=t.value.clone(),i=Ya(t.fieldTransforms,r,e);return s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null}(t,e,n,r):t instanceof Qa?function(t,e,n,r){if(!Ba(t.precondition,e))return n;const s=Ya(t.fieldTransforms,r,e),i=e.data;return i.setAll(Ha(t)),i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return Ba(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function ja(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=xa(r.transform,t||null);null!=s&&(null===n&&(n=ao.empty()),n.set(r.field,s))}return n||null}function Ka(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&ss(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Ca&&e instanceof Ca||t instanceof ka&&e instanceof ka?ss(t.elements,e.elements,zi):t instanceof Ma&&e instanceof Ma?zi(t._t,e._t):t instanceof Aa&&e instanceof Aa}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class $a extends qa{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Qa extends qa{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Ha(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function Wa(t,e,n){const r=new Map;qr(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,Da(o,a,n[s]))}return r}function Ya(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,_a(t,i,e))}return r}class Xa extends qa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ja extends qa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Za{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&Ga(r,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=za(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=za(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=ma();return this.mutations.forEach((r=>{const s=t.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=e.has(r.key)?null:o;const a=Ua(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(as.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),wa())}isEqual(t){return this.batchId===t.batchId&&ss(this.mutations,t.mutations,((t,e)=>Ka(t,e)))&&ss(this.baseMutations,t.baseMutations,((t,e)=>Ka(t,e)))}}class tc{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){qr(t.mutations.length===n.length);let r=pa;const s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new tc(t,e,n,r)}}class ec{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}const nc=/^[_a-zA-Z][_a-zA-Z0-9]*(?:\.[_a-zA-Z][_a-zA-Z0-9]*)*$/;class rc{constructor(t){this.alias=t}static gt(t){return nc.test(t)}canonicalString(){let t=this.alias.replace(/\\/g,"\\\\").replace(/`/g,"\\`");return rc.gt(t)||(t="`"+t+"`"),t}}class sc{constructor(t,e,n){this.alias=t,this.yt=e,this.fieldPath=n}}class ic{constructor(t){this.count=t}}var oc,ac;function cc(t){switch(t){default:return Br();case zr.CANCELLED:case zr.UNKNOWN:case zr.DEADLINE_EXCEEDED:case zr.RESOURCE_EXHAUSTED:case zr.INTERNAL:case zr.UNAVAILABLE:case zr.UNAUTHENTICATED:return!1;case zr.INVALID_ARGUMENT:case zr.NOT_FOUND:case zr.ALREADY_EXISTS:case zr.PERMISSION_DENIED:case zr.FAILED_PRECONDITION:case zr.ABORTED:case zr.OUT_OF_RANGE:case zr.UNIMPLEMENTED:case zr.DATA_LOSS:return!0}}function uc(t){if(void 0===t)return Fr("GRPC error has no .code"),zr.UNKNOWN;switch(t){case oc.OK:return zr.OK;case oc.CANCELLED:return zr.CANCELLED;case oc.UNKNOWN:return zr.UNKNOWN;case oc.DEADLINE_EXCEEDED:return zr.DEADLINE_EXCEEDED;case oc.RESOURCE_EXHAUSTED:return zr.RESOURCE_EXHAUSTED;case oc.INTERNAL:return zr.INTERNAL;case oc.UNAVAILABLE:return zr.UNAVAILABLE;case oc.UNAUTHENTICATED:return zr.UNAUTHENTICATED;case oc.INVALID_ARGUMENT:return zr.INVALID_ARGUMENT;case oc.NOT_FOUND:return zr.NOT_FOUND;case oc.ALREADY_EXISTS:return zr.ALREADY_EXISTS;case oc.PERMISSION_DENIED:return zr.PERMISSION_DENIED;case oc.FAILED_PRECONDITION:return zr.FAILED_PRECONDITION;case oc.ABORTED:return zr.ABORTED;case oc.OUT_OF_RANGE:return zr.OUT_OF_RANGE;case oc.UNIMPLEMENTED:return zr.UNIMPLEMENTED;case oc.DATA_LOSS:return zr.DATA_LOSS;default:return Br()}}(ac=oc||(oc={}))[ac.OK=0]="OK",ac[ac.CANCELLED=1]="CANCELLED",ac[ac.UNKNOWN=2]="UNKNOWN",ac[ac.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ac[ac.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ac[ac.NOT_FOUND=5]="NOT_FOUND",ac[ac.ALREADY_EXISTS=6]="ALREADY_EXISTS",ac[ac.PERMISSION_DENIED=7]="PERMISSION_DENIED",ac[ac.UNAUTHENTICATED=16]="UNAUTHENTICATED",ac[ac.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ac[ac.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ac[ac.ABORTED=10]="ABORTED",ac[ac.OUT_OF_RANGE=11]="OUT_OF_RANGE",ac[ac.UNIMPLEMENTED=12]="UNIMPLEMENTED",ac[ac.INTERNAL=13]="INTERNAL",ac[ac.UNAVAILABLE=14]="UNAVAILABLE",ac[ac.DATA_LOSS=15]="DATA_LOSS";class lc{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return hc}static getOrCreateInstance(){return null===hc&&(hc=new lc),hc}onExistenceFilterMismatch(t){const e=Symbol();return this.onExistenceFilterMismatchCallbacks.set(e,t),()=>this.onExistenceFilterMismatchCallbacks.delete(e)}notifyOnExistenceFilterMismatch(t){this.onExistenceFilterMismatchCallbacks.forEach((e=>e(t)))}}let hc=null;class dc{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,fc.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new dc(as.min(),r,Ia(),ua(),wa())}}class fc{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new fc(n,e,wa(),wa(),wa())}}class mc{constructor(t,e,n,r){this.It=t,this.removedTargetIds=e,this.key=n,this.Tt=r}}class gc{constructor(t,e){this.targetId=t,this.Et=e}}class pc{constructor(t,e,n=Ni.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class yc{constructor(){this.At=0,this.Rt=Ic(),this.vt=Ni.EMPTY_BYTE_STRING,this.bt=!1,this.Pt=!0}get current(){return this.bt}get resumeToken(){return this.vt}get Vt(){return 0!==this.At}get St(){return this.Pt}Dt(t){t.approximateByteSize()>0&&(this.Pt=!0,this.vt=t)}Ct(){let t=wa(),e=wa(),n=wa();return this.Rt.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:Br()}})),new fc(this.vt,this.bt,t,e,n)}xt(){this.Pt=!1,this.Rt=Ic()}Nt(t,e){this.Pt=!0,this.Rt=this.Rt.insert(t,e)}kt(t){this.Pt=!0,this.Rt=this.Rt.remove(t)}Ot(){this.At+=1}$t(){this.At-=1}Mt(){this.Pt=!0,this.bt=!0}}class wc{constructor(t){this.Ft=t,this.Bt=new Map,this.Lt=ua(),this.qt=vc(),this.Ut=new Si(rs)}Kt(t){for(const e of t.It)t.Tt&&t.Tt.isFoundDocument()?this.Gt(e,t.Tt):this.Qt(e,t.key,t.Tt);for(const e of t.removedTargetIds)this.Qt(e,t.key,t.Tt)}zt(t){this.forEachTarget(t,(e=>{const n=this.jt(e);switch(t.state){case 0:this.Wt(e)&&n.Dt(t.resumeToken);break;case 1:n.$t(),n.Vt||n.xt(),n.Dt(t.resumeToken);break;case 2:n.$t(),n.Vt||this.removeTarget(e);break;case 3:this.Wt(e)&&(n.Mt(),n.Dt(t.resumeToken));break;case 4:this.Wt(e)&&(this.Ht(e),n.Dt(t.resumeToken));break;default:Br()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Bt.forEach(((t,n)=>{this.Wt(n)&&e(n)}))}Jt(t){var e;const n=t.targetId,r=t.Et.count,s=this.Yt(n);if(s){const i=s.target;if(Bo(i))if(0===r){const t=new ds(i.path);this.Qt(n,t,uo.newNoDocument(t,as.min()))}else qr(1===r);else{const s=this.Zt(n);s!==r&&(this.Ht(n),this.Ut=this.Ut.add(n),null===(e=lc.instance)||void 0===e||e.notifyOnExistenceFilterMismatch({localCacheCount:s,existenceFilterCount:t.Et.count}))}}}Xt(t){const e=new Map;this.Bt.forEach(((n,r)=>{const s=this.Yt(r);if(s){if(n.current&&Bo(s.target)){const e=new ds(s.target.path);null!==this.Lt.get(e)||this.te(r,e)||this.Qt(r,e,uo.newNoDocument(e,t))}n.St&&(e.set(r,n.Ct()),n.xt())}}));let n=wa();this.qt.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Yt(t);return!e||2===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.Lt.forEach(((e,n)=>n.setReadTime(t)));const r=new dc(t,e,this.Ut,this.Lt,n);return this.Lt=ua(),this.qt=vc(),this.Ut=new Si(rs),r}Gt(t,e){if(!this.Wt(t))return;const n=this.te(t,e.key)?2:0;this.jt(t).Nt(e.key,n),this.Lt=this.Lt.insert(e.key,e),this.qt=this.qt.insert(e.key,this.ee(e.key).add(t))}Qt(t,e,n){if(!this.Wt(t))return;const r=this.jt(t);this.te(t,e)?r.Nt(e,1):r.kt(e),this.qt=this.qt.insert(e,this.ee(e).delete(t)),n&&(this.Lt=this.Lt.insert(e,n))}removeTarget(t){this.Bt.delete(t)}Zt(t){const e=this.jt(t).Ct();return this.Ft.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Ot(t){this.jt(t).Ot()}jt(t){let e=this.Bt.get(t);return e||(e=new yc,this.Bt.set(t,e)),e}ee(t){let e=this.qt.get(t);return e||(e=new Si(rs),this.qt=this.qt.insert(t,e)),e}Wt(t){const e=null!==this.Yt(t);return e||Or("WatchChangeAggregator","Detected inactive target",t),e}Yt(t){const e=this.Bt.get(t);return e&&e.Vt?null:this.Ft.ne(t)}Ht(t){this.Bt.set(t,new yc),this.Ft.getRemoteKeysForTarget(t).forEach((e=>{this.Qt(t,e,null)}))}te(t,e){return this.Ft.getRemoteKeysForTarget(t).has(e)}}function vc(){return new bi(ds.comparator)}function Ic(){return new bi(ds.comparator)}const bc={asc:"ASCENDING",desc:"DESCENDING"},Ec={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Tc={and:"AND",or:"OR"};class Sc{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function _c(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Dc(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function xc(t,e){return _c(t,e.toTimestamp())}function Ac(t){return qr(!!t),as.fromTimestamp(function(t){const e=Ri(t);return new os(e.seconds,e.nanos)}(t))}function Cc(t,e){return function(t){return new us(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Nc(t){const e=us.fromString(t);return qr(Jc(e)),e}function kc(t,e){return Cc(t.databaseId,e.path)}function Rc(t,e){const n=Nc(e);if(n.get(1)!==t.databaseId.projectId)throw new jr(zr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new jr(zr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new ds(Fc(n))}function Mc(t,e){return Cc(t.databaseId,e)}function Lc(t){const e=Nc(t);return 4===e.length?us.emptyPath():Fc(e)}function Oc(t){return new us(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Fc(t){return qr(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Pc(t,e,n){return{name:kc(t,e),fields:n.value.mapValue.fields}}function Vc(t,e,n){const r=Rc(t,e.name),s=Ac(e.updateTime),i=e.createTime?Ac(e.createTime):as.min(),o=new ao({mapValue:{fields:e.fields}}),a=uo.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Bc(t,e){let n;if(e instanceof $a)n={update:Pc(t,e.key,e.value)};else if(e instanceof Xa)n={delete:kc(t,e.key)};else if(e instanceof Qa)n={update:Pc(t,e.key,e.data),updateMask:Xc(e.fieldMask)};else{if(!(e instanceof Ja))return Br();n={verify:kc(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Aa)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Ca)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ka)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ma)return{fieldPath:e.field.canonicalString(),increment:n._t};throw Br()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:xc(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Br()}(t,e.precondition)),n}function qc(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Va.updateTime(Ac(t.updateTime)):void 0!==t.exists?Va.exists(t.exists):Va.none()}(e.currentDocument):Va.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)qr("REQUEST_TIME"===e.setToServerValue),n=new Aa;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Ca(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ka(t)}else"increment"in e?n=new Ma(t,e.increment):Br();const r=hs.fromServerFormat(e.fieldPath);return new Fa(r,n)}(t,e))):[];if(e.update){e.update.name;const s=Rc(t,e.update.name),i=new ao({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new xi(e.map((t=>hs.fromServerFormat(t))))}(e.updateMask);return new Qa(s,i,t,n,r)}return new $a(s,i,n,r)}if(e.delete){const r=Rc(t,e.delete);return new Xa(r,n)}if(e.verify){const r=Rc(t,e.verify);return new Ja(r,n)}return Br()}function Uc(t,e){return{documents:[Mc(t,e.path)]}}function Gc(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=Mc(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Mc(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(t){if(0!==t.length)return Yc(wo.create(t,"and"))}(e.filters);s&&(n.structuredQuery.where=s);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Hc(t.field),direction:Kc(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.useProto3Json||qs(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function zc(t){let e=Lc(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){qr(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=jc(t);return e instanceof wo&&bo(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new mo(Wc(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,qs(e)?null:e}(n.limit));let c=null;n.startAt&&(c=function(t){const e=!!t.before,n=t.values||[];return new lo(n,e)}(n.startAt));let u=null;return n.endAt&&(u=function(t){const e=!t.before,n=t.values||[];return new lo(n,e)}(n.endAt)),jo(e,s,o,i,a,"F",c,u)}function jc(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Wc(t.unaryFilter.field);return yo.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Wc(t.unaryFilter.field);return yo.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Wc(t.unaryFilter.field);return yo.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Wc(t.unaryFilter.field);return yo.create(s,"!=",{nullValue:"NULL_VALUE"});default:return Br()}}(t):void 0!==t.fieldFilter?function(t){return yo.create(Wc(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Br()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return wo.create(t.compositeFilter.filters.map((t=>jc(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return Br()}}(t.compositeFilter.op))}(t):Br()}function Kc(t){return bc[t]}function $c(t){return Ec[t]}function Qc(t){return Tc[t]}function Hc(t){return{fieldPath:t.canonicalString()}}function Wc(t){return hs.fromServerFormat(t.fieldPath)}function Yc(t){return t instanceof yo?function(t){if("=="===t.op){if(Zi(t.value))return{unaryFilter:{field:Hc(t.field),op:"IS_NAN"}};if(Ji(t.value))return{unaryFilter:{field:Hc(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Zi(t.value))return{unaryFilter:{field:Hc(t.field),op:"IS_NOT_NAN"}};if(Ji(t.value))return{unaryFilter:{field:Hc(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Hc(t.field),op:$c(t.op),value:t.value}}}(t):t instanceof wo?function(t){const e=t.getFilters().map((t=>Yc(t)));return 1===e.length?e[0]:{compositeFilter:{op:Qc(t.op),filters:e}}}(t):Br()}function Xc(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Jc(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class Zc{constructor(t,e,n,r,s=as.min(),i=as.min(),o=Ni.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new Zc(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Zc(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Zc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class tu{constructor(t){this.se=t}}function eu(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:nu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:kc(t,e.key),fields:e.data.value.mapValue.fields,updateTime:_c(t,e.version.toTimestamp()),createTime:_c(t,e.createTime.toTimestamp())}}(t.se,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:ru(e.version)};else{if(!e.isUnknownDocument())return Br();r.unknownDocument={path:n.path.toArray(),version:ru(e.version)}}return r}function nu(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function ru(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function su(t){const e=new os(t.seconds,t.nanoseconds);return as.fromTimestamp(e)}function iu(t,e){const n=(e.baseMutations||[]).map((e=>qc(t.se,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map((e=>qc(t.se,e))),s=os.fromMillis(e.localWriteTimeMs);return new Za(e.batchId,s,n,r)}function ou(t){const e=su(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?su(t.lastLimboFreeSnapshotVersion):as.min();let r;var s;return void 0!==t.query.documents?(qr(1===(s=t.query).documents.length),r=Xo(Ko(Lc(s.documents[0])))):r=function(t){return Xo(zc(t))}(t.query),new Zc(r,t.targetId,0,t.lastListenSequenceNumber,e,n,Ni.fromBase64String(t.resumeToken))}function au(t,e){const n=ru(e.snapshotVersion),r=ru(e.lastLimboFreeSnapshotVersion);let s;s=Bo(e.target)?Uc(t.se,e.target):Gc(t.se,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Po(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function cu(t){const e=zc({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Zo(e,e.limit,"L"):e}function uu(t,e){return new ec(e.largestBatchId,qc(t.se,e.overlayMutation))}function lu(t,e){const n=e.path.lastSegment();return[t,zs(e.path.popLast()),n]}function hu(t,e,n,r){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:ru(r.readTime),documentKey:zs(r.documentKey.path),largestBatchId:r.largestBatchId}}class du{getBundleMetadata(t,e){return fu(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:su(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return fu(t).put({bundleId:(n=e).id,createTime:ru(Ac(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return mu(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:cu(e.bundledQuery),readTime:su(e.readTime)};var e}))}saveNamedQuery(t,e){return mu(t).put(function(t){return{name:t.name,readTime:ru(Ac(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function fu(t){return yi(t,"bundles")}function mu(t){return yi(t,"namedQueries")}class gu{constructor(t,e){this.serializer=t,this.userId=e}static ie(t,e){const n=e.uid||"";return new gu(t,n)}getOverlay(t,e){return pu(t).get(lu(this.userId,e)).next((t=>t?uu(this.serializer,t):null))}getOverlays(t,e){const n=fa();return xs.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,s)=>{const i=new ec(e,s);r.push(this.re(t,i))})),xs.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(zs(t.getCollectionPath()))));const s=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(pu(t).J("collectionPathOverlayIndex",r))})),xs.waitFor(s)}getOverlaysForCollection(t,e,n){const r=fa(),s=zs(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return pu(t).j("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=uu(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const s=fa();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return pu(t).Z({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=uu(this.serializer,e);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}re(t,e){return pu(t).put(function(t,e,n){const[r,s,i]=lu(e,n.mutation.key);return{userId:e,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Bc(t.se,n.mutation)}}(this.serializer,this.userId,e))}}function pu(t){return yi(t,"documentOverlays")}class yu{constructor(){}oe(t,e){this.ue(t,e),e.ce()}ue(t,e){if("nullValue"in t)this.ae(e,5);else if("booleanValue"in t)this.ae(e,10),e.he(t.booleanValue?1:0);else if("integerValue"in t)this.ae(e,15),e.he(Mi(t.integerValue));else if("doubleValue"in t){const n=Mi(t.doubleValue);isNaN(n)?this.ae(e,13):(this.ae(e,15),Us(n)?e.he(0):e.he(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ae(e,20),"string"==typeof n?e.le(n):(e.le(`${n.seconds||""}`),e.he(n.nanos||0))}else if("stringValue"in t)this.fe(t.stringValue,e),this.de(e);else if("bytesValue"in t)this.ae(e,30),e.we(Li(t.bytesValue)),this.de(e);else if("referenceValue"in t)this._e(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ae(e,45),e.he(n.latitude||0),e.he(n.longitude||0)}else"mapValue"in t?no(t)?this.ae(e,Number.MAX_SAFE_INTEGER):(this.me(t.mapValue,e),this.de(e)):"arrayValue"in t?(this.ge(t.arrayValue,e),this.de(e)):Br()}fe(t,e){this.ae(e,25),this.ye(t,e)}ye(t,e){e.le(t)}me(t,e){const n=t.fields||{};this.ae(e,55);for(const t of Object.keys(n))this.fe(t,e),this.ue(n[t],e)}ge(t,e){const n=t.values||[];this.ae(e,50);for(const t of n)this.ue(t,e)}_e(t,e){this.ae(e,37),ds.fromName(t).path.forEach((t=>{this.ae(e,60),this.ye(t,e)}))}ae(t,e){t.he(e)}de(t){t.he(2)}}function wu(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function vu(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=wu(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}yu.pe=new yu;class Iu{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ie(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Te(n.value),n=e.next();this.Ee()}Ae(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Re(n.value),n=e.next();this.ve()}be(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Te(t);else if(t<2048)this.Te(960|t>>>6),this.Te(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Te(480|t>>>12),this.Te(128|63&t>>>6),this.Te(128|63&t);else{const t=e.codePointAt(0);this.Te(240|t>>>18),this.Te(128|63&t>>>12),this.Te(128|63&t>>>6),this.Te(128|63&t)}}this.Ee()}Pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Re(t);else if(t<2048)this.Re(960|t>>>6),this.Re(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Re(480|t>>>12),this.Re(128|63&t>>>6),this.Re(128|63&t);else{const t=e.codePointAt(0);this.Re(240|t>>>18),this.Re(128|63&t>>>12),this.Re(128|63&t>>>6),this.Re(128|63&t)}}this.ve()}Ve(t){const e=this.Se(t),n=vu(e);this.De(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Ce(t){const e=this.Se(t),n=vu(e);this.De(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}xe(){this.Ne(255),this.Ne(255)}ke(){this.Oe(255),this.Oe(255)}reset(){this.position=0}seed(t){this.De(t.length),this.buffer.set(t,this.position),this.position+=t.length}$e(){return this.buffer.slice(0,this.position)}Se(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Te(t){const e=255&t;0===e?(this.Ne(0),this.Ne(255)):255===e?(this.Ne(255),this.Ne(0)):this.Ne(e)}Re(t){const e=255&t;0===e?(this.Oe(0),this.Oe(255)):255===e?(this.Oe(255),this.Oe(0)):this.Oe(t)}Ee(){this.Ne(0),this.Ne(1)}ve(){this.Oe(0),this.Oe(1)}Ne(t){this.De(1),this.buffer[this.position++]=t}Oe(t){this.De(1),this.buffer[this.position++]=~t}De(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class bu{constructor(t){this.Me=t}we(t){this.Me.Ie(t)}le(t){this.Me.be(t)}he(t){this.Me.Ve(t)}ce(){this.Me.xe()}}class Eu{constructor(t){this.Me=t}we(t){this.Me.Ae(t)}le(t){this.Me.Pe(t)}he(t){this.Me.Ce(t)}ce(){this.Me.ke()}}class Tu{constructor(){this.Me=new Iu,this.Fe=new bu(this.Me),this.Be=new Eu(this.Me)}seed(t){this.Me.seed(t)}Le(t){return 0===t?this.Fe:this.Be}$e(){return this.Me.$e()}reset(){this.Me.reset()}}class Su{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}qe(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new Su(this.indexId,this.documentKey,this.arrayValue,n)}}function _u(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Du(t.arrayValue,e.arrayValue),0!==n?n:(n=Du(t.directionalValue,e.directionalValue),0!==n?n:ds.comparator(t.documentKey,e.documentKey)))}function Du(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class xu{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ue=t.orderBy,this.Ke=[];for(const e of t.filters){const t=e;t.isInequality()?this.Ge=t:this.Ke.push(t)}}Qe(t){qr(t.collectionGroup===this.collectionId);const e=ms(t);if(void 0!==e&&!this.ze(e))return!1;const n=gs(t);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Ge){const t=n[r];if(!this.je(this.Ge,t)||!this.We(this.Ue[s++],t))return!1;++r}for(;r<n.length;++r){const t=n[r];if(s>=this.Ue.length||!this.We(this.Ue[s++],t))return!1}return!0}ze(t){for(const e of this.Ke)if(this.je(e,t))return!0;return!1}je(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}We(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function Au(t){var e,n;if(qr(t instanceof yo||t instanceof wo),t instanceof yo){if(t instanceof Ro){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>yo.create(t.field,"==",e))))||[];return wo.create(r,"or")}return t}const r=t.filters.map((t=>Au(t)));return wo.create(r,t.op)}function Cu(t){if(0===t.getFilters().length)return[];const e=Mu(Au(t));return qr(Ru(e)),Nu(e)||ku(e)?[e]:e.getFilters()}function Nu(t){return t instanceof yo}function ku(t){return t instanceof wo&&bo(t)}function Ru(t){return Nu(t)||ku(t)||function(t){if(t instanceof wo&&Io(t)){for(const e of t.getFilters())if(!Nu(e)&&!ku(e))return!1;return!0}return!1}(t)}function Mu(t){if(qr(t instanceof yo||t instanceof wo),t instanceof yo)return t;if(1===t.filters.length)return Mu(t.filters[0]);const e=t.filters.map((t=>Mu(t)));let n=wo.create(e,t.op);return n=Fu(n),Ru(n)?n:(qr(n instanceof wo),qr(vo(n)),qr(n.filters.length>1),n.filters.reduce(((t,e)=>Lu(t,e))))}function Lu(t,e){let n;return qr(t instanceof yo||t instanceof wo),qr(e instanceof yo||e instanceof wo),n=t instanceof yo?e instanceof yo?function(t,e){return wo.create([t,e],"and")}(t,e):Ou(t,e):e instanceof yo?Ou(e,t):function(t,e){if(qr(t.filters.length>0&&e.filters.length>0),vo(t)&&vo(e))return _o(t,e.getFilters());const n=Io(t)?t:e,r=Io(t)?e:t,s=n.filters.map((t=>Lu(t,r)));return wo.create(s,"or")}(t,e),Fu(n)}function Ou(t,e){if(vo(e))return _o(e,t.getFilters());{const n=e.filters.map((e=>Lu(t,e)));return wo.create(n,"or")}}function Fu(t){if(qr(t instanceof yo||t instanceof wo),t instanceof yo)return t;const e=t.getFilters();if(1===e.length)return Fu(e[0]);if(Eo(t))return t;const n=e.map((t=>Fu(t))),r=[];return n.forEach((e=>{e instanceof yo?r.push(e):e instanceof wo&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:wo.create(r,t.op)}class Pu{constructor(){this.He=new Vu}addToCollectionParentIndex(t,e){return this.He.add(e),xs.resolve()}getCollectionParents(t,e){return xs.resolve(this.He.getEntries(e))}addFieldIndex(t,e){return xs.resolve()}deleteFieldIndex(t,e){return xs.resolve()}getDocumentsMatchingTarget(t,e){return xs.resolve(null)}getIndexType(t,e){return xs.resolve(0)}getFieldIndexes(t,e){return xs.resolve([])}getNextCollectionGroupToUpdate(t){return xs.resolve(null)}getMinOffset(t,e){return xs.resolve(Es.min())}getMinOffsetFromCollectionGroup(t,e){return xs.resolve(Es.min())}updateCollectionGroup(t,e,n){return xs.resolve()}updateIndexEntries(t,e){return xs.resolve()}}class Vu{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Si(us.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Si(us.comparator)).toArray()}}const Bu=new Uint8Array(0);class qu{constructor(t,e){this.user=t,this.databaseId=e,this.Je=new Vu,this.Ye=new aa((t=>Po(t)),((t,e)=>Vo(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.Je.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.Je.add(e)}));const s={collectionId:n,parent:zs(r)};return Uu(t).put(s)}return xs.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[is(e),""],!1,!0);return Uu(t).j(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push($s(r.parent))}return n}))}addFieldIndex(t,e){const n=zu(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const s=n.add(r);if(e.indexState){const n=ju(t);return s.next((t=>{n.put(hu(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return s.next()}deleteFieldIndex(t,e){const n=zu(t),r=ju(t),s=Gu(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=Gu(t);let r=!0;const s=new Map;return xs.forEach(this.Ze(e),(e=>this.Xe(t,e).next((t=>{r&&(r=!!t),s.set(e,t)})))).next((()=>{if(r){let t=wa();const r=[];return xs.forEach(s,((s,i)=>{var o;Or("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${Po(e)}`);const a=function(t,e){const n=ms(e);if(void 0===n)return null;for(const e of qo(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,s),c=function(t,e){const n=new Map;for(const r of gs(e))for(const e of qo(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,s),u=function(t,e){const n=[];let r=!0;for(const s of gs(e)){const e=0===s.kind?Uo(t,s.fieldPath,t.startAt):Go(t,s.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new lo(n,r)}(i,s),l=function(t,e){const n=[];let r=!0;for(const s of gs(e)){const e=0===s.kind?Go(t,s.fieldPath,t.endAt):Uo(t,s.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new lo(n,r)}(i,s),h=this.tn(s,i,u),d=this.tn(s,i,l),f=this.en(s,i,c),m=this.nn(s.indexId,a,h,u.inclusive,d,l.inclusive,f);return xs.forEach(m,(s=>n.H(s,e.limit).next((e=>{e.forEach((e=>{const n=ds.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return xs.resolve(null)}))}Ze(t){let e=this.Ye.get(t);return e||(e=0===t.filters.length?[t]:Cu(wo.create(t.filters,"and")).map((e=>Fo(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.Ye.set(t,e),e)}nn(t,e,n,r,s,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,s.length),c=a/(null!=e?e.length:1),u=[];for(let l=0;l<a;++l){const a=e?this.sn(e[l/c]):Bu,h=this.rn(t,a,n[l%c],r),d=this.on(t,a,s[l%c],i),f=o.map((e=>this.rn(t,a,e,!0)));u.push(...this.createRange(h,d,f))}return u}rn(t,e,n,r){const s=new Su(t,ds.empty(),e,n);return r?s:s.qe()}on(t,e,n,r){const s=new Su(t,ds.empty(),e,n);return r?s.qe():s}Xe(t,e){const n=new xu(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.Qe(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.Ze(e);return xs.forEach(r,(e=>this.Xe(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Si(hs.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}un(t,e){const n=new Tu;for(const r of gs(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const s=n.Le(r.kind);yu.pe.oe(t,s)}return n.$e()}sn(t){const e=new Tu;return yu.pe.oe(t,e.Le(0)),e.$e()}cn(t,e){const n=new Tu;return yu.pe.oe(Wi(this.databaseId,e),n.Le(function(t){const e=gs(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.$e()}en(t,e,n){if(null===n)return[];let r=[];r.push(new Tu);let s=0;for(const i of gs(t)){const t=n[s++];for(const n of r)if(this.an(e,i.fieldPath)&&Xi(t))r=this.hn(r,i,t);else{const e=n.Le(i.kind);yu.pe.oe(t,e)}}return this.ln(r)}tn(t,e,n){return this.en(t,e,n.position)}ln(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].$e();return e}hn(t,e,n){const r=[...t],s=[];for(const t of n.arrayValue.values||[])for(const n of r){const r=new Tu;r.seed(n.$e()),yu.pe.oe(t,r.Le(e.kind)),s.push(r)}return s}an(t,e){return!!t.filters.find((t=>t instanceof yo&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=zu(t),r=ju(t);return(e?n.j("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.j()).next((t=>{const e=[];return xs.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new vs(e.sequenceNumber,new Es(su(e.readTime),new ds($s(e.documentKey)),e.largestBatchId)):vs.empty(),r=t.fields.map((([t,e])=>new ys(hs.fromServerFormat(t),e)));return new fs(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:rs(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=zu(t),s=ju(t);return this.fn(t).next((t=>r.j("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>xs.forEach(e,(e=>s.put(hu(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return xs.forEach(e,((e,r)=>{const s=n.get(e.collectionGroup);return(s?xs.resolve(s):this.getFieldIndexes(t,e.collectionGroup)).next((s=>(n.set(e.collectionGroup,s),xs.forEach(s,(n=>this.dn(t,e,n).next((e=>{const s=this.wn(r,n);return e.isEqual(s)?xs.resolve():this._n(t,r,n,e,s)})))))))}))}mn(t,e,n,r){return Gu(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.cn(n,e.key),documentKey:e.key.path.toArray()})}gn(t,e,n,r){return Gu(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.cn(n,e.key),e.key.path.toArray()])}dn(t,e,n){const r=Gu(t);let s=new Si(_u);return r.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.cn(n,e)])},((t,r)=>{s=s.add(new Su(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>s))}wn(t,e){let n=new Si(_u);const r=this.un(e,t);if(null==r)return n;const s=ms(e);if(null!=s){const i=t.data.field(s.fieldPath);if(Xi(i))for(const s of i.arrayValue.values||[])n=n.add(new Su(e.indexId,t.key,this.sn(s),r))}else n=n.add(new Su(e.indexId,t.key,Bu,r));return n}_n(t,e,n,r,s){Or("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,r,s){const i=t.getIterator(),o=e.getIterator();let a=Di(i),c=Di(o);for(;a||c;){let t=!1,e=!1;if(a&&c){const r=n(a,c);r<0?e=!0:r>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(c),c=Di(o)):e?(s(a),a=Di(i)):(a=Di(i),c=Di(o))}}(r,s,_u,(r=>{i.push(this.mn(t,e,n,r))}),(r=>{i.push(this.gn(t,e,n,r))})),xs.waitFor(i)}fn(t){let e=1;return ju(t).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>_u(t,e))).filter(((t,e,n)=>!e||0!==_u(t,n[e-1])));const r=[];r.push(t);for(const s of n){const n=_u(s,t),i=_u(s,e);if(0===n)r[0]=t.qe();else if(n>0&&i<0)r.push(s),r.push(s.qe());else if(i>0)break}r.push(e);const s=[];for(let t=0;t<r.length;t+=2){if(this.yn(r[t],r[t+1]))return[];const e=[r[t].indexId,this.uid,r[t].arrayValue,r[t].directionalValue,Bu,[]],n=[r[t+1].indexId,this.uid,r[t+1].arrayValue,r[t+1].directionalValue,Bu,[]];s.push(IDBKeyRange.bound(e,n))}return s}yn(t,e){return _u(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(Ku)}getMinOffset(t,e){return xs.mapArray(this.Ze(e),(e=>this.Xe(t,e).next((t=>t||Br())))).next(Ku)}}function Uu(t){return yi(t,"collectionParents")}function Gu(t){return yi(t,"indexEntries")}function zu(t){return yi(t,"indexConfiguration")}function ju(t){return yi(t,"indexState")}function Ku(t){qr(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const s=t[r].indexState.offset;Ts(s,e)<0&&(e=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Es(e.readTime,e.documentKey,n)}const $u={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Qu{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Qu(t,Qu.DEFAULT_COLLECTION_PERCENTILE,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Hu(t,e,n){const r=t.store("mutations"),s=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.Z({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{qr(1===a)})));const u=[];for(const t of n.mutations){const r=Ws(e,t.key.path,n.batchId);i.push(s.delete(r)),u.push(t.key)}return xs.waitFor(i).next((()=>u))}function Wu(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Br();e=t.noDocument}return JSON.stringify(e).length}Qu.DEFAULT_COLLECTION_PERCENTILE=10,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Qu.DEFAULT=new Qu(41943040,Qu.DEFAULT_COLLECTION_PERCENTILE,Qu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Qu.DISABLED=new Qu(-1,0,0);class Yu{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.pn={}}static ie(t,e,n,r){qr(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new Yu(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ju(t).Z({index:"userMutationsIndex",range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=Zu(t),i=Ju(t);return i.add({}).next((o=>{qr("number"==typeof o);const a=new Za(o,e,n,r),c=function(t,e,n){const r=n.baseMutations.map((e=>Bc(t.se,e))),s=n.mutations.map((e=>Bc(t.se,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new Si(((t,e)=>rs(t.canonicalString(),e.canonicalString())));for(const t of r){const e=Ws(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),u.push(i.put(c)),u.push(s.put(e,Ys))}return l.forEach((e=>{u.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.pn[o]=a.keys()})),xs.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return Ju(t).get(e).next((t=>t?(qr(t.userId===this.userId),iu(this.serializer,t)):null))}In(t,e){return this.pn[e]?xs.resolve(this.pn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.pn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Ju(t).Z({index:"userMutationsIndex",range:r},((t,e,r)=>{e.userId===this.userId&&(qr(e.batchId>=n),s=iu(this.serializer,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Ju(t).Z({index:"userMutationsIndex",range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ju(t).j("userMutationsIndex",e).next((t=>t.map((t=>iu(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=Hs(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return Zu(t).Z({range:r},((n,r,i)=>{const[o,a,c]=n,u=$s(a);if(o===this.userId&&e.path.isEqual(u))return Ju(t).get(c).next((t=>{if(!t)throw Br();qr(t.userId===this.userId),s.push(iu(this.serializer,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Si(rs);const r=[];return e.forEach((e=>{const s=Hs(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=Zu(t).Z({range:i},((t,r,s)=>{const[i,o,a]=t,c=$s(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),xs.waitFor(r).next((()=>this.Tn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=Hs(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Si(rs);return Zu(t).Z({range:i},((t,e,s)=>{const[i,a,c]=t,u=$s(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Tn(t,o)))}Tn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(Ju(t).get(e).next((t=>{if(null===t)throw Br();qr(t.userId===this.userId),n.push(iu(this.serializer,t))})))})),xs.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return Hu(t.at,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.En(e.batchId)})),xs.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}En(t){delete this.pn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return xs.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return Zu(t).Z({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=$s(t[1]);r.push(e)}else n.done()})).next((()=>{qr(0===r.length)}))}))}containsKey(t,e){return Xu(t,this.userId,e)}An(t){return tl(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Xu(t,e,n){const r=Hs(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Zu(t).Z({range:i,Y:!0},((t,n,r)=>{const[i,a,c]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function Ju(t){return yi(t,"mutations")}function Zu(t){return yi(t,"documentMutations")}function tl(t){return yi(t,"mutationQueues")}class el{constructor(t){this.Rn=t}next(){return this.Rn+=2,this.Rn}static vn(){return new el(0)}static bn(){return new el(-1)}}class nl{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Pn(t).next((e=>{const n=new el(e.highestTargetId);return e.highestTargetId=n.next(),this.Vn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Pn(t).next((t=>as.fromTimestamp(new os(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Pn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Pn(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.Vn(t,r))))}addTargetData(t,e){return this.Sn(t,e).next((()=>this.Pn(t).next((n=>(n.targetCount+=1,this.Dn(e,n),this.Vn(t,n))))))}updateTargetData(t,e){return this.Sn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>rl(t).delete(e.targetId))).next((()=>this.Pn(t))).next((e=>(qr(e.targetCount>0),e.targetCount-=1,this.Vn(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return rl(t).Z(((i,o)=>{const a=ou(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>xs.waitFor(s))).next((()=>r))}forEachTarget(t,e){return rl(t).Z(((t,n)=>{const r=ou(n);e(r)}))}Pn(t){return sl(t).get("targetGlobalKey").next((t=>(qr(null!==t),t)))}Vn(t,e){return sl(t).put("targetGlobalKey",e)}Sn(t,e){return rl(t).put(au(this.serializer,e))}Dn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Pn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Po(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return rl(t).Z({range:r,index:"queryTargetsIndex"},((t,n,r)=>{const i=ou(n);Vo(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=il(t);return e.forEach((e=>{const i=zs(e.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(t,n,e))})),xs.waitFor(r)}removeMatchingKeys(t,e,n){const r=il(t);return xs.forEach(e,(e=>{const s=zs(e.path);return xs.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=il(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=il(t);let s=wa();return r.Z({range:n,Y:!0},((t,e,n)=>{const r=$s(t[1]),i=new ds(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=zs(e.path),r=IDBKeyRange.bound([n],[is(n)],!1,!0);let s=0;return il(t).Z({index:"documentTargetsIndex",Y:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}ne(t,e){return rl(t).get(e).next((t=>t?ou(t):null))}}function rl(t){return yi(t,"targets")}function sl(t){return yi(t,"targetGlobal")}function il(t){return yi(t,"targetDocuments")}function ol([t,e],[n,r]){const s=rs(t,n);return 0===s?rs(e,r):s}class al{constructor(t){this.Cn=t,this.buffer=new Si(ol),this.xn=0}Nn(){return++this.xn}kn(t){const e=[t,this.Nn()];if(this.buffer.size<this.Cn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();ol(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class cl{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.On=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.$n(6e4)}stop(){this.On&&(this.On.cancel(),this.On=null)}get started(){return null!==this.On}$n(t){Or("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.On=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.On=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Rs(t)?Or("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Ds(t)}await this.$n(3e5)}))}}class ul{constructor(t,e){this.Mn=t,this.params=e}calculateTargetCount(t,e){return this.Mn.Fn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return xs.resolve(Bs.ct);const n=new al(e);return this.Mn.forEachTarget(t,(t=>n.kn(t.sequenceNumber))).next((()=>this.Mn.Bn(t,(t=>n.kn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.Mn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.Mn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Or("LruGarbageCollector","Garbage collection skipped; disabled"),xs.resolve($u)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Or("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),$u):this.Ln(t,e)))}getCacheSize(t){return this.Mn.getCacheSize(t)}Ln(t,e){let n,r,s,i,o,a,c;const u=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Or("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),Mr()<=T.DEBUG&&Or("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-u}ms\n\tDetermined least recently used ${r} in `+(o-i)+"ms\n"+`\tRemoved ${s} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(c-a)+"ms\n"+`Total Duration: ${c-u}ms`),xs.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}class ll{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new ul(t,e)}(this,e)}Fn(t){const e=this.qn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}qn(t){let e=0;return this.Bn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Bn(t,e){return this.Un(t,((t,n)=>e(n)))}addReference(t,e,n){return hl(t,n)}removeReference(t,e,n){return hl(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return hl(t,e)}Kn(t,e){return function(t,e){let n=!1;return tl(t).X((r=>Xu(t,r,e).next((t=>(t&&(n=!0),xs.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Un(t,((i,o)=>{if(o<=e){const e=this.Kn(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i,as.min()),il(t).delete([0,zs(i.path)]))))}));r.push(e)}})).next((()=>xs.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return hl(t,e)}Un(t,e){const n=il(t);let r,s=Bs.ct;return n.Z({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==Bs.ct&&e(new ds($s(r)),s),s=o,r=i):s=Bs.ct})).next((()=>{s!==Bs.ct&&e(new ds($s(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function hl(t,e){return il(t).put(function(t,e){return{targetId:0,path:zs(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class dl{constructor(){this.changes=new aa((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,uo.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?xs.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class fl{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return yl(t).put(n)}removeEntry(t,e,n){return yl(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],nu(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Gn(t,n))))}getEntry(t,e){let n=uo.newInvalidDocument(e);return yl(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(wl(e))},((t,r)=>{n=this.Qn(e,r)})).next((()=>n))}zn(t,e){let n={size:0,document:uo.newInvalidDocument(e)};return yl(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(wl(e))},((t,r)=>{n={document:this.Qn(e,r),size:Wu(r)}})).next((()=>n))}getEntries(t,e){let n=ua();return this.jn(t,e,((t,e)=>{const r=this.Qn(t,e);n=n.insert(t,r)})).next((()=>n))}Wn(t,e){let n=ua(),r=new bi(ds.comparator);return this.jn(t,e,((t,e)=>{const s=this.Qn(t,e);n=n.insert(t,s),r=r.insert(t,Wu(e))})).next((()=>({documents:n,Hn:r})))}jn(t,e,n){if(e.isEmpty())return xs.resolve();let r=new Si(Il);e.forEach((t=>r=r.add(t)));const s=IDBKeyRange.bound(wl(r.first()),wl(r.last())),i=r.getIterator();let o=i.getNext();return yl(t).Z({index:"documentKeyIndex",range:s},((t,e,r)=>{const s=ds.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Il(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.G(wl(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r){const s=e.path,i=[s.popLast().toArray(),s.lastSegment(),nu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return yl(t).j(IDBKeyRange.bound(i,o,!0)).next((t=>{let n=ua();for(const s of t){const t=this.Qn(ds.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);t.isFoundDocument()&&(ra(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let s=ua();const i=vl(e,n),o=vl(e,Es.max());return yl(t).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.Qn(ds.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(t){return new gl(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return pl(t).get("remoteDocumentGlobalKey").next((t=>(qr(!!t),t)))}Gn(t,e){return pl(t).put("remoteDocumentGlobalKey",e)}Qn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Vc(t.se,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=ds.fromSegments(e.noDocument.path),r=su(e.noDocument.readTime);n=uo.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Br();{const t=ds.fromSegments(e.unknownDocument.path),r=su(e.unknownDocument.version);n=uo.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new os(t[0],t[1]);return as.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(as.min()))return t}return uo.newInvalidDocument(t)}}function ml(t){return new fl(t)}class gl extends dl{constructor(t,e){super(),this.Jn=t,this.trackRemovals=e,this.Yn=new aa((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new Si(((t,e)=>rs(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Yn.get(s);if(e.push(this.Jn.removeEntry(t,s,o.readTime)),i.isValidDocument()){const a=eu(this.Jn.serializer,i);r=r.add(s.path.popLast());const c=Wu(a);n+=c-o.size,e.push(this.Jn.addEntry(t,s,a))}else if(n-=o.size,this.trackRemovals){const n=eu(this.Jn.serializer,i.convertToNoDocument(as.min()));e.push(this.Jn.addEntry(t,s,n))}})),r.forEach((n=>{e.push(this.Jn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Jn.updateMetadata(t,n)),xs.waitFor(e)}getFromCache(t,e){return this.Jn.zn(t,e).next((t=>(this.Yn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Jn.Wn(t,e).next((({documents:t,Hn:e})=>(e.forEach(((e,n)=>{this.Yn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function pl(t){return yi(t,"remoteDocumentGlobal")}function yl(t){return yi(t,"remoteDocumentsV14")}function wl(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function vl(t,e){const n=e.documentKey.path.toArray();return[t,nu(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Il(t,e){const n=t.path.toArray(),r=e.path.toArray();let s=0;for(let t=0;t<n.length-2&&t<r.length-2;++t)if(s=rs(n[t],r[t]),s)return s;return s=rs(n.length,r.length),s||(s=rs(n[n.length-2],r[r.length-2]),s||rs(n[n.length-1],r[r.length-1]))}class bl{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class El{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&za(n.mutation,t,xi.empty(),os.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,wa()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=wa()){const r=fa();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=ha();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=fa();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,wa())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let s=ua();const i=ga(),o=ga();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof Qa)?s=s.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),za(o.mutation,e,o.mutation.getFieldMask(),os.now())):i.set(e.key,xi.empty())})),this.recalculateAndSaveOverlays(t,s).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new bl(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=ga();let r=new bi(((t,e)=>t-e)),s=wa();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const s of t)s.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||xi.empty();o=s.applyToLocalView(i,o),n.set(t,o);const a=(r.get(s.batchId)||wa()).add(t);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=ma();c.forEach((t=>{if(!s.has(t)){const r=Ua(e.get(t),n.get(t));null!==r&&u.set(t,r),s=s.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,u))}return xs.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return ds.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Wo(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-s.size):xs.resolve(fa());let o=-1,a=s;return i.next((e=>xs.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(e)?xs.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,s))).next((()=>this.computeViews(t,a,e,wa()))).next((t=>({batchId:o,changes:da(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new ds(e)).next((t=>{let e=ha();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const r=e.collectionGroup;let s=ha();return this.indexManager.getCollectionParents(t,r).next((i=>xs.forEach(i,(i=>{const o=function(t,e){return new zo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(r));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{s=s.insert(t,e)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(t,e,n){let r;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((s=>(r=s,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,r)))).next((t=>{r.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,uo.newInvalidDocument(r)))}));let n=ha();return t.forEach(((t,s)=>{const i=r.get(t);void 0!==i&&za(i.mutation,s,xi.empty(),os.now()),ra(e,s)&&(n=n.insert(t,s))})),n}))}}class Tl{constructor(t){this.serializer=t,this.Zn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return xs.resolve(this.Zn.get(e))}saveBundleMetadata(t,e){var n;return this.Zn.set(e.id,{id:(n=e).id,version:n.version,createTime:Ac(n.createTime)}),xs.resolve()}getNamedQuery(t,e){return xs.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,function(t){return{name:t.name,query:cu(t.bundledQuery),readTime:Ac(t.readTime)}}(e)),xs.resolve()}}class Sl{constructor(){this.overlays=new bi(ds.comparator),this.ts=new Map}getOverlay(t,e){return xs.resolve(this.overlays.get(e))}getOverlays(t,e){const n=fa();return xs.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.re(t,e,r)})),xs.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.ts.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.ts.delete(n)),xs.resolve()}getOverlaysForCollection(t,e,n){const r=fa(),s=e.length+1,i=new ds(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return xs.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new bi(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=fa(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=fa(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return xs.resolve(o)}re(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.ts.get(r.largestBatchId).delete(n.key);this.ts.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new ec(e,n));let s=this.ts.get(e);void 0===s&&(s=wa(),this.ts.set(e,s)),this.ts.set(e,s.add(n.key))}}class _l{constructor(){this.es=new Si(Dl.ns),this.ss=new Si(Dl.rs)}isEmpty(){return this.es.isEmpty()}addReference(t,e){const n=new Dl(t,e);this.es=this.es.add(n),this.ss=this.ss.add(n)}os(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.us(new Dl(t,e))}cs(t,e){t.forEach((t=>this.removeReference(t,e)))}hs(t){const e=new ds(new us([])),n=new Dl(e,t),r=new Dl(e,t+1),s=[];return this.ss.forEachInRange([n,r],(t=>{this.us(t),s.push(t.key)})),s}ls(){this.es.forEach((t=>this.us(t)))}us(t){this.es=this.es.delete(t),this.ss=this.ss.delete(t)}fs(t){const e=new ds(new us([])),n=new Dl(e,t),r=new Dl(e,t+1);let s=wa();return this.ss.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Dl(t,0),n=this.es.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Dl{constructor(t,e){this.key=t,this.ds=e}static ns(t,e){return ds.comparator(t.key,e.key)||rs(t.ds,e.ds)}static rs(t,e){return rs(t.ds,e.ds)||ds.comparator(t.key,e.key)}}class xl{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.ws=1,this._s=new Si(Dl.ns)}checkEmpty(t){return xs.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const s=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Za(s,e,n,r);this.mutationQueue.push(i);for(const e of r)this._s=this._s.add(new Dl(e.key,s)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return xs.resolve(i)}lookupMutationBatch(t,e){return xs.resolve(this.gs(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.ys(n),s=r<0?0:r;return xs.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return xs.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(t){return xs.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Dl(e,0),r=new Dl(e,Number.POSITIVE_INFINITY),s=[];return this._s.forEachInRange([n,r],(t=>{const e=this.gs(t.ds);s.push(e)})),xs.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Si(rs);return e.forEach((t=>{const e=new Dl(t,0),r=new Dl(t,Number.POSITIVE_INFINITY);this._s.forEachInRange([e,r],(t=>{n=n.add(t.ds)}))})),xs.resolve(this.ps(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;ds.isDocumentKey(s)||(s=s.child(""));const i=new Dl(new ds(s),0);let o=new Si(rs);return this._s.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.ds)),!0)}),i),xs.resolve(this.ps(o))}ps(t){const e=[];return t.forEach((t=>{const n=this.gs(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){qr(0===this.Is(e.batchId,"removed")),this.mutationQueue.shift();let n=this._s;return xs.forEach(e.mutations,(r=>{const s=new Dl(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this._s=n}))}En(t){}containsKey(t,e){const n=new Dl(e,0),r=this._s.firstAfterOrEqual(n);return xs.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,xs.resolve()}Is(t,e){return this.ys(t)}ys(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}gs(t){const e=this.ys(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Al{constructor(t){this.Ts=t,this.docs=new bi(ds.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.Ts(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return xs.resolve(n?n.document.mutableCopy():uo.newInvalidDocument(e))}getEntries(t,e){let n=ua();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():uo.newInvalidDocument(t))})),xs.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let s=ua();const i=e.path,o=new ds(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||Ts(bs(o),n)<=0||(r.has(o.key)||ra(e,o))&&(s=s.insert(o.key,o.mutableCopy()))}return xs.resolve(s)}getAllFromCollectionGroup(t,e,n,r){Br()}Es(t,e){return xs.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Cl(this)}getSize(t){return xs.resolve(this.size)}}class Cl extends dl{constructor(t){super(),this.Jn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.Jn.addEntry(t,r)):this.Jn.removeEntry(n)})),xs.waitFor(e)}getFromCache(t,e){return this.Jn.getEntry(t,e)}getAllFromCache(t,e){return this.Jn.getEntries(t,e)}}class Nl{constructor(t){this.persistence=t,this.As=new aa((t=>Po(t)),Vo),this.lastRemoteSnapshotVersion=as.min(),this.highestTargetId=0,this.Rs=0,this.vs=new _l,this.targetCount=0,this.bs=el.vn()}forEachTarget(t,e){return this.As.forEach(((t,n)=>e(n))),xs.resolve()}getLastRemoteSnapshotVersion(t){return xs.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return xs.resolve(this.Rs)}allocateTargetId(t){return this.highestTargetId=this.bs.next(),xs.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Rs&&(this.Rs=e),xs.resolve()}Sn(t){this.As.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.bs=new el(e),this.highestTargetId=e),t.sequenceNumber>this.Rs&&(this.Rs=t.sequenceNumber)}addTargetData(t,e){return this.Sn(e),this.targetCount+=1,xs.resolve()}updateTargetData(t,e){return this.Sn(e),xs.resolve()}removeTargetData(t,e){return this.As.delete(e.target),this.vs.hs(e.targetId),this.targetCount-=1,xs.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.As.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.As.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),xs.waitFor(s).next((()=>r))}getTargetCount(t){return xs.resolve(this.targetCount)}getTargetData(t,e){const n=this.As.get(e)||null;return xs.resolve(n)}addMatchingKeys(t,e,n){return this.vs.os(e,n),xs.resolve()}removeMatchingKeys(t,e,n){this.vs.cs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),xs.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.vs.hs(e),xs.resolve()}getMatchingKeysForTargetId(t,e){const n=this.vs.fs(e);return xs.resolve(n)}containsKey(t,e){return xs.resolve(this.vs.containsKey(e))}}class kl{constructor(t,e){this.Ps={},this.overlays={},this.Vs=new Bs(0),this.Ss=!1,this.Ss=!0,this.referenceDelegate=t(this),this.Ds=new Nl(this),this.indexManager=new Pu,this.remoteDocumentCache=function(t){return new Al(t)}((t=>this.referenceDelegate.Cs(t))),this.serializer=new tu(e),this.xs=new Tl(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Ss=!1,Promise.resolve()}get started(){return this.Ss}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Sl,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Ps[t.toKey()];return n||(n=new xl(e,this.referenceDelegate),this.Ps[t.toKey()]=n),n}getTargetCache(){return this.Ds}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.xs}runTransaction(t,e,n){Or("MemoryPersistence","Starting transaction:",t);const r=new Rl(this.Vs.next());return this.referenceDelegate.Ns(),n(r).next((t=>this.referenceDelegate.ks(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Os(t,e){return xs.or(Object.values(this.Ps).map((n=>()=>n.containsKey(t,e))))}}class Rl extends _s{constructor(t){super(),this.currentSequenceNumber=t}}class Ml{constructor(t){this.persistence=t,this.$s=new _l,this.Ms=null}static Fs(t){return new Ml(t)}get Bs(){if(this.Ms)return this.Ms;throw Br()}addReference(t,e,n){return this.$s.addReference(n,e),this.Bs.delete(n.toString()),xs.resolve()}removeReference(t,e,n){return this.$s.removeReference(n,e),this.Bs.add(n.toString()),xs.resolve()}markPotentiallyOrphaned(t,e){return this.Bs.add(e.toString()),xs.resolve()}removeTarget(t,e){this.$s.hs(e.targetId).forEach((t=>this.Bs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Bs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ns(){this.Ms=new Set}ks(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return xs.forEach(this.Bs,(n=>{const r=ds.fromPath(n);return this.Ls(t,r).next((t=>{t||e.removeEntry(r,as.min())}))})).next((()=>(this.Ms=null,e.apply(t))))}updateLimboDocument(t,e){return this.Ls(t,e).next((t=>{t?this.Bs.delete(e.toString()):this.Bs.add(e.toString())}))}Cs(t){return 0}Ls(t,e){return xs.or([()=>xs.resolve(this.$s.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Os(t,e)])}}class Ll{constructor(t){this.serializer=t}M(t,e,n,r){const s=new As("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Qs,{unique:!0}),t.createObjectStore("documentMutations")}(t),Ol(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=xs.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Ol(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:as.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").j().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Qs,{unique:!0});const r=e.store("mutations"),s=n.map((t=>r.put(t)));return xs.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.qs(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Us(s))))),n<7&&r>=7&&(i=i.next((()=>this.Ks(s)))),n<8&&r>=8&&(i=i.next((()=>this.Gs(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.Qs(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&r>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:ci});e.createIndex("collectionPathOverlayIndex",ui,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",li,{unique:!1})}(t)}))),n<13&&r>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Xs});e.createIndex("documentKeyIndex",Js),e.createIndex("collectionGroupIndex",Zs)}(t))).next((()=>this.zs(t,s))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.js(t,s)))),n<15&&r>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:si}).createIndex("sequenceNumberIndex",ii,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:oi}).createIndex("documentKeyIndex",ai,{unique:!1})}(t)))),i}Us(t){let e=0;return t.store("remoteDocuments").Z(((t,n)=>{e+=Wu(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}qs(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.j().next((e=>xs.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",r).next((n=>xs.forEach(n,(n=>{qr(n.userId===e.userId);const r=iu(this.serializer,n);return Hu(t,e.userId,r).next((()=>{}))}))))}))))}Ks(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const r=[];return n.Z(((n,s)=>{const i=new us(n),o=function(t){return[0,zs(t)]}(i);r.push(e.get(o).next((n=>n?xs.resolve():(n=>e.put({targetId:0,path:zs(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>xs.waitFor(r)))}))}Gs(t,e){t.createObjectStore("collectionParents",{keyPath:ri});const n=e.store("collectionParents"),r=new Vu,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:zs(r)})}};return e.store("remoteDocuments").Z({Y:!0},((t,e)=>{const n=new us(t);return s(n.popLast())})).next((()=>e.store("documentMutations").Z({Y:!0},(([t,e,n],r)=>{const i=$s(e);return s(i.popLast())}))))}Qs(t){const e=t.store("targets");return e.Z(((t,n)=>{const r=ou(n),s=au(this.serializer,r);return e.put(s)}))}zs(t,e){const n=e.store("remoteDocuments"),r=[];return n.Z(((t,n)=>{const s=e.store("remoteDocumentsV14"),i=(o=n,o.document?new ds(us.fromString(o.document.name).popFirst(5)):o.noDocument?ds.fromSegments(o.noDocument.path):o.unknownDocument?ds.fromSegments(o.unknownDocument.path):Br()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>xs.waitFor(r)))}js(t,e){const n=e.store("mutations"),r=ml(this.serializer),s=new kl(Ml.Fs,this.serializer.se);return n.j().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:wa();iu(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),xs.forEach(n,((t,n)=>{const i=new Nr(n),o=gu.ie(this.serializer,i),a=s.getIndexManager(i),c=Yu.ie(i,this.serializer,a,s.referenceDelegate);return new El(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new pi(e,Bs.ct),t).next()}))}))}}function Ol(t){t.createObjectStore("targetDocuments",{keyPath:ei}).createIndex("documentTargetsIndex",ni,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ti,{unique:!0}),t.createObjectStore("targetGlobal")}const Fl="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Pl{constructor(t,e,n,r,s,i,o,a,c,u,l=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Ws=s,this.window=i,this.document=o,this.Hs=c,this.Js=u,this.Ys=l,this.Vs=null,this.Ss=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.Xs=null,this.ti=null,this.ei=Number.NEGATIVE_INFINITY,this.ni=t=>Promise.resolve(),!Pl.D())throw new jr(zr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ll(this,r),this.si=e+"main",this.serializer=new tu(a),this.ii=new Cs(this.si,this.Ys,new Ll(this.serializer)),this.Ds=new nl(this.referenceDelegate,this.serializer),this.remoteDocumentCache=ml(this.serializer),this.xs=new du,this.window&&this.window.localStorage?this.ri=this.window.localStorage:(this.ri=null,!1===u&&Fr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.oi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new jr(zr.FAILED_PRECONDITION,Fl);return this.ui(),this.ci(),this.ai(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Ds.getHighestSequenceNumber(t)))})).then((t=>{this.Vs=new Bs(t,this.Hs)})).then((()=>{this.Ss=!0})).catch((t=>(this.ii&&this.ii.close(),Promise.reject(t))))}hi(t){return this.ni=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ii.B((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Ws.enqueueAndForget((async()=>{this.started&&await this.oi()})))}oi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Bl(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.li(t).next((t=>{t||(this.isPrimary=!1,this.Ws.enqueueRetryable((()=>this.ni(!1))))}))})).next((()=>this.fi(t))).next((e=>this.isPrimary&&!e?this.di(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(Rs(t))return Or("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Or("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Ws.enqueueRetryable((()=>this.ni(t))),this.isPrimary=t}))}li(t){return Vl(t).get("owner").next((t=>xs.resolve(this._i(t))))}mi(t){return Bl(t).delete(this.clientId)}async gi(){if(this.isPrimary&&!this.yi(this.ei,18e5)){this.ei=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=yi(t,"clientMetadata");return e.j().next((t=>{const n=this.pi(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return xs.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.ri)for(const e of t)this.ri.removeItem(this.Ii(e.clientId))}}ai(){this.ti=this.Ws.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.oi().then((()=>this.gi())).then((()=>this.ai()))))}_i(t){return!!t&&t.ownerId===this.clientId}fi(t){return this.Js?xs.resolve(!0):Vl(t).get("owner").next((e=>{if(null!==e&&this.yi(e.leaseTimestampMs,5e3)&&!this.Ti(e.ownerId)){if(this._i(e)&&this.networkEnabled)return!0;if(!this._i(e)){if(!e.allowTabSynchronization)throw new jr(zr.FAILED_PRECONDITION,Fl);return!1}}return!(!this.networkEnabled||!this.inForeground)||Bl(t).j().next((t=>void 0===this.pi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Or("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ss=!1,this.Ei(),this.ti&&(this.ti.cancel(),this.ti=null),this.Ai(),this.Ri(),await this.ii.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new pi(t,Bs.ct);return this.di(e).next((()=>this.mi(e)))})),this.ii.close(),this.vi()}pi(t,e){return t.filter((t=>this.yi(t.updateTimeMs,e)&&!this.Ti(t.clientId)))}bi(){return this.runTransaction("getActiveClients","readonly",(t=>Bl(t).j().next((t=>this.pi(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ss}getMutationQueue(t,e){return Yu.ie(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Ds}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new qu(t,this.serializer.se.databaseId)}getDocumentOverlayCache(t){return gu.ie(this.serializer,t)}getBundleCache(){return this.xs}runTransaction(t,e,n){Or("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",s=15===(i=this.Ys)?gi:14===i?mi:13===i?fi:12===i?di:11===i?hi:void Br();var i;let o;return this.ii.runTransaction(t,r,s,(r=>(o=new pi(r,this.Vs?this.Vs.next():Bs.ct),"readwrite-primary"===e?this.li(o).next((t=>!!t||this.fi(o))).next((e=>{if(!e)throw Fr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Ws.enqueueRetryable((()=>this.ni(!1))),new jr(zr.FAILED_PRECONDITION,Ss);return n(o)})).next((t=>this.wi(o).next((()=>t)))):this.Pi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}Pi(t){return Vl(t).get("owner").next((t=>{if(null!==t&&this.yi(t.leaseTimestampMs,5e3)&&!this.Ti(t.ownerId)&&!this._i(t)&&!(this.Js||this.allowTabSynchronization&&t.allowTabSynchronization))throw new jr(zr.FAILED_PRECONDITION,Fl)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Vl(t).put("owner",e)}static D(){return Cs.D()}di(t){const e=Vl(t);return e.get("owner").next((t=>this._i(t)?(Or("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):xs.resolve()))}yi(t,e){const n=Date.now();return!(t<n-e||t>n&&(Fr(`Detected an update time that is in the future: ${t} > ${n}`),1))}ui(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Xs=()=>{this.Ws.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.oi())))},this.document.addEventListener("visibilitychange",this.Xs),this.inForeground="visible"===this.document.visibilityState)}Ai(){this.Xs&&(this.document.removeEventListener("visibilitychange",this.Xs),this.Xs=null)}ci(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Zs=()=>{this.Ei();const t=/(?:Version|Mobile)\/1[456]/;g()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.Ws.enterRestrictedMode(!0),this.Ws.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}Ri(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ti(t){var e;try{const n=null!==(null===(e=this.ri)||void 0===e?void 0:e.getItem(this.Ii(t)));return Or("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Fr("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ei(){if(this.ri)try{this.ri.setItem(this.Ii(this.clientId),String(Date.now()))}catch(t){Fr("Failed to set zombie client id.",t)}}vi(){if(this.ri)try{this.ri.removeItem(this.Ii(this.clientId))}catch(t){}}Ii(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Vl(t){return yi(t,"owner")}function Bl(t){return yi(t,"clientMetadata")}function ql(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Ul{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Vi=n,this.Si=r}static Di(t,e){let n=wa(),r=wa();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new Ul(t,e.fromCache,n,r)}}class Gl{constructor(){this.Ci=!1}initialize(t,e){this.xi=t,this.indexManager=e,this.Ci=!0}getDocumentsMatchingQuery(t,e,n,r){return this.Ni(t,e).next((s=>s||this.ki(t,e,r,n))).next((n=>n||this.Oi(t,e)))}Ni(t,e){if($o(e))return xs.resolve(null);let n=Xo(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=Zo(e,null,"F"),n=Xo(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const s=wa(...r);return this.xi.getDocuments(t,s).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.$i(e,r);return this.Mi(e,i,s,n.readTime)?this.Ni(t,Zo(e,null,"F")):this.Fi(t,i,e,n)}))))})))))}ki(t,e,n,r){return $o(e)||r.isEqual(as.min())?this.Oi(t,e):this.xi.getDocuments(t,n).next((s=>{const i=this.$i(e,s);return this.Mi(e,i,n,r)?this.Oi(t,e):(Mr()<=T.DEBUG&&Or("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),na(e)),this.Fi(t,i,e,Is(r,-1)))}))}$i(t,e){let n=new Si(ia(t));return e.forEach(((e,r)=>{ra(t,r)&&(n=n.add(r))})),n}Mi(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const s="F"===t.limitType?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Oi(t,e){return Mr()<=T.DEBUG&&Or("QueryEngine","Using full collection scan to execute query:",na(e)),this.xi.getDocumentsMatchingQuery(t,e,Es.min())}Fi(t,e,n,r){return this.xi.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class zl{constructor(t,e,n,r){this.persistence=t,this.Bi=e,this.serializer=r,this.Li=new bi(rs),this.qi=new aa((t=>Po(t)),Vo),this.Ui=new Map,this.Ki=t.getRemoteDocumentCache(),this.Ds=t.getTargetCache(),this.xs=t.getBundleCache(),this.Gi(n)}Gi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new El(this.Ki,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ki.setIndexManager(this.indexManager),this.Bi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Li)))}}function jl(t,e,n,r){return new zl(t,e,n,r)}async function Kl(t,e){const n=Gr(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((s=>(r=s,n.Gi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const s=[],i=[];let o=wa();for(const t of r){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({Qi:t,removedBatchIds:s,addedBatchIds:i})))}))}))}function $l(t){const e=Gr(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Ds.getLastRemoteSnapshotVersion(t)))}function Ql(t,e,n){let r=wa(),s=wa();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=ua();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(as.min())?(e.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),r=r.insert(n,i)):Or("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{zi:r,ji:s}}))}function Hl(t,e){const n=Gr(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function Wl(t,e){const n=Gr(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Ds.getTargetData(t,e).next((s=>s?(r=s,xs.resolve(r)):n.Ds.allocateTargetId(t).next((s=>(r=new Zc(e,s,0,t.currentSequenceNumber),n.Ds.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.Li.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Li=n.Li.insert(t.targetId,t),n.qi.set(e,t.targetId)),t}))}async function Yl(t,e,n){const r=Gr(t),s=r.Li.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!Rs(t))throw t;Or("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Li=r.Li.remove(e),r.qi.delete(s.target)}function Xl(t,e,n){const r=Gr(t);let s=as.min(),i=wa();return r.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const r=Gr(t),s=r.qi.get(n);return void 0!==s?xs.resolve(r.Li.get(s)):r.Ds.getTargetData(e,n)}(r,t,Xo(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.Ds.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.Bi.getDocumentsMatchingQuery(t,e,n?s:as.min(),n?i:wa()))).next((t=>(th(r,sa(e),t),{documents:t,Wi:i})))))}function Jl(t,e){const n=Gr(t),r=Gr(n.Ds),s=n.Li.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r.ne(t,e).next((t=>t?t.target:null))))}function Zl(t,e){const n=Gr(t),r=n.Ui.get(e)||as.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Ki.getAllFromCollectionGroup(t,e,Is(r,-1),Number.MAX_SAFE_INTEGER))).then((t=>(th(n,e,t),t)))}function th(t,e,n){let r=t.Ui.get(e)||as.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.Ui.set(e,r)}async function eh(t,e,n=wa()){const r=await Wl(t,Xo(cu(e.bundledQuery))),s=Gr(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Ac(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.xs.saveNamedQuery(t,e);const o=r.withResumeToken(Ni.EMPTY_BYTE_STRING,i);return s.Li=s.Li.insert(o.targetId,o),s.Ds.updateTargetData(t,o).next((()=>s.Ds.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.Ds.addMatchingKeys(t,n,r.targetId))).next((()=>s.xs.saveNamedQuery(t,e)))}))}function nh(t,e){return`firestore_clients_${t}_${e}`}function rh(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function sh(t,e){return`firestore_targets_${t}_${e}`}class ih{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Zi(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new jr(r.error.code,r.error.message))),i?new ih(t,e,r.state,s):(Fr("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Xi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class oh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Zi(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new jr(n.error.code,n.error.message))),s?new oh(t,n.state,r):(Fr("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Xi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class ah{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Zi(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Ia();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Gs(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new ah(t,s):(Fr("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class ch{constructor(t,e){this.clientId=t,this.onlineState=e}static Zi(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new ch(e.clientId,e.onlineState):(Fr("SharedClientState",`Failed to parse online state: ${t}`),null)}}class uh{constructor(){this.activeTargetIds=Ia()}tr(t){this.activeTargetIds=this.activeTargetIds.add(t)}er(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Xi(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class lh{constructor(t,e,n,r,s){this.window=t,this.Ws=e,this.persistenceKey=n,this.nr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.sr=this.ir.bind(this),this.rr=new bi(rs),this.started=!1,this.ur=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.cr=nh(this.persistenceKey,this.nr),this.ar=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.rr=this.rr.insert(this.nr,new uh),this.hr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.lr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.dr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this._r=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.sr)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.bi();for(const e of t){if(e===this.nr)continue;const t=this.getItem(nh(this.persistenceKey,e));if(t){const n=ah.Zi(e,t);n&&(this.rr=this.rr.insert(n.clientId,n))}}this.mr();const e=this.storage.getItem(this.wr);if(e){const t=this.gr(e);t&&this.yr(t)}for(const t of this.ur)this.ir(t);this.ur=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.ar,JSON.stringify(t))}getAllActiveQueryTargets(){return this.pr(this.rr)}isActiveQueryTarget(t){let e=!1;return this.rr.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Ir(t,"pending")}updateMutationState(t,e,n){this.Ir(t,e,n),this.Tr(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(sh(this.persistenceKey,t));if(n){const r=oh.Zi(t,n);r&&(e=r.state)}}return this.Er.tr(t),this.mr(),e}removeLocalQueryTarget(t){this.Er.er(t),this.mr()}isLocalQueryTarget(t){return this.Er.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(sh(this.persistenceKey,t))}updateQueryState(t,e,n){this.Ar(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Tr(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Rr(t)}notifyBundleLoaded(t){this.vr(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.sr),this.removeItem(this.cr),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Or("SharedClientState","READ",t,e),e}setItem(t,e){Or("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Or("SharedClientState","REMOVE",t),this.storage.removeItem(t)}ir(t){const e=t;if(e.storageArea===this.storage){if(Or("SharedClientState","EVENT",e.key,e.newValue),e.key===this.cr)return void Fr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ws.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.hr.test(e.key)){if(null==e.newValue){const t=this.br(e.key);return this.Pr(t,null)}{const t=this.Vr(e.key,e.newValue);if(t)return this.Pr(t.clientId,t)}}else if(this.lr.test(e.key)){if(null!==e.newValue){const t=this.Sr(e.key,e.newValue);if(t)return this.Dr(t)}}else if(this.dr.test(e.key)){if(null!==e.newValue){const t=this.Cr(e.key,e.newValue);if(t)return this.Nr(t)}}else if(e.key===this.wr){if(null!==e.newValue){const t=this.gr(e.newValue);if(t)return this.yr(t)}}else if(e.key===this.ar){const t=function(t){let e=Bs.ct;if(null!=t)try{const n=JSON.parse(t);qr("number"==typeof n),e=n}catch(t){Fr("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Bs.ct&&this.sequenceNumberHandler(t)}else if(e.key===this._r){const t=this.kr(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Or(t))))}}else this.ur.push(e)}))}}get Er(){return this.rr.get(this.nr)}mr(){this.setItem(this.cr,this.Er.Xi())}Ir(t,e,n){const r=new ih(this.currentUser,t,e,n),s=rh(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Xi())}Tr(t){const e=rh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Rr(t){const e={clientId:this.nr,onlineState:t};this.storage.setItem(this.wr,JSON.stringify(e))}Ar(t,e,n){const r=sh(this.persistenceKey,t),s=new oh(t,e,n);this.setItem(r,s.Xi())}vr(t){const e=JSON.stringify(Array.from(t));this.setItem(this._r,e)}br(t){const e=this.hr.exec(t);return e?e[1]:null}Vr(t,e){const n=this.br(t);return ah.Zi(n,e)}Sr(t,e){const n=this.lr.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return ih.Zi(new Nr(s),r,e)}Cr(t,e){const n=this.dr.exec(t),r=Number(n[1]);return oh.Zi(r,e)}gr(t){return ch.Zi(t)}kr(t){return JSON.parse(t)}async Dr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.$r(t.batchId,t.state,t.error);Or("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Nr(t){return this.syncEngine.Mr(t.targetId,t.state,t.error)}Pr(t,e){const n=e?this.rr.insert(t,e):this.rr.remove(t),r=this.pr(this.rr),s=this.pr(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.Fr(i,o).then((()=>{this.rr=n}))}yr(t){this.rr.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}pr(t){let e=Ia();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class hh{constructor(){this.Br=new uh,this.Lr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Br.tr(t),this.Lr[t]||"not-current"}updateQueryState(t,e,n){this.Lr[t]=e}removeLocalQueryTarget(t){this.Br.er(t)}isLocalQueryTarget(t){return this.Br.activeTargetIds.has(t)}clearQueryState(t){delete this.Lr[t]}getAllActiveQueryTargets(){return this.Br.activeTargetIds}isActiveQueryTarget(t){return this.Br.activeTargetIds.has(t)}start(){return this.Br=new uh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class dh{qr(t){}shutdown(){}}class fh{constructor(){this.Ur=()=>this.Kr(),this.Gr=()=>this.Qr(),this.zr=[],this.jr()}qr(t){this.zr.push(t)}shutdown(){window.removeEventListener("online",this.Ur),window.removeEventListener("offline",this.Gr)}jr(){window.addEventListener("online",this.Ur),window.addEventListener("offline",this.Gr)}Kr(){Or("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.zr)t(0)}Qr(){Or("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.zr)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let mh=null;function gh(){return null===mh?mh=268435456+Math.round(2147483648*Math.random()):mh++,"0x"+mh.toString(16)}const ph={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class yh{constructor(t){this.Wr=t.Wr,this.Hr=t.Hr}Jr(t){this.Yr=t}Zr(t){this.Xr=t}onMessage(t){this.eo=t}close(){this.Hr()}send(t){this.Wr(t)}no(){this.Yr()}so(t){this.Xr(t)}io(t){this.eo(t)}}const wh="WebChannelConnection";class vh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.ro=e+"://"+t.host,this.oo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get uo(){return!1}co(t,e,n,r,s){const i=gh(),o=this.ao(t,e);Or("RestConnection",`Sending RPC '${t}' ${i}:`,o,n);const a={};return this.ho(a,r,s),this.lo(t,o,a,n).then((e=>(Or("RestConnection",`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw Pr("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}fo(t,e,n,r,s,i){return this.co(t,e,n,r,s)}ho(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+kr,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}ao(t,e){const n=ph[t];return`${this.ro}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}lo(t,e,n,r){const s=gh();return new Promise(((i,o)=>{const a=new Ar;a.setWithCredentials(!0),a.listenOnce(Er.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case br.NO_ERROR:const e=a.getResponseJson();Or(wh,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(e)),i(e);break;case br.TIMEOUT:Or(wh,`RPC '${t}' ${s} timed out`),o(new jr(zr.DEADLINE_EXCEEDED,"Request time out"));break;case br.HTTP_ERROR:const n=a.getStatus();if(Or(wh,`RPC '${t}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(zr).indexOf(e)>=0?e:zr.UNKNOWN}(e.status);o(new jr(t,e.message))}else o(new jr(zr.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new jr(zr.UNAVAILABLE,"Connection failed."));break;default:Br()}}finally{Or(wh,`RPC '${t}' ${s} completed.`)}}));const c=JSON.stringify(r);Or(wh,`RPC '${t}' ${s} sending request:`,r),a.send(e,"POST",c,n,15)}))}wo(t,e,n){const r=gh(),s=[this.ro,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=new pr,o=me(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new Dr({})),this.ho(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const c=s.join("");Or(wh,`Creating RPC '${t}' stream ${r}: ${c}`,a);const u=i.createWebChannel(c,a);let l=!1,h=!1;const d=new yh({Wr:e=>{h?Or(wh,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(l||(Or(wh,`Opening RPC '${t}' stream ${r} transport.`),u.open(),l=!0),Or(wh,`RPC '${t}' stream ${r} sending:`,e),u.send(e))},Hr:()=>u.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(u,xr.EventType.OPEN,(()=>{h||Or(wh,`RPC '${t}' stream ${r} transport opened.`)})),f(u,xr.EventType.CLOSE,(()=>{h||(h=!0,Or(wh,`RPC '${t}' stream ${r} transport closed`),d.so())})),f(u,xr.EventType.ERROR,(e=>{h||(h=!0,Pr(wh,`RPC '${t}' stream ${r} transport errored:`,e),d.so(new jr(zr.UNAVAILABLE,"The operation could not be completed")))})),f(u,xr.EventType.MESSAGE,(e=>{var n;if(!h){const s=e.data[0];qr(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){Or(wh,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=oc[t];if(void 0!==e)return uc(e)}(e),s=o.message;void 0===n&&(n=zr.INTERNAL,s="Unknown error status: "+e+" with message "+o.message),h=!0,d.so(new jr(n,s)),u.close()}else Or(wh,`RPC '${t}' stream ${r} received:`,s),d.io(s)}})),f(o,Tr.STAT_EVENT,(e=>{e.stat===Sr?Or(wh,`RPC '${t}' stream ${r} detected buffering proxy`):e.stat===_r&&Or(wh,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{d.no()}),0),d}}function Ih(){return"undefined"!=typeof window?window:null}function bh(){return"undefined"!=typeof document?document:null}function Eh(t){return new Sc(t,!0)}class Th{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Ws=t,this.timerId=e,this._o=n,this.mo=r,this.yo=s,this.po=0,this.Io=null,this.To=Date.now(),this.reset()}reset(){this.po=0}Eo(){this.po=this.yo}Ao(t){this.cancel();const e=Math.floor(this.po+this.Ro()),n=Math.max(0,Date.now()-this.To),r=Math.max(0,e-n);r>0&&Or("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.po} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Io=this.Ws.enqueueAfterDelay(this.timerId,r,(()=>(this.To=Date.now(),t()))),this.po*=this.mo,this.po<this._o&&(this.po=this._o),this.po>this.yo&&(this.po=this.yo)}vo(){null!==this.Io&&(this.Io.skipDelay(),this.Io=null)}cancel(){null!==this.Io&&(this.Io.cancel(),this.Io=null)}Ro(){return(Math.random()-.5)*this.po}}class Sh{constructor(t,e,n,r,s,i,o,a){this.Ws=t,this.bo=n,this.Po=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Vo=0,this.So=null,this.Do=null,this.stream=null,this.Co=new Th(t,e)}xo(){return 1===this.state||5===this.state||this.No()}No(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.ko()}async stop(){this.xo()&&await this.close(0)}Oo(){this.state=0,this.Co.reset()}$o(){this.No()&&null===this.So&&(this.So=this.Ws.enqueueAfterDelay(this.bo,6e4,(()=>this.Mo())))}Fo(t){this.Bo(),this.stream.send(t)}async Mo(){if(this.No())return this.close(0)}Bo(){this.So&&(this.So.cancel(),this.So=null)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}async close(t,e){this.Bo(),this.Lo(),this.Co.cancel(),this.Vo++,4!==t?this.Co.reset():e&&e.code===zr.RESOURCE_EXHAUSTED?(Fr(e.toString()),Fr("Using maximum backoff delay to prevent overloading the backend."),this.Co.Eo()):e&&e.code===zr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Zr(e)}qo(){}auth(){this.state=1;const t=this.Uo(this.Vo),e=this.Vo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Vo===e&&this.Ko(t,n)}),(e=>{t((()=>{const t=new jr(zr.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Go(t)}))}))}Ko(t,e){const n=this.Uo(this.Vo);this.stream=this.Qo(t,e),this.stream.Jr((()=>{n((()=>(this.state=2,this.Do=this.Ws.enqueueAfterDelay(this.Po,1e4,(()=>(this.No()&&(this.state=3),Promise.resolve()))),this.listener.Jr())))})),this.stream.Zr((t=>{n((()=>this.Go(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}ko(){this.state=5,this.Co.Ao((async()=>{this.state=0,this.start()}))}Go(t){return Or("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Uo(t){return e=>{this.Ws.enqueueAndForget((()=>this.Vo===t?e():(Or("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class _h extends Sh{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}Qo(t,e){return this.connection.wo("Listen",t,e)}onMessage(t){this.Co.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Br()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(qr(void 0===e||"string"==typeof e),Ni.fromBase64String(e||"")):(qr(void 0===e||e instanceof Uint8Array),Ni.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?zr.UNKNOWN:uc(t.code);return new jr(e,t.message||"")}(o);n=new pc(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Rc(t,r.document.name),i=Ac(r.document.updateTime),o=r.document.createTime?Ac(r.document.createTime):as.min(),a=new ao({mapValue:{fields:r.document.fields}}),c=uo.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new mc(u,l,c.key,c)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Rc(t,r.document),i=r.readTime?Ac(r.readTime):as.min(),o=uo.newNoDocument(s,i),a=r.removedTargetIds||[];n=new mc([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Rc(t,r.document),i=r.removedTargetIds||[];n=new mc([],i,s,null)}else{if(!("filter"in e))return Br();{e.filter;const t=e.filter;t.targetId;const r=t.count||0,s=new ic(r),i=t.targetId;n=new gc(i,s)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return as.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?as.min():e.readTime?Ac(e.readTime):as.min()}(t);return this.listener.zo(e,n)}jo(t){const e={};e.database=Oc(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;return n=Bo(r)?{documents:Uc(t,r)}:{query:Gc(t,r)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Dc(t,e.resumeToken):e.snapshotVersion.compareTo(as.min())>0&&(n.readTime=_c(t,e.snapshotVersion.toTimestamp())),n}(this.serializer,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Br()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.Fo(e)}Wo(t){const e={};e.database=Oc(this.serializer),e.removeTarget=t,this.Fo(e)}}class Dh extends Sh{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s,this.Ho=!1}get Jo(){return this.Ho}start(){this.Ho=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Ho&&this.Yo([])}Qo(t,e){return this.connection.wo("Write",t,e)}onMessage(t){if(qr(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Ho){this.Co.reset();const e=function(t,e){return t&&t.length>0?(qr(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Ac(t.updateTime):Ac(e);return n.isEqual(as.min())&&(n=Ac(e)),new Pa(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Ac(t.commitTime);return this.listener.Zo(n,e)}return qr(!t.writeResults||0===t.writeResults.length),this.Ho=!0,this.listener.Xo()}tu(){const t={};t.database=Oc(this.serializer),this.Fo(t)}Yo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Bc(this.serializer,t)))};this.Fo(e)}}class xh extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.eu=!1}nu(){if(this.eu)throw new jr(zr.FAILED_PRECONDITION,"The client has already been terminated.")}co(t,e,n){return this.nu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.connection.co(t,e,n,r,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===zr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new jr(zr.UNKNOWN,t.toString())}))}fo(t,e,n,r){return this.nu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.fo(t,e,n,s,i,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===zr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new jr(zr.UNKNOWN,t.toString())}))}terminate(){this.eu=!0}}class Ah{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.su=0,this.iu=null,this.ru=!0}ou(){0===this.su&&(this.uu("Unknown"),this.iu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.iu=null,this.cu("Backend didn't respond within 10 seconds."),this.uu("Offline"),Promise.resolve()))))}au(t){"Online"===this.state?this.uu("Unknown"):(this.su++,this.su>=1&&(this.hu(),this.cu(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.uu("Offline")))}set(t){this.hu(),this.su=0,"Online"===t&&(this.ru=!1),this.uu(t)}uu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}cu(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ru?(Fr(e),this.ru=!1):Or("OnlineStateTracker",e)}hu(){null!==this.iu&&(this.iu.cancel(),this.iu=null)}}class Ch{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.lu=[],this.fu=new Map,this.du=new Set,this.wu=[],this._u=s,this._u.qr((t=>{n.enqueueAndForget((async()=>{Vh(this)&&(Or("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Gr(t);e.du.add(4),await kh(e),e.mu.set("Unknown"),e.du.delete(4),await Nh(e)}(this))}))})),this.mu=new Ah(n,r)}}async function Nh(t){if(Vh(t))for(const e of t.wu)await e(!0)}async function kh(t){for(const e of t.wu)await e(!1)}function Rh(t,e){const n=Gr(t);n.fu.has(e.targetId)||(n.fu.set(e.targetId,e),Ph(n)?Fh(n):nd(n).No()&&Lh(n,e))}function Mh(t,e){const n=Gr(t),r=nd(n);n.fu.delete(e),r.No()&&Oh(n,e),0===n.fu.size&&(r.No()?r.$o():Vh(n)&&n.mu.set("Unknown"))}function Lh(t,e){t.gu.Ot(e.targetId),nd(t).jo(e)}function Oh(t,e){t.gu.Ot(e),nd(t).Wo(e)}function Fh(t){t.gu=new wc({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),ne:e=>t.fu.get(e)||null}),nd(t).start(),t.mu.ou()}function Ph(t){return Vh(t)&&!nd(t).xo()&&t.fu.size>0}function Vh(t){return 0===Gr(t).du.size}function Bh(t){t.gu=void 0}async function qh(t){t.fu.forEach(((e,n)=>{Lh(t,e)}))}async function Uh(t,e){Bh(t),Ph(t)?(t.mu.au(e),Fh(t)):t.mu.set("Unknown")}async function Gh(t,e,n){if(t.mu.set("Online"),e instanceof pc&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.fu.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.fu.delete(r),t.gu.removeTarget(r))}(t,e)}catch(n){Or("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await zh(t,n)}else if(e instanceof mc?t.gu.Kt(e):e instanceof gc?t.gu.Jt(e):t.gu.zt(e),!n.isEqual(as.min()))try{const e=await $l(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.gu.Xt(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.fu.get(r);s&&t.fu.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.fu.get(e);if(!n)return;t.fu.set(e,n.withResumeToken(Ni.EMPTY_BYTE_STRING,n.snapshotVersion)),Oh(t,e);const r=new Zc(n.target,e,1,n.sequenceNumber);Lh(t,r)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Or("RemoteStore","Failed to raise snapshot:",e),await zh(t,e)}}async function zh(t,e,n){if(!Rs(e))throw e;t.du.add(1),await kh(t),t.mu.set("Offline"),n||(n=()=>$l(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Or("RemoteStore","Retrying IndexedDB access"),await n(),t.du.delete(1),await Nh(t)}))}function jh(t,e){return e().catch((n=>zh(t,n,e)))}async function Kh(t){const e=Gr(t),n=rd(e);let r=e.lu.length>0?e.lu[e.lu.length-1].batchId:-1;for(;$h(e);)try{const t=await Hl(e.localStore,r);if(null===t){0===e.lu.length&&n.$o();break}r=t.batchId,Qh(e,t)}catch(t){await zh(e,t)}Hh(e)&&Wh(e)}function $h(t){return Vh(t)&&t.lu.length<10}function Qh(t,e){t.lu.push(e);const n=rd(t);n.No()&&n.Jo&&n.Yo(e.mutations)}function Hh(t){return Vh(t)&&!rd(t).xo()&&t.lu.length>0}function Wh(t){rd(t).start()}async function Yh(t){rd(t).tu()}async function Xh(t){const e=rd(t);for(const n of t.lu)e.Yo(n.mutations)}async function Jh(t,e,n){const r=t.lu.shift(),s=tc.from(r,e,n);await jh(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await Kh(t)}async function Zh(t,e){e&&rd(t).Jo&&await async function(t,e){if(cc(n=e.code)&&n!==zr.ABORTED){const n=t.lu.shift();rd(t).Oo(),await jh(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await Kh(t)}var n}(t,e),Hh(t)&&Wh(t)}async function td(t,e){const n=Gr(t);n.asyncQueue.verifyOperationInProgress(),Or("RemoteStore","RemoteStore received new credentials");const r=Vh(n);n.du.add(3),await kh(n),r&&n.mu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.du.delete(3),await Nh(n)}async function ed(t,e){const n=Gr(t);e?(n.du.delete(2),await Nh(n)):e||(n.du.add(2),await kh(n),n.mu.set("Unknown"))}function nd(t){return t.yu||(t.yu=function(t,e,n){const r=Gr(t);return r.nu(),new _h(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Jr:qh.bind(null,t),Zr:Uh.bind(null,t),zo:Gh.bind(null,t)}),t.wu.push((async e=>{e?(t.yu.Oo(),Ph(t)?Fh(t):t.mu.set("Unknown")):(await t.yu.stop(),Bh(t))}))),t.yu}function rd(t){return t.pu||(t.pu=function(t,e,n){const r=Gr(t);return r.nu(),new Dh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Jr:Yh.bind(null,t),Zr:Zh.bind(null,t),Xo:Xh.bind(null,t),Zo:Jh.bind(null,t)}),t.wu.push((async e=>{e?(t.pu.Oo(),await Kh(t)):(await t.pu.stop(),t.lu.length>0&&(Or("RemoteStore",`Stopping write stream with ${t.lu.length} pending writes`),t.lu=[]))}))),t.pu}class sd{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Kr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new sd(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new jr(zr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function id(t,e){if(Fr("AsyncQueue",`${e}: ${t}`),Rs(t))return new jr(zr.UNAVAILABLE,`${e}: ${t}`);throw t}class od{constructor(t){this.comparator=t?(e,n)=>t(e,n)||ds.comparator(e.key,n.key):(t,e)=>ds.comparator(t.key,e.key),this.keyedMap=ha(),this.sortedSet=new bi(this.comparator)}static emptySet(t){return new od(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof od))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new od;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class ad{constructor(){this.Iu=new bi(ds.comparator)}track(t){const e=t.doc.key,n=this.Iu.get(e);n?0!==t.type&&3===n.type?this.Iu=this.Iu.insert(e,t):3===t.type&&1!==n.type?this.Iu=this.Iu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Iu=this.Iu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Iu=this.Iu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Iu=this.Iu.remove(e):1===t.type&&2===n.type?this.Iu=this.Iu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Iu=this.Iu.insert(e,{type:2,doc:t.doc}):Br():this.Iu=this.Iu.insert(e,t)}Tu(){const t=[];return this.Iu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class cd{constructor(t,e,n,r,s,i,o,a,c){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(t,e,n,r,s){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new cd(t,e,od.emptySet(e),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&ta(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class ud{constructor(){this.Eu=void 0,this.listeners=[]}}class ld{constructor(){this.queries=new aa((t=>ea(t)),ta),this.onlineState="Unknown",this.Au=new Set}}async function hd(t,e){const n=Gr(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new ud),s)try{i.Eu=await n.onListen(r)}catch(t){const n=id(t,`Initialization of query '${na(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.Ru(n.onlineState),i.Eu&&e.vu(i.Eu)&&gd(n)}async function dd(t,e){const n=Gr(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function fd(t,e){const n=Gr(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.vu(t)&&(r=!0);s.Eu=t}}r&&gd(n)}function md(t,e,n){const r=Gr(t),s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}function gd(t){t.Au.forEach((t=>{t.next()}))}class pd{constructor(t,e,n){this.query=t,this.bu=e,this.Pu=!1,this.Vu=null,this.onlineState="Unknown",this.options=n||{}}vu(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new cd(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.Pu?this.Su(t)&&(this.bu.next(t),e=!0):this.Du(t,this.onlineState)&&(this.Cu(t),e=!0),this.Vu=t,e}onError(t){this.bu.error(t)}Ru(t){this.onlineState=t;let e=!1;return this.Vu&&!this.Pu&&this.Du(this.Vu,t)&&(this.Cu(this.Vu),e=!0),e}Du(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.xu||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}Su(t){if(t.docChanges.length>0)return!0;const e=this.Vu&&this.Vu.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Cu(t){t=cd.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.Pu=!0,this.bu.next(t)}}class yd{constructor(t,e){this.Nu=t,this.byteLength=e}ku(){return"metadata"in this.Nu}}class wd{constructor(t){this.serializer=t}Hi(t){return Rc(this.serializer,t)}Ji(t){return t.metadata.exists?Vc(this.serializer,t.document,!1):uo.newNoDocument(this.Hi(t.metadata.name),this.Yi(t.metadata.readTime))}Yi(t){return Ac(t)}}class vd{constructor(t,e,n){this.Ou=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Id(t)}$u(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.Nu.namedQuery)this.queries.push(t.Nu.namedQuery);else if(t.Nu.documentMetadata){this.documents.push({metadata:t.Nu.documentMetadata}),t.Nu.documentMetadata.exists||++e;const n=us.fromString(t.Nu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.Nu.document&&(this.documents[this.documents.length-1].document=t.Nu.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}Mu(t){const e=new Map,n=new wd(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.Hi(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||wa()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=Gr(t);let i=wa(),o=ua();for(const t of n){const n=e.Hi(t.metadata.name);t.document&&(i=i.add(n));const r=e.Ji(t);r.setReadTime(e.Yi(t.metadata.readTime)),o=o.insert(n,r)}const a=s.Ki.newChangeBuffer({trackRemovals:!0}),c=await Wl(s,function(t){return Xo(Ko(us.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Ql(t,a,o).next((e=>(a.apply(t),e))).next((e=>s.Ds.removeMatchingKeysForTargetId(t,c.targetId).next((()=>s.Ds.addMatchingKeys(t,i,c.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(t,e.zi,e.ji))).next((()=>e.zi))))))}(this.localStore,new wd(this.serializer),this.documents,this.Ou.id),e=this.Mu(this.documents);for(const t of this.queries)await eh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Fu:this.collectionGroups,Bu:t}}}function Id(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class bd{constructor(t){this.key=t}}class Ed{constructor(t){this.key=t}}class Td{constructor(t,e){this.query=t,this.Lu=e,this.qu=null,this.hasCachedResults=!1,this.current=!1,this.Uu=wa(),this.mutatedKeys=wa(),this.Ku=ia(t),this.Gu=new od(this.Ku)}get Qu(){return this.Lu}zu(t,e){const n=e?e.ju:new ad,r=e?e.Gu:this.Gu;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const u=r.get(t),l=ra(this.query,e)?e:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Wu(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Ku(l,a)>0||c&&this.Ku(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{Gu:i,ju:n,Mi:o,mutatedKeys:s}}Wu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const r=this.Gu;this.Gu=t.Gu,this.mutatedKeys=t.mutatedKeys;const s=t.ju.Tu();s.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Br()}};return n(t)-n(e)}(t.type,e.type)||this.Ku(t.doc,e.doc))),this.Hu(n);const i=e?this.Ju():[],o=0===this.Uu.size&&this.current?1:0,a=o!==this.qu;return this.qu=o,0!==s.length||a?{snapshot:new cd(this.query,t.Gu,r,s,t.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),Yu:i}:{Yu:i}}Ru(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Gu:this.Gu,ju:new ad,mutatedKeys:this.mutatedKeys,Mi:!1},!1)):{Yu:[]}}Zu(t){return!this.Lu.has(t)&&!!this.Gu.has(t)&&!this.Gu.get(t).hasLocalMutations}Hu(t){t&&(t.addedDocuments.forEach((t=>this.Lu=this.Lu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Lu=this.Lu.delete(t))),this.current=t.current)}Ju(){if(!this.current)return[];const t=this.Uu;this.Uu=wa(),this.Gu.forEach((t=>{this.Zu(t.key)&&(this.Uu=this.Uu.add(t.key))}));const e=[];return t.forEach((t=>{this.Uu.has(t)||e.push(new Ed(t))})),this.Uu.forEach((n=>{t.has(n)||e.push(new bd(n))})),e}Xu(t){this.Lu=t.Wi,this.Uu=wa();const e=this.zu(t.documents);return this.applyChanges(e,!0)}tc(){return cd.fromInitialDocuments(this.query,this.Gu,this.mutatedKeys,0===this.qu,this.hasCachedResults)}}class Sd{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class _d{constructor(t){this.key=t,this.ec=!1}}class Dd{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.nc={},this.sc=new aa((t=>ea(t)),ta),this.ic=new Map,this.rc=new Set,this.oc=new bi(ds.comparator),this.uc=new Map,this.cc=new _l,this.ac={},this.hc=new Map,this.lc=el.bn(),this.onlineState="Unknown",this.fc=void 0}get isPrimaryClient(){return!0===this.fc}}async function xd(t,e){const n=Zd(t);let r,s;const i=n.sc.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.tc();else{const t=await Wl(n.localStore,Xo(e));n.isPrimaryClient&&Rh(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Ad(n,e,r,"current"===i,t.resumeToken)}return s}async function Ad(t,e,n,r,s){t.dc=(e,n,r)=>async function(t,e,n,r){let s=e.view.zu(n);s.Mi&&(s=await Xl(t.localStore,e.query,!1).then((({documents:t})=>e.view.zu(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=e.view.applyChanges(s,t.isPrimaryClient,i);return Bd(t,e.targetId,o.Yu),o.snapshot}(t,e,n,r);const i=await Xl(t.localStore,e,!0),o=new Td(e,i.Wi),a=o.zu(i.documents),c=fc.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,s),u=o.applyChanges(a,t.isPrimaryClient,c);Bd(t,n,u.Yu);const l=new Sd(e,n,o);return t.sc.set(e,l),t.ic.has(n)?t.ic.get(n).push(e):t.ic.set(n,[e]),u.snapshot}async function Cd(t,e){const n=Gr(t),r=n.sc.get(e),s=n.ic.get(r.targetId);if(s.length>1)return n.ic.set(r.targetId,s.filter((t=>!ta(t,e)))),void n.sc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Yl(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Mh(n.remoteStore,r.targetId),Pd(n,r.targetId)})).catch(Ds)):(Pd(n,r.targetId),await Yl(n.localStore,r.targetId,!0))}async function Nd(t,e){const n=Gr(t);try{const t=await function(t,e){const n=Gr(t),r=e.snapshotVersion;let s=n.Li;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Ki.newChangeBuffer({trackRemovals:!0});s=n.Li;const o=[];e.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Ds.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Ds.addMatchingKeys(t,i.addedDocuments,a))));let u=c.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?u=u.withResumeToken(Ni.EMPTY_BYTE_STRING,as.min()).withLastLimboFreeSnapshotVersion(as.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Ds.updateTargetData(t,u))}));let a=ua(),c=wa();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(Ql(t,i,e.documentUpdates).next((t=>{a=t.zi,c=t.ji}))),!r.isEqual(as.min())){const e=n.Ds.getLastRemoteSnapshotVersion(t).next((e=>n.Ds.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return xs.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,c))).next((()=>a))})).then((t=>(n.Li=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.uc.get(e);r&&(qr(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.ec=!0:t.modifiedDocuments.size>0?qr(r.ec):t.removedDocuments.size>0&&(qr(r.ec),r.ec=!1))})),await Gd(n,t,e)}catch(t){await Ds(t)}}function kd(t,e,n){const r=Gr(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.sc.forEach(((n,r)=>{const s=r.view.Ru(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=Gr(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.Ru(e)&&(r=!0)})),r&&gd(n)}(r.eventManager,e),t.length&&r.nc.zo(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Rd(t,e,n){const r=Gr(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.uc.get(e),i=s&&s.key;if(i){let t=new bi(ds.comparator);t=t.insert(i,uo.newNoDocument(i,as.min()));const n=wa().add(i),s=new dc(as.min(),new Map,new Si(rs),t,n);await Nd(r,s),r.oc=r.oc.remove(i),r.uc.delete(e),Ud(r)}else await Yl(r.localStore,e,!1).then((()=>Pd(r,e,n))).catch(Ds)}async function Md(t,e){const n=Gr(t),r=e.batch.batchId;try{const t=await function(t,e){const n=Gr(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.Ki.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=xs.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);qr(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=wa();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);Fd(n,r,null),Od(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Gd(n,t)}catch(t){await Ds(t)}}async function Ld(t,e,n){const r=Gr(t);try{const t=await function(t,e){const n=Gr(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(qr(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);Fd(r,e,n),Od(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Gd(r,t)}catch(n){await Ds(n)}}function Od(t,e){(t.hc.get(e)||[]).forEach((t=>{t.resolve()})),t.hc.delete(e)}function Fd(t,e,n){const r=Gr(t);let s=r.ac[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.ac[r.currentUser.toKey()]=s}}function Pd(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.ic.get(e))t.sc.delete(r),n&&t.nc.wc(r,n);t.ic.delete(e),t.isPrimaryClient&&t.cc.hs(e).forEach((e=>{t.cc.containsKey(e)||Vd(t,e)}))}function Vd(t,e){t.rc.delete(e.path.canonicalString());const n=t.oc.get(e);null!==n&&(Mh(t.remoteStore,n),t.oc=t.oc.remove(e),t.uc.delete(n),Ud(t))}function Bd(t,e,n){for(const r of n)r instanceof bd?(t.cc.addReference(r.key,e),qd(t,r)):r instanceof Ed?(Or("SyncEngine","Document no longer in limbo: "+r.key),t.cc.removeReference(r.key,e),t.cc.containsKey(r.key)||Vd(t,r.key)):Br()}function qd(t,e){const n=e.key,r=n.path.canonicalString();t.oc.get(n)||t.rc.has(r)||(Or("SyncEngine","New document in limbo: "+n),t.rc.add(r),Ud(t))}function Ud(t){for(;t.rc.size>0&&t.oc.size<t.maxConcurrentLimboResolutions;){const e=t.rc.values().next().value;t.rc.delete(e);const n=new ds(us.fromString(e)),r=t.lc.next();t.uc.set(r,new _d(n)),t.oc=t.oc.insert(n,r),Rh(t.remoteStore,new Zc(Xo(Ko(n.path)),r,2,Bs.ct))}}async function Gd(t,e,n){const r=Gr(t),s=[],i=[],o=[];r.sc.isEmpty()||(r.sc.forEach(((t,a)=>{o.push(r.dc(a,e,n).then((t=>{if((t||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){s.push(t);const e=Ul.Di(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.nc.zo(s),await async function(t,e){const n=Gr(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>xs.forEach(e,(e=>xs.forEach(e.Vi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>xs.forEach(e.Si,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!Rs(t))throw t;Or("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Li.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.Li=n.Li.insert(e,s)}}}(r.localStore,i))}async function zd(t,e){const n=Gr(t);if(!n.currentUser.isEqual(e)){Or("SyncEngine","User change. New user:",e.toKey());const t=await Kl(n.localStore,e);n.currentUser=e,function(t,e){t.hc.forEach((t=>{t.forEach((t=>{t.reject(new jr(zr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.hc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Gd(n,t.Qi)}}function jd(t,e){const n=Gr(t),r=n.uc.get(e);if(r&&r.ec)return wa().add(r.key);{let t=wa();const r=n.ic.get(e);if(!r)return t;for(const e of r){const r=n.sc.get(e);t=t.unionWith(r.view.Qu)}return t}}async function Kd(t,e){const n=Gr(t),r=await Xl(n.localStore,e.query,!0),s=e.view.Xu(r);return n.isPrimaryClient&&Bd(n,e.targetId,s.Yu),s}async function $d(t,e){const n=Gr(t);return Zl(n.localStore,e).then((t=>Gd(n,t)))}async function Qd(t,e,n,r){const s=Gr(t),i=await function(t,e){const n=Gr(t),r=Gr(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.In(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):xs.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await Kh(s.remoteStore):"acknowledged"===n||"rejected"===n?(Fd(s,e,r||null),Od(s,e),function(t,e){Gr(Gr(t).mutationQueue).En(e)}(s.localStore,e)):Br(),await Gd(s,i)):Or("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Hd(t,e,n){const r=Gr(t),s=[],i=[];for(const t of e){let e;const n=r.ic.get(t);if(n&&0!==n.length){e=await Wl(r.localStore,Xo(n[0]));for(const t of n){const e=r.sc.get(t),n=await Kd(r,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await Jl(r.localStore,t);e=await Wl(r.localStore,n),await Ad(r,Wd(n),t,!1,e.resumeToken)}s.push(e)}return r.nc.zo(i),s}function Wd(t){return jo(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Yd(t){const e=Gr(t);return Gr(Gr(e.localStore).persistence).bi()}async function Xd(t,e,n,r){const s=Gr(t);if(s.fc)return void Or("SyncEngine","Ignoring unexpected query state notification.");const i=s.ic.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await Zl(s.localStore,sa(i[0])),r=dc.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,Ni.EMPTY_BYTE_STRING);await Gd(s,t,r);break}case"rejected":await Yl(s.localStore,e,!0),Pd(s,e,r);break;default:Br()}}async function Jd(t,e,n){const r=Zd(t);if(r.fc){for(const t of e){if(r.ic.has(t)){Or("SyncEngine","Adding an already active target "+t);continue}const e=await Jl(r.localStore,t),n=await Wl(r.localStore,e);await Ad(r,Wd(e),n.targetId,!1,n.resumeToken),Rh(r.remoteStore,n)}for(const t of n)r.ic.has(t)&&await Yl(r.localStore,t,!1).then((()=>{Mh(r.remoteStore,t),Pd(r,t)})).catch(Ds)}}function Zd(t){const e=Gr(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Nd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=jd.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Rd.bind(null,e),e.nc.zo=fd.bind(null,e.eventManager),e.nc.wc=md.bind(null,e.eventManager),e}function tf(t){const e=Gr(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Md.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Ld.bind(null,e),e}class ef{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=Eh(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return jl(this.persistence,new Gl,t.initialUser,this.serializer)}createPersistence(t){return new kl(Ml.Fs,this.serializer)}createSharedClientState(t){return new hh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class nf extends ef{constructor(t,e,n){super(),this.mc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.mc.initialize(this,t),await tf(this.mc.syncEngine),await Kh(this.mc.remoteStore),await this.persistence.hi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return jl(this.persistence,new Gl,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new cl(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new Vs(e,this.persistence);return new Ps(t.asyncQueue,n)}createPersistence(t){const e=ql(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Qu.withCacheSize(this.cacheSizeBytes):Qu.DEFAULT;return new Pl(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Ih(),bh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new hh}}class rf extends nf{constructor(t,e){super(t,e,!1),this.mc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.mc.syncEngine;this.sharedClientState instanceof lh&&(this.sharedClientState.syncEngine={$r:Qd.bind(null,e),Mr:Xd.bind(null,e),Fr:Jd.bind(null,e),bi:Yd.bind(null,e),Or:$d.bind(null,e)},await this.sharedClientState.start()),await this.persistence.hi((async t=>{await async function(t,e){const n=Gr(t);if(Zd(n),tf(n),!0===e&&!0!==n.fc){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Hd(n,t.toArray());n.fc=!0,await ed(n.remoteStore,!0);for(const t of e)Rh(n.remoteStore,t)}else if(!1===e&&!1!==n.fc){const t=[];let e=Promise.resolve();n.ic.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(Pd(n,s),Yl(n.localStore,s,!0)))),Mh(n.remoteStore,s)})),await e,await Hd(n,t),function(t){const e=Gr(t);e.uc.forEach(((t,n)=>{Mh(e.remoteStore,n)})),e.cc.ls(),e.uc=new Map,e.oc=new bi(ds.comparator)}(n),n.fc=!1,await ed(n.remoteStore,!1)}}(this.mc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}createSharedClientState(t){const e=Ih();if(!lh.D(e))throw new jr(zr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=ql(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new lh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class sf{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>kd(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=zd.bind(null,this.syncEngine),await ed(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new ld}createDatastore(t){const e=Eh(t.databaseInfo.databaseId),n=(r=t.databaseInfo,new vh(r));var r;return function(t,e,n,r){return new xh(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>kd(this.syncEngine,t,0),i=fh.D()?new fh:new dh,new Ch(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Dd(t,e,n,r,s,i);return o&&(a.fc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=Gr(t);Or("RemoteStore","RemoteStore shutting down."),e.du.add(5),await kh(e),e._u.shutdown(),e.mu.set("Unknown")}(this.remoteStore)}}function of(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class af{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.gc(this.observer.next,t)}error(t){this.observer.error?this.gc(this.observer.error,t):Fr("Uncaught Error in snapshot listener:",t.toString())}yc(){this.muted=!0}gc(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class cf{constructor(t,e){this.Ic=t,this.serializer=e,this.metadata=new Kr,this.buffer=new Uint8Array,this.Tc=new TextDecoder("utf-8"),this.Ec().then((t=>{t&&t.ku()?this.metadata.resolve(t.Nu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.Nu)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Ic.cancel()}async getMetadata(){return this.metadata.promise}async _c(){return await this.getMetadata(),this.Ec()}async Ec(){const t=await this.Ac();if(null===t)return null;const e=this.Tc.decode(t),n=Number(e);isNaN(n)&&this.Rc(`length string (${e}) is not valid number`);const r=await this.vc(n);return new yd(JSON.parse(r),t.length+n)}bc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Ac(){for(;this.bc()<0&&!await this.Pc(););if(0===this.buffer.length)return null;const t=this.bc();t<0&&this.Rc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async vc(t){for(;this.buffer.length<t;)await this.Pc()&&this.Rc("Reached the end of bundle when more is expected.");const e=this.Tc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Rc(t){throw this.Ic.cancel(),new Error(`Invalid bundle format: ${t}`)}async Pc(){const t=await this.Ic.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class uf{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new jr(zr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=Gr(t),r=Oc(n.serializer)+"/documents",s={documents:e.map((t=>kc(n.serializer,t)))},i=await n.fo("BatchGetDocuments",r,s,e.length),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){qr(!!e.found),e.found.name,e.found.updateTime;const n=Rc(t,e.found.name),r=Ac(e.found.updateTime),s=e.found.createTime?Ac(e.found.createTime):as.min(),i=new ao({mapValue:{fields:e.found.fields}});return uo.newFoundDocument(n,r,s,i)}(t,e):"missing"in e?function(t,e){qr(!!e.missing),qr(!!e.readTime);const n=Rc(t,e.missing),r=Ac(e.readTime);return uo.newNoDocument(n,r)}(t,e):Br()}(n.serializer,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());qr(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Xa(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=ds.fromPath(e);this.mutations.push(new Ja(n,this.precondition(n)))})),await async function(t,e){const n=Gr(t),r=Oc(n.serializer)+"/documents",s={writes:e.map((t=>Bc(n.serializer,t)))};await n.co("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Br();e=as.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new jr(zr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(as.min())?Va.exists(!1):Va.updateTime(e):Va.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(as.min()))throw new jr(zr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Va.updateTime(e)}return Va.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class lf{constructor(t,e,n,r,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=s,this.Vc=n.maxAttempts,this.Co=new Th(this.asyncQueue,"transaction_retry")}run(){this.Vc-=1,this.Sc()}Sc(){this.Co.Ao((async()=>{const t=new uf(this.datastore),e=this.Dc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Cc(t)}))))})).catch((t=>{this.Cc(t)}))}))}Dc(t){try{const e=this.updateFunction(t);return!qs(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Cc(t){this.Vc>0&&this.xc(t)?(this.Vc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Sc(),Promise.resolve())))):this.deferred.reject(t)}xc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!cc(e)}return!1}}class hf{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=Nr.UNAUTHENTICATED,this.clientId=ns.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Or("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Or("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new jr(zr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Kr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=id(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function df(t,e){t.asyncQueue.verifyOperationInProgress(),Or("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await Kl(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function ff(t,e){t.asyncQueue.verifyOperationInProgress();const n=await gf(t);Or("FirestoreClient","Initializing OnlineComponentProvider");const r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener((t=>td(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>td(e.remoteStore,n))),t._onlineComponents=e}function mf(t){return"FirebaseError"===t.name?t.code===zr.FAILED_PRECONDITION||t.code===zr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function gf(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){Or("FirestoreClient","Using user provided OfflineComponentProvider");try{await df(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!mf(n))throw n;Pr("Error using user provided cache. Falling back to memory cache: "+n),await df(t,new ef)}}else Or("FirestoreClient","Using default OfflineComponentProvider"),await df(t,new ef);return t._offlineComponents}async function pf(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(Or("FirestoreClient","Using user provided OnlineComponentProvider"),await ff(t,t._uninitializedComponentsProvider._online)):(Or("FirestoreClient","Using default OnlineComponentProvider"),await ff(t,new sf))),t._onlineComponents}function yf(t){return gf(t).then((t=>t.persistence))}function wf(t){return gf(t).then((t=>t.localStore))}function vf(t){return pf(t).then((t=>t.remoteStore))}function If(t){return pf(t).then((t=>t.syncEngine))}function bf(t){return pf(t).then((t=>t.datastore))}async function Ef(t){const e=await pf(t),n=e.eventManager;return n.onListen=xd.bind(null,e.syncEngine),n.onUnlisten=Cd.bind(null,e.syncEngine),n}function Tf(t,e,n={}){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new af({next:i=>{e.enqueueAndForget((()=>dd(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new jr(zr.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new jr(zr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new pd(Ko(n.path),i,{includeMetadataChanges:!0,xu:!0});return hd(t,o)}(await Ef(t),t.asyncQueue,e,n,r))),r.promise}function Sf(t,e,n={}){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new af({next:n=>{e.enqueueAndForget((()=>dd(t,o))),n.fromCache&&"server"===r.source?s.reject(new jr(zr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new pd(n,i,{includeMetadataChanges:!0,xu:!0});return hd(t,o)}(await Ef(t),t.asyncQueue,e,n,r))),r.promise}function _f(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new cf(t,e)}(function(t,e){if(t instanceof Uint8Array)return of(t,e);if(t instanceof ArrayBuffer)return of(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Eh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=Gr(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=Gr(t),r=Ac(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.xs.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Id(r));const s=new vd(r,t.localStore,e.serializer);let i=await e._c();for(;i;){const t=await s.$u(i);t&&n._updateProgress(t),i=await e._c()}const o=await s.complete();return await Gd(t,o.Bu,void 0),await function(t,e){const n=Gr(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.xs.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Fu)}catch(t){return Pr("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await If(t),s,r)}))}const Df=new Map;function xf(t,e,n){if(!n)throw new jr(zr.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Af(t,e,n,r){if(!0===e&&!0===r)throw new jr(zr.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Cf(t){if(!ds.isDocumentKey(t))throw new jr(zr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Nf(t){if(ds.isDocumentKey(t))throw new jr(zr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function kf(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Br()}function Rf(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new jr(zr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=kf(t);throw new jr(zr.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Mf(t,e){if(e<=0)throw new jr(zr.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Lf{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new jr(zr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.cache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new jr(zr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Af("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Of{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Lf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new jr(zr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new jr(zr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Lf(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Qr;switch(t.type){case"firstParty":return new Xr(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new jr(zr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Df.get(t);e&&(Or("ComponentProvider","Removing Datastore"),Df.delete(t),e.terminate())}(this),Promise.resolve()}}function Ff(t,e,n,r={}){var s;const i=(t=Rf(t,Of))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Pr("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=Nr.MOCK_USER;else{e=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=e||"demo-project",r=t.iat||0,s=t.sub||t.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},t);return[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new jr(zr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Nr(i)}t._authCredentials=new Hr(new $r(e,n))}}class Pf{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Bf(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Pf(this.firestore,t,this._key)}}class Vf{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Vf(this.firestore,t,this._query)}}class Bf extends Vf{constructor(t,e,n){super(t,e,Ko(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Pf(this.firestore,null,new ds(t))}withConverter(t){return new Bf(this.firestore,t,this._path)}}function qf(t,e,...n){if(t=b(t),xf("collection","path",e),t instanceof Of){const r=us.fromString(e,...n);return Nf(r),new Bf(t,null,r)}{if(!(t instanceof Pf||t instanceof Bf))throw new jr(zr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(us.fromString(e,...n));return Nf(r),new Bf(t.firestore,null,r)}}function Uf(t,e){if(t=Rf(t,Of),xf("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new jr(zr.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Vf(t,null,function(t){return new zo(us.emptyPath(),t)}(e))}function Gf(t,e,...n){if(t=b(t),1===arguments.length&&(e=ns.A()),xf("doc","path",e),t instanceof Of){const r=us.fromString(e,...n);return Cf(r),new Pf(t,null,new ds(r))}{if(!(t instanceof Pf||t instanceof Bf))throw new jr(zr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(us.fromString(e,...n));return Cf(r),new Pf(t.firestore,t instanceof Bf?t.converter:null,new ds(r))}}function zf(t,e){return t=b(t),e=b(e),(t instanceof Pf||t instanceof Bf)&&(e instanceof Pf||e instanceof Bf)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function jf(t,e){return t=b(t),e=b(e),t instanceof Vf&&e instanceof Vf&&t.firestore===e.firestore&&ta(t._query,e._query)&&t.converter===e.converter}class Kf{constructor(){this.Nc=Promise.resolve(),this.kc=[],this.Oc=!1,this.$c=[],this.Mc=null,this.Fc=!1,this.Bc=!1,this.Lc=[],this.Co=new Th(this,"async_queue_retry"),this.qc=()=>{const t=bh();t&&Or("AsyncQueue","Visibility state changed to "+t.visibilityState),this.Co.vo()};const t=bh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.qc)}get isShuttingDown(){return this.Oc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Uc(),this.Kc(t)}enterRestrictedMode(t){if(!this.Oc){this.Oc=!0,this.Bc=t||!1;const e=bh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.qc)}}enqueue(t){if(this.Uc(),this.Oc)return new Promise((()=>{}));const e=new Kr;return this.Kc((()=>this.Oc&&this.Bc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.kc.push(t),this.Gc())))}async Gc(){if(0!==this.kc.length){try{await this.kc[0](),this.kc.shift(),this.Co.reset()}catch(t){if(!Rs(t))throw t;Or("AsyncQueue","Operation failed with retryable error: "+t)}this.kc.length>0&&this.Co.Ao((()=>this.Gc()))}}Kc(t){const e=this.Nc.then((()=>(this.Fc=!0,t().catch((t=>{this.Mc=t,this.Fc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Fr("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Fc=!1,t))))));return this.Nc=e,e}enqueueAfterDelay(t,e,n){this.Uc(),this.Lc.indexOf(t)>-1&&(e=0);const r=sd.createAndSchedule(this,t,e,n,(t=>this.Qc(t)));return this.$c.push(r),r}Uc(){this.Mc&&Br()}verifyOperationInProgress(){}async zc(){let t;do{t=this.Nc,await t}while(t!==this.Nc)}jc(t){for(const e of this.$c)if(e.timerId===t)return!0;return!1}Wc(t){return this.zc().then((()=>{this.$c.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.$c)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.zc()}))}Hc(t){this.Lc.push(t)}Qc(t){const e=this.$c.indexOf(t);this.$c.splice(e,1)}}function $f(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class Qf{constructor(){this._progressObserver={},this._taskCompletionResolver=new Kr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Hf=-1;class Wf extends Of{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new Kf,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Zf(this),this._firestoreClient.terminate()}}function Yf(t,e,r){r||(r="(default)");const s=n(t,"firestore");if(s.isInitialized(r)){const t=s.getImmediate({identifier:r});if(v(s.getOptions(r),e))return t;throw new jr(zr.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&void 0!==e.localCache)throw new jr(zr.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new jr(zr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:e,instanceIdentifier:r})}function Xf(t,e){const s="object"==typeof t?t:r(),i="string"==typeof t?t:e||"(default)",o=n(s,"firestore").getImmediate({identifier:i});if(!o._initialized){const t=f("firestore");t&&Ff(o,...t)}return o}function Jf(t){return t._firestoreClient||Zf(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Zf(t){var e,n,r;const s=t._freezeSettings(),i=function(t,e,n,r){return new Vi(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,s);t._firestoreClient=new hf(t._authCredentials,t._appCheckCredentials,t._queue,i),(null===(n=s.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.cache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.cache.kind,_offline:s.cache._offlineComponentProvider,_online:s.cache._onlineComponentProvider})}function tm(t,e){lm(t=Rf(t,Wf));const n=Jf(t);if(n._uninitializedComponentsProvider)throw new jr(zr.FAILED_PRECONDITION,"SDK cache is already specified.");Pr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=t._freezeSettings(),s=new sf;return nm(n,s,new nf(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function em(t){lm(t=Rf(t,Wf));const e=Jf(t);if(e._uninitializedComponentsProvider)throw new jr(zr.FAILED_PRECONDITION,"SDK cache is already specified.");Pr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),r=new sf;return nm(e,r,new rf(r,n.cacheSizeBytes))}function nm(t,e,n){const r=new Kr;return t.asyncQueue.enqueue((async()=>{try{await df(t,n),await ff(t,e),r.resolve()}catch(t){const e=t;if(!mf(e))throw e;Pr("Error enabling indexeddb cache. Falling back to memory cache: "+e),r.reject(e)}})).then((()=>r.promise))}function rm(t){if(t._initialized&&!t._terminated)throw new jr(zr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Kr;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Cs.D())return Promise.resolve();const e=t+"main";await Cs.delete(e)}(ql(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function sm(t){return function(t){const e=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Gr(t);Vh(n.remoteStore)||Or("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Gr(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.hc.get(t)||[];r.push(e),n.hc.set(t,r)}catch(t){const n=id(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await If(t),e))),e.promise}(Jf(t=Rf(t,Wf)))}function im(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await yf(t),n=await vf(t);return e.setNetworkEnabled(!0),function(t){const e=Gr(t);return e.du.delete(0),Nh(e)}(n)}))}(Jf(t=Rf(t,Wf)))}function om(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await yf(t),n=await vf(t);return e.setNetworkEnabled(!1),async function(t){const e=Gr(t);e.du.add(0),await kh(e),e.mu.set("Offline")}(n)}))}(Jf(t=Rf(t,Wf)))}function am(t){return s(t.app,"firestore",t._databaseId.database),t._delete()}function cm(t,e){const n=Jf(t=Rf(t,Wf)),r=new Qf;return _f(n,t._databaseId,e,r),r}function um(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Gr(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.xs.getNamedQuery(t,e)))}(await wf(t),e)))}(Jf(t=Rf(t,Wf)),e).then((e=>e?new Vf(t,null,e.query):null))}function lm(t){if(t._initialized||t._terminated)throw new jr(zr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class hm{constructor(t="count",e){this._aggregateType=t,this._internalFieldPath=e,this.type="AggregateField"}}class dm{constructor(t,e,n){this._userDataWriter=e,this._data=n,this.type="AggregateQuerySnapshot",this.query=t}data(){return this._userDataWriter.convertValue(this._data.value)}}class fm{constructor(t){this._byteString=t}static fromBase64String(t){try{return new fm(Ni.fromBase64String(t))}catch(t){throw new jr(zr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new fm(Ni.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class mm{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new jr(zr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new hs(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function gm(){return new mm("__name__")}class pm{constructor(t){this._methodName=t}}class ym{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new jr(zr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new jr(zr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return rs(this._lat,t._lat)||rs(this._long,t._long)}}const wm=/^__.*__$/;class vm{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Qa(t,this.data,this.fieldMask,e,this.fieldTransforms):new $a(t,this.data,e,this.fieldTransforms)}}class Im{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Qa(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function bm(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Br()}}class Em{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Jc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Yc(){return this.settings.Yc}Zc(t){return new Em(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Xc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Zc({path:n,ta:!1});return r.ea(t),r}na(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Zc({path:n,ta:!1});return r.Jc(),r}sa(t){return this.Zc({path:void 0,ta:!0})}ia(t){return Gm(t,this.settings.methodName,this.settings.ra||!1,this.path,this.settings.oa)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Jc(){if(this.path)for(let t=0;t<this.path.length;t++)this.ea(this.path.get(t))}ea(t){if(0===t.length)throw this.ia("Document fields must not be empty");if(bm(this.Yc)&&wm.test(t))throw this.ia('Document fields cannot begin and end with "__"')}}class Tm{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||Eh(t)}ua(t,e,n,r=!1){return new Em({Yc:t,methodName:e,oa:n,path:hs.emptyPath(),ta:!1,ra:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Sm(t){const e=t._freezeSettings(),n=Eh(t._databaseId);return new Tm(t._databaseId,!!e.ignoreUndefinedProperties,n)}function _m(t,e,n,r,s,i={}){const o=t.ua(i.merge||i.mergeFields?2:0,e,n,s);Vm("Data must be an object, but it was:",o,r);const a=Fm(r,o);let c,u;if(i.merge)c=new xi(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Bm(e,r,n);if(!o.contains(s))throw new jr(zr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);zm(t,s)||t.push(s)}c=new xi(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new vm(new ao(a),c,u)}class Dm extends pm{_toFieldTransform(t){if(2!==t.Yc)throw 1===t.Yc?t.ia(`${this._methodName}() can only appear at the top level of your update data`):t.ia(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Dm}}function xm(t,e,n){return new Em({Yc:3,oa:e.settings.oa,methodName:t._methodName,ta:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Am extends pm{_toFieldTransform(t){return new Fa(t.path,new Aa)}isEqual(t){return t instanceof Am}}class Cm extends pm{constructor(t,e){super(t),this.ca=e}_toFieldTransform(t){const e=xm(this,t,!0),n=this.ca.map((t=>Om(t,e))),r=new Ca(n);return new Fa(t.path,r)}isEqual(t){return this===t}}class Nm extends pm{constructor(t,e){super(t),this.ca=e}_toFieldTransform(t){const e=xm(this,t,!0),n=this.ca.map((t=>Om(t,e))),r=new ka(n);return new Fa(t.path,r)}isEqual(t){return this===t}}class km extends pm{constructor(t,e){super(t),this.aa=e}_toFieldTransform(t){const e=new Ma(t.serializer,Ta(t.serializer,this.aa));return new Fa(t.path,e)}isEqual(t){return this===t}}function Rm(t,e,n,r){const s=t.ua(1,e,n);Vm("Data must be an object, but it was:",s,r);const i=[],o=ao.empty();vi(r,((t,r)=>{const a=Um(e,t,n);r=b(r);const c=s.na(a);if(r instanceof Dm)i.push(a);else{const t=Om(r,c);null!=t&&(i.push(a),o.set(a,t))}}));const a=new xi(i);return new Im(o,a,s.fieldTransforms)}function Mm(t,e,n,r,s,i){const o=t.ua(1,e,n),a=[Bm(e,r,n)],c=[s];if(i.length%2!=0)throw new jr(zr.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(Bm(e,i[t])),c.push(i[t+1]);const u=[],l=ao.empty();for(let t=a.length-1;t>=0;--t)if(!zm(u,a[t])){const e=a[t];let n=c[t];n=b(n);const r=o.na(e);if(n instanceof Dm)u.push(e);else{const t=Om(n,r);null!=t&&(u.push(e),l.set(e,t))}}const h=new xi(u);return new Im(l,h,o.fieldTransforms)}function Lm(t,e,n,r=!1){return Om(n,t.ua(r?4:3,e))}function Om(t,e){if(Pm(t=b(t)))return Vm("Unsupported field value:",e,t),Fm(t,e);if(t instanceof pm)return function(t,e){if(!bm(e.Yc))throw e.ia(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.ia(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.ta&&4!==e.Yc)throw e.ia("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Om(s,e.sa(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=b(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Ta(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=os.fromDate(t);return{timestampValue:_c(e.serializer,n)}}if(t instanceof os){const n=new os(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:_c(e.serializer,n)}}if(t instanceof ym)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof fm)return{bytesValue:Dc(e.serializer,t._byteString)};if(t instanceof Pf){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.ia(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Cc(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.ia(`Unsupported field value: ${kf(t)}`)}(t,e)}function Fm(t,e){const n={};return Ii(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):vi(t,((t,r)=>{const s=Om(r,e.Xc(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function Pm(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof os||t instanceof ym||t instanceof fm||t instanceof Pf||t instanceof pm)}function Vm(t,e,n){if(!Pm(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=kf(n);throw"an object"===r?e.ia(t+" a custom object"):e.ia(t+" "+r)}}function Bm(t,e,n){if((e=b(e))instanceof mm)return e._internalPath;if("string"==typeof e)return Um(t,e);throw Gm("Field path arguments must be of type string or ",t,!1,void 0,n)}const qm=new RegExp("[~\\*/\\[\\]]");function Um(t,e,n){if(e.search(qm)>=0)throw Gm(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new mm(...e.split("."))._internalPath}catch(r){throw Gm(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Gm(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new jr(zr.INVALID_ARGUMENT,a+t+c)}function zm(t,e){return t.some((t=>t.isEqual(e)))}class jm{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Pf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Km(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field($m("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Km extends jm{data(){return super.data()}}function $m(t,e){return"string"==typeof e?Um(t,e):e instanceof mm?e._internalPath:e._delegate._internalPath}function Qm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new jr(zr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Hm{}class Wm extends Hm{}function Ym(t,e,...n){let r=[];e instanceof Hm&&r.push(e),r=r.concat(n),function(t){const e=t.filter((t=>t instanceof Zm)).length,n=t.filter((t=>t instanceof Xm)).length;if(e>1||e>0&&n>0)throw new jr(zr.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const e of r)t=e._apply(t);return t}class Xm extends Wm{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new Xm(t,e,n)}_apply(t){const e=this._parse(t);return pg(t._query,e),new Vf(t.firestore,t.converter,Jo(t._query,e))}_parse(t){const e=Sm(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new jr(zr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){gg(o,i);const e=[];for(const n of o)e.push(mg(r,t,n));a={arrayValue:{values:e}}}else a=mg(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||gg(o,i),a=Lm(n,"where",o,"in"===i||"not-in"===i);return yo.create(s,i,a)}(t._query,0,e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function Jm(t,e,n){const r=e,s=$m("where",t);return Xm._create(s,r,n)}class Zm extends Hm{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new Zm(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:wo.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const t of r)pg(n,t),n=Jo(n,t)}(t._query,e),new Vf(t.firestore,t.converter,Jo(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function tg(...t){return t.forEach((t=>wg("or",t))),Zm._create("or",t)}function eg(...t){return t.forEach((t=>wg("and",t))),Zm._create("and",t)}class ng extends Wm{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new ng(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new jr(zr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new jr(zr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new mo(e,n);return function(t,e){if(null===Qo(t)){const n=Ho(t);null!==n&&yg(t,n,e.field)}}(t,r),r}(t._query,this._field,this._direction);return new Vf(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new zo(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function rg(t,e="asc"){const n=e,r=$m("orderBy",t);return ng._create(r,n)}class sg extends Wm{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new sg(t,e,n)}_apply(t){return new Vf(t.firestore,t.converter,Zo(t._query,this._limit,this._limitType))}}function ig(t){return Mf("limit",t),sg._create("limit",t,"F")}function og(t){return Mf("limitToLast",t),sg._create("limitToLast",t,"L")}class ag extends Wm{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new ag(t,e,n)}_apply(t){const e=fg(t,this.type,this._docOrFields,this._inclusive);return new Vf(t.firestore,t.converter,function(t,e){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function cg(...t){return ag._create("startAt",t,!0)}function ug(...t){return ag._create("startAfter",t,!1)}class lg extends Wm{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new lg(t,e,n)}_apply(t){const e=fg(t,this.type,this._docOrFields,this._inclusive);return new Vf(t.firestore,t.converter,function(t,e){return new zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function hg(...t){return lg._create("endBefore",t,!1)}function dg(...t){return lg._create("endAt",t,!0)}function fg(t,e,n,r){if(n[0]=b(n[0]),n[0]instanceof jm)return function(t,e,n,r,s){if(!r)throw new jr(zr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Yo(t))if(n.field.isKeyField())i.push(Wi(e,r.key));else{const t=r.data.field(n.field);if(Oi(t))throw new jr(zr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new jr(zr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new lo(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=Sm(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new jr(zr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const c=s[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new jr(zr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!Wo(t)&&-1!==c.indexOf("/"))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(us.fromString(c));if(!ds.isDocumentKey(n))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new ds(n);a.push(Wi(e,s))}else{const t=Lm(n,r,c);a.push(t)}}return new lo(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function mg(t,e,n){if("string"==typeof(n=b(n))){if(""===n)throw new jr(zr.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Wo(e)&&-1!==n.indexOf("/"))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(us.fromString(n));if(!ds.isDocumentKey(r))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Wi(t,new ds(r))}if(n instanceof Pf)return Wi(t,n._key);throw new jr(zr.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${kf(n)}.`)}function gg(t,e){if(!Array.isArray(t)||0===t.length)throw new jr(zr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function pg(t,e){if(e.isInequality()){const n=Ho(t),r=e.field;if(null!==n&&!n.isEqual(r))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const s=Qo(t);null!==s&&yg(t,r,s)}const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new jr(zr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new jr(zr.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function yg(t,e,n){if(!n.isEqual(e))throw new jr(zr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}function wg(t,e){if(!(e instanceof Xm||e instanceof Zm))throw new jr(zr.INVALID_ARGUMENT,`Function ${t}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class vg{convertValue(t,e="none"){switch(Gi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Mi(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Li(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Br()}}convertObject(t,e){const n={};return vi(t.fields,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new ym(Mi(t.latitude),Mi(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Fi(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Pi(t));default:return null}}convertTimestamp(t){const e=Ri(t);return new os(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=us.fromString(t);qr(Jc(n));const r=new Bi(n.get(1),n.get(3)),s=new ds(n.popFirst(5));return r.isEqual(e)||Fr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function Ig(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class bg extends vg{constructor(t){super(),this.firestore=t}convertBytes(t){return new fm(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Pf(this.firestore,null,e)}}function Eg(t){return new hm("sum",Bm("sum",t))}function Tg(t){return new hm("avg",Bm("average",t))}function Sg(){return new hm("count")}function _g(t,e){var n,r;return t instanceof hm&&e instanceof hm&&t._aggregateType===e._aggregateType&&(null===(n=t._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=e._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function Dg(t,e){return jf(t.query,e.query)&&v(t.data(),e.data())}class xg{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Ag extends jm{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Cg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field($m("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Cg extends Ag{data(t={}){return super.data(t)}}class Ng{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new xg(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Cg(this._firestore,this._userDataWriter,n.key,n,new xg(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new jr(zr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new Cg(t._firestore,t._userDataWriter,n.doc.key,n.doc,new xg(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new Cg(t._firestore,t._userDataWriter,e.doc.key,e.doc,new xg(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:kg(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function kg(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Br()}}function Rg(t,e){return t instanceof Ag&&e instanceof Ag?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Ng&&e instanceof Ng&&t._firestore===e._firestore&&jf(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Mg(t){t=Rf(t,Pf);const e=Rf(t.firestore,Wf);return Tf(Jf(e),t._key).then((n=>Qg(e,t,n)))}class Lg extends vg{constructor(t){super(),this.firestore=t}convertBytes(t){return new fm(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Pf(this.firestore,null,e)}}function Og(t){t=Rf(t,Pf);const e=Rf(t.firestore,Wf),n=Jf(e),r=new Lg(e);return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=Gr(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new jr(zr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=id(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await wf(t),e,n))),n.promise}(n,t._key).then((n=>new Ag(e,r,t._key,n,new xg(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Fg(t){t=Rf(t,Pf);const e=Rf(t.firestore,Wf);return Tf(Jf(e),t._key,{source:"server"}).then((n=>Qg(e,t,n)))}function Pg(t){t=Rf(t,Vf);const e=Rf(t.firestore,Wf),n=Jf(e),r=new Lg(e);return Qm(t._query),Sf(n,t._query).then((n=>new Ng(e,r,t,n)))}function Vg(t){t=Rf(t,Vf);const e=Rf(t.firestore,Wf),n=Jf(e),r=new Lg(e);return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await Xl(t,e,!0),s=new Td(e,r.Wi),i=s.zu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=id(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await wf(t),e,n))),n.promise}(n,t._query).then((n=>new Ng(e,r,t,n)))}function Bg(t){t=Rf(t,Vf);const e=Rf(t.firestore,Wf),n=Jf(e),r=new Lg(e);return Sf(n,t._query,{source:"server"}).then((n=>new Ng(e,r,t,n)))}function qg(t,e,n){t=Rf(t,Pf);const r=Rf(t.firestore,Wf),s=Ig(t.converter,e,n);return $g(r,[_m(Sm(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Va.none())])}function Ug(t,e,n,...r){t=Rf(t,Pf);const s=Rf(t.firestore,Wf),i=Sm(s);let o;return o="string"==typeof(e=b(e))||e instanceof mm?Mm(i,"updateDoc",t._key,e,n,r):Rm(i,"updateDoc",t._key,e),$g(s,[o.toMutation(t._key,Va.exists(!0))])}function Gg(t){return $g(Rf(t.firestore,Wf),[new Xa(t._key,Va.none())])}function zg(t,e){const n=Rf(t.firestore,Wf),r=Gf(t),s=Ig(t.converter,e);return $g(n,[_m(Sm(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Va.exists(!1))]).then((()=>r))}function jg(t,...e){var n,r,s;t=b(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||$f(e[o])||(i=e[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if($f(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let c,u,l;if(t instanceof Pf)u=Rf(t.firestore,Wf),l=Ko(t._key.path),c={next:n=>{e[o]&&e[o](Qg(u,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Rf(t,Vf);u=Rf(n.firestore,Wf),l=n._query;const r=new Lg(u);c={next:t=>{e[o]&&e[o](new Ng(u,r,n,t))},error:e[o+1],complete:e[o+2]},Qm(t._query)}return function(t,e,n,r){const s=new af(r),i=new pd(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>hd(await Ef(t),i))),()=>{s.yc(),t.asyncQueue.enqueueAndForget((async()=>dd(await Ef(t),i)))}}(Jf(u),l,a,c)}function Kg(t,e){return function(t,e){const n=new af(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Gr(t).Au.add(e),e.next()}(await Ef(t),n))),()=>{n.yc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Gr(t).Au.delete(e)}(await Ef(t),n)))}}(Jf(t=Rf(t,Wf)),$f(e)?e:{next:e})}function $g(t,e){return function(t,e){const n=new Kr;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=tf(t);try{const t=await function(t,e){const n=Gr(t),r=os.now(),s=e.reduce(((t,e)=>t.add(e.key)),wa());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=ua(),c=wa();return n.Ki.getEntries(t,s).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(c=c.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((s=>{i=s;const o=[];for(const t of e){const e=ja(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Qa(t.key,e,co(e.value.mapValue),Va.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:da(i)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.ac[t.currentUser.toKey()];r||(r=new bi(rs)),r=r.insert(e,n),t.ac[t.currentUser.toKey()]=r}(r,t.batchId,n),await Gd(r,t.changes),await Kh(r.remoteStore)}catch(t){const e=id(t,"Failed to persist write");n.reject(e)}}(await If(t),e,n))),n.promise}(Jf(t),e)}function Qg(t,e,n){const r=n.docs.get(e._key),s=new Lg(t);return new Ag(t,s,e._key,r,new xg(n.hasPendingWrites,n.fromCache),e.converter)}function Hg(t){return Wg(t,{count:Sg()})}function Wg(t,e){const n=Rf(t.firestore,Wf),r=Jf(n),s=function(t,e){const n=[];for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(e(t[r],r));return n}(e,((t,e)=>new sc(new rc(e),t._aggregateType,t._internalFieldPath)));return function(t,e,n){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>{try{if(Vh(await vf(t))){const s=await bf(t);r.resolve(async function(t,e,n){const r=Gr(t),s=function(t,e,n){const r=Gc(t,e),s=[];return n.forEach((t=>{"count"===t.yt?s.push({alias:t.alias.canonicalString(),count:{}}):"avg"===t.yt?s.push({alias:t.alias.canonicalString(),avg:{field:Hc(t.fieldPath)}}):"sum"===t.yt&&s.push({alias:t.alias.canonicalString(),sum:{field:Hc(t.fieldPath)}})})),{structuredAggregationQuery:{aggregations:s,structuredQuery:r.structuredQuery},parent:r.parent}}(r.serializer,Xo(e),n),i=s.parent;r.connection.uo||delete s.parent;const o=(await r.fo("RunAggregationQuery",i,s,1)).filter((t=>!!t.result));return qr(1===o.length),(a=o[0]).result,a.result.aggregateFields,new ao({mapValue:{fields:null===(c=a.result)||void 0===c?void 0:c.aggregateFields}});var a,c}(s,e,n))}else r.reject(new jr(zr.UNAVAILABLE,"Failed to get aggregate result because the client is offline."))}catch(t){r.reject(t)}})),r.promise}(r,t._query,s).then((e=>function(t,e,n){const r=new Lg(t);return new dm(e,r,n)}(n,t,e)))}class Yg{constructor(){this.kind="memory",this._onlineComponentProvider=new sf,this._offlineComponentProvider=new ef}toJSON(){return{kind:this.kind}}}class Xg{constructor(t){let e;this.kind="persistent",(null==t?void 0:t.tabManager)?(t.tabManager._initialize(t),e=t.tabManager):(e=np(void 0),e._initialize(t)),this._onlineComponentProvider=e._onlineComponentProvider,this._offlineComponentProvider=e._offlineComponentProvider}toJSON(){return{kind:this.kind}}}function Jg(){return new Yg}function Zg(t){return new Xg(t)}class tp{constructor(t){this.forceOwnership=t,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new sf,this._offlineComponentProvider=new nf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes,this.forceOwnership)}}class ep{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new sf,this._offlineComponentProvider=new rf(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes)}}function np(t){return new tp(null==t?void 0:t.forceOwnership)}function rp(){return new ep}const sp={maxAttempts:5};class ip{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Sm(t)}set(t,e,n){this._verifyNotCommitted();const r=op(t,this._firestore),s=Ig(r.converter,e,n),i=_m(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Va.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=op(t,this._firestore);let i;return i="string"==typeof(e=b(e))||e instanceof mm?Mm(this._dataReader,"WriteBatch.update",s._key,e,n,r):Rm(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,Va.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=op(t,this._firestore);return this._mutations=this._mutations.concat(new Xa(e._key,Va.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new jr(zr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function op(t,e){if((t=b(t)).firestore!==e)throw new jr(zr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class ap extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Sm(t)}get(t){const e=op(t,this._firestore),n=new bg(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Br();const r=t[0];if(r.isFoundDocument())return new jm(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new jm(this._firestore,n,e._key,null,e.converter);throw Br()}))}set(t,e,n){const r=op(t,this._firestore),s=Ig(r.converter,e,n),i=_m(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=op(t,this._firestore);let i;return i="string"==typeof(e=b(e))||e instanceof mm?Mm(this._dataReader,"Transaction.update",s._key,e,n,r):Rm(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=op(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=op(t,this._firestore),n=new Lg(this._firestore);return super.get(t).then((t=>new Ag(this._firestore,n,e._key,t._document,new xg(!1,!1),e.converter)))}}function cp(t,e,n){t=Rf(t,Wf);const r=Object.assign(Object.assign({},sp),n);return function(t){if(t.maxAttempts<1)throw new jr(zr.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new Kr;return t.asyncQueue.enqueueAndForget((async()=>{const s=await bf(t);new lf(t.asyncQueue,s,n,e,r).run()})),r.promise}(Jf(t),(n=>e(new ap(t,n))),r)}function up(){return new Dm("deleteField")}function lp(){return new Am("serverTimestamp")}function hp(...t){return new Cm("arrayUnion",t)}function dp(...t){return new Nm("arrayRemove",t)}function fp(t){return new km("increment",t)}function mp(t){return Jf(t=Rf(t,Wf)),new ip(t,(e=>$g(t,e)))}function gp(t,e){var n;const r=Jf(t=Rf(t,Wf));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return Pr("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(t){const e="string"==typeof t?function(t){try{return JSON.parse(t)}catch(t){throw new jr(zr.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==t?void 0:t.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=pp(t,"collectionGroup"),r=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=Um("setIndexConfiguration",pp(e,"fieldPath"));"CONTAINS"===e.arrayConfig?r.push(new ys(t,2)):"ASCENDING"===e.order?r.push(new ys(t,0)):"DESCENDING"===e.order&&r.push(new ys(t,1))}n.push(new fs(fs.UNKNOWN_ID,e,r,vs.empty()))}return n}(e);return function(t,e){return t.asyncQueue.enqueue((async()=>async function(t,e){const n=Gr(t),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>r.getFieldIndexes(t).next((n=>function(t,e,n,r,s){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,c=0;for(;a<o&&c<i;){const i=n(t[c],e[a]);i<0?s(t[c++]):i>0?r(e[a++]):(a++,c++)}for(;a<o;)r(e[a++]);for(;c<i;)s(t[c++])}(n,e,ps,(e=>{s.push(r.addFieldIndex(t,e))}),(e=>{s.push(r.deleteFieldIndex(t,e))})))).next((()=>xs.waitFor(s)))))}(await wf(t),e)))}(r,s)}function pp(t,e){if("string"!=typeof t[e])throw new jr(zr.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(n,r=!0){kr=i,t(new E("firestore",((t,{instanceIdentifier:e,options:n})=>{const s=t.getProvider("app").getImmediate(),i=new Wf(new Wr(t.getProvider("auth-internal")),new Zr(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new jr(zr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Bi(t.options.projectId,e)}(s,e),s);return n=Object.assign({useFetchStreams:r},n),i._setSettings(n),i}),"PUBLIC").setMultipleInstances(!0)),e(Cr,"3.10.0",n),e(Cr,"3.10.0","esm2017")}();export{vg as AbstractUserDataWriter,hm as AggregateField,dm as AggregateQuerySnapshot,fm as Bytes,Hf as CACHE_SIZE_UNLIMITED,Bf as CollectionReference,Pf as DocumentReference,Ag as DocumentSnapshot,mm as FieldPath,pm as FieldValue,Wf as Firestore,jr as FirestoreError,ym as GeoPoint,Qf as LoadBundleTask,Vf as Query,Zm as QueryCompositeFilterConstraint,Wm as QueryConstraint,Cg as QueryDocumentSnapshot,lg as QueryEndAtConstraint,Xm as QueryFieldFilterConstraint,sg as QueryLimitConstraint,ng as QueryOrderByConstraint,Ng as QuerySnapshot,ag as QueryStartAtConstraint,xg as SnapshotMetadata,os as Timestamp,ap as Transaction,ip as WriteBatch,Bi as _DatabaseId,ds as _DocumentKey,ts as _EmptyAppCheckTokenProvider,Qr as _EmptyAuthCredentialsProvider,hs as _FieldPath,lc as _TestingHooks,Rf as _cast,Ur as _debugAssert,Ci as _isBase64Available,Pr as _logWarn,Af as _validateIsNotUsedTogether,zg as addDoc,_g as aggregateFieldEqual,Dg as aggregateQuerySnapshotEqual,eg as and,dp as arrayRemove,hp as arrayUnion,Tg as average,rm as clearIndexedDbPersistence,qf as collection,Uf as collectionGroup,Ff as connectFirestoreEmulator,Sg as count,Gg as deleteDoc,up as deleteField,om as disableNetwork,Gf as doc,gm as documentId,tm as enableIndexedDbPersistence,em as enableMultiTabIndexedDbPersistence,im as enableNetwork,dg as endAt,hg as endBefore,Jf as ensureFirestoreConfigured,$g as executeWrite,Wg as getAggregateFromServer,Hg as getCountFromServer,Mg as getDoc,Og as getDocFromCache,Fg as getDocFromServer,Pg as getDocs,Vg as getDocsFromCache,Bg as getDocsFromServer,Xf as getFirestore,fp as increment,Yf as initializeFirestore,ig as limit,og as limitToLast,cm as loadBundle,Jg as memoryLocalCache,um as namedQuery,jg as onSnapshot,Kg as onSnapshotsInSync,tg as or,rg as orderBy,Zg as persistentLocalCache,rp as persistentMultipleTabManager,np as persistentSingleTabManager,Ym as query,jf as queryEqual,zf as refEqual,cp as runTransaction,lp as serverTimestamp,qg as setDoc,gp as setIndexConfiguration,Lr as setLogLevel,Rg as snapshotEqual,ug as startAfter,cg as startAt,Eg as sum,am as terminate,Ug as updateDoc,sm as waitForPendingWrites,Jm as where,mp as writeBatch};

//# sourceMappingURL=firebase-firestore.js.map
